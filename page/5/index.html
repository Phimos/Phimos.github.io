<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
<link href="https://cdn.bootcss.com/KaTeX/0.7.1/katex.min.css" rel="stylesheet">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('http://phimos.github.io').hostname,
    root: '/',
    scheme: 'Muse',
    version: '7.6.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Pims的博客">
<meta property="og:url" content="http://phimos.github.io/page/5/index.html">
<meta property="og:site_name" content="Pims的博客">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Pims">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://phimos.github.io/page/5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false
  };
</script>

  <title>Pims的博客</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Pims的博客" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Pims的博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://phimos.github.io/2020/03/30/6828-lab3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Pims">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pims的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/30/6828-lab3/" class="post-title-link" itemprop="url">MIT6.828 Lab3</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-30 04:55:35" itemprop="dateCreated datePublished" datetime="2020-03-30T04:55:35+08:00">2020-03-30</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="exercise-1"><a class="markdownIt-Anchor" href="#exercise-1"></a> Exercise 1</h2>
<p>如同Exercise描述中所说的，类似pages分配的方法一样利用<code>boot_alloc()</code>就好，由于后面有<code>env_init()</code>函数负责结构体的初始化，这个地方不需要进行初始化的操作。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Make &#x27;envs&#x27; point to an array of size &#x27;NENV&#x27; of &#x27;struct Env&#x27;.</span></span><br><span class="line"><span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">envs = (<span class="keyword">struct</span> Env *) boot_alloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> Env) * NENV);</span><br></pre></td></tr></table></figure>
<p>同时采用相似的方法将其map到UENVS处：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Map the &#x27;envs&#x27; array read-only by the user at linear address UENVS</span></span><br><span class="line"><span class="comment">// (ie. perm = PTE_U | PTE_P).</span></span><br><span class="line"><span class="comment">// Permissions:</span></span><br><span class="line"><span class="comment">//    - the new image at UENVS  -- kernel R, user R</span></span><br><span class="line"><span class="comment">//    - envs itself -- kernel RW, user NONE</span></span><br><span class="line"><span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">n = ROUNDUP(NENV*<span class="keyword">sizeof</span>(<span class="keyword">struct</span> Env), PGSIZE);</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i+=PGSIZE)</span><br><span class="line">	page_insert(kern_pgdir, pa2page(PADDR(envs) + i), (<span class="type">void</span> *)(UENVS + i), PTE_U | PTE_P);</span><br></pre></td></tr></table></figure>
<h2 id="exericse-2"><a class="markdownIt-Anchor" href="#exericse-2"></a> Exericse 2</h2>
<h3 id="env_init"><a class="markdownIt-Anchor" href="#env_init"></a> env_init()</h3>
<p>这里的操作实际上就是进行一个envs的初始化，最开始所有的都是空闲状态，将其插入env_free_list就可以了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Mark all environments in &#x27;envs&#x27; as free, set their env_ids to 0,</span></span><br><span class="line"><span class="comment">// and insert them into the env_free_list.</span></span><br><span class="line"><span class="comment">// Make sure the environments are in the free list in the same order</span></span><br><span class="line"><span class="comment">// they are in the envs array (i.e., so that the first call to</span></span><br><span class="line"><span class="comment">// env_alloc() returns envs[0]).</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">env_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// Set up envs array</span></span><br><span class="line">	<span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">	<span class="built_in">memset</span>(envs, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> Env) * NENV);</span><br><span class="line">	</span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line">	env_free_list = envs;</span><br><span class="line">	<span class="keyword">for</span>(i = <span class="number">1</span>; i &lt; NENV; ++i)</span><br><span class="line">		envs[i<span class="number">-1</span>].env_link = envs + i;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Per-CPU part of the initialization</span></span><br><span class="line">	env_init_percpu();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="env_setup_vm"><a class="markdownIt-Anchor" href="#env_setup_vm"></a> env_setup_vm()</h3>
<p>这里可以知道，在UTOP下面应当是空白的，在UTOP上面都是相同的，所以首先对整个page进行清空，之后利用memcpy以kern_pgdir为模板，只需要进行page table的修改就可以了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Initialize the kernel virtual memory layout for environment e.</span></span><br><span class="line"><span class="comment">// Allocate a page directory, set e-&gt;env_pgdir accordingly,</span></span><br><span class="line"><span class="comment">// and initialize the kernel portion of the new environment&#x27;s address space.</span></span><br><span class="line"><span class="comment">// Do NOT (yet) map anything into the user portion</span></span><br><span class="line"><span class="comment">// of the environment&#x27;s virtual address space.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Returns 0 on success, &lt; 0 on error.  Errors include:</span></span><br><span class="line"><span class="comment">//	-E_NO_MEM if page directory or table could not be allocated.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">env_setup_vm</span><span class="params">(<span class="keyword">struct</span> Env *e)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> i;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">PageInfo</span> *<span class="title">p</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Allocate a page for the page directory</span></span><br><span class="line">	<span class="keyword">if</span> (!(p = page_alloc(ALLOC_ZERO)))</span><br><span class="line">		<span class="keyword">return</span> -E_NO_MEM;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Now, set e-&gt;env_pgdir and initialize the page directory.</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// Hint:</span></span><br><span class="line">	<span class="comment">//    - The VA space of all envs is identical above UTOP</span></span><br><span class="line">	<span class="comment">//	(except at UVPT, which we&#x27;ve set below).</span></span><br><span class="line">	<span class="comment">//	See inc/memlayout.h for permissions and layout.</span></span><br><span class="line">	<span class="comment">//	Can you use kern_pgdir as a template?  Hint: Yes.</span></span><br><span class="line">	<span class="comment">//	(Make sure you got the permissions right in Lab 2.)</span></span><br><span class="line">	<span class="comment">//    - The initial VA below UTOP is empty.</span></span><br><span class="line">	<span class="comment">//    - You do not need to make any more calls to page_alloc.</span></span><br><span class="line">	<span class="comment">//    - Note: In general, pp_ref is not maintained for</span></span><br><span class="line">	<span class="comment">//	physical pages mapped only above UTOP, but env_pgdir</span></span><br><span class="line">	<span class="comment">//	is an exception -- you need to increment env_pgdir&#x27;s</span></span><br><span class="line">	<span class="comment">//	pp_ref for env_free to work correctly.</span></span><br><span class="line">	<span class="comment">//    - The functions in kern/pmap.h are handy.</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">	e-&gt;env_pgdir = page2kva(p);</span><br><span class="line">	++(p-&gt;pp_ref);</span><br><span class="line">	<span class="built_in">memset</span>(e-&gt;env_pgdir, <span class="number">0</span>, PGSIZE);</span><br><span class="line">	<span class="built_in">memcpy</span>(e-&gt;env_pgdir + PDX(UTOP), kern_pgdir + PDX(UTOP), PGSIZE - (PDX(UTOP)&lt;&lt;<span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">	<span class="comment">// UVPT maps the env&#x27;s own page table read-only.</span></span><br><span class="line">	<span class="comment">// Permissions: kernel R, user R</span></span><br><span class="line">	e-&gt;env_pgdir[PDX(UVPT)] = PADDR(e-&gt;env_pgdir) | PTE_P | PTE_U;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="region_alloc"><a class="markdownIt-Anchor" href="#region_alloc"></a> region_alloc()</h3>
<p>这里可以仿照在pmap.c中多次实现的alloc操作，只不过这里的page是利用page_alloc()得到的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Allocate len bytes of physical memory for environment env,</span></span><br><span class="line"><span class="comment">// and map it at virtual address va in the environment&#x27;s address space.</span></span><br><span class="line"><span class="comment">// Does not zero or otherwise initialize the mapped pages in any way.</span></span><br><span class="line"><span class="comment">// Pages should be writable by user and kernel.</span></span><br><span class="line"><span class="comment">// Panic if any allocation attempt fails.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">region_alloc</span><span class="params">(<span class="keyword">struct</span> Env *e, <span class="type">void</span> *va, <span class="type">size_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">	<span class="comment">// (But only if you need it for load_icode.)</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// Hint: It is easier to use region_alloc if the caller can pass</span></span><br><span class="line">	<span class="comment">//   &#x27;va&#x27; and &#x27;len&#x27; values that are not page-aligned.</span></span><br><span class="line">	<span class="comment">//   You should round va down, and round (va + len) up.</span></span><br><span class="line">	<span class="comment">//   (Watch out for corner-cases!)</span></span><br><span class="line">	<span class="type">void</span> *start_va = ROUNDDOWN(va, PGSIZE);</span><br><span class="line">	<span class="type">void</span> *end_va = ROUNDUP(va + len, PGSIZE);</span><br><span class="line">	<span class="type">void</span> *cur_va;</span><br><span class="line">	<span class="keyword">for</span>(cur_va = start_va; cur_va &lt; end_va; cur_va += PGSIZE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">PageInfo</span> * <span class="title">pp</span> =</span> page_alloc(<span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span>(!pp)</span><br><span class="line">			panic(<span class="string">&quot;region_alloc: Out of memory!\n&quot;</span>);</span><br><span class="line">		page_insert(e-&gt;env_pgdir, pp, (<span class="type">void</span> *)cur_va, PTE_U | PTE_W);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="load_icode"><a class="markdownIt-Anchor" href="#load_icode"></a> load_icode()</h3>
<p>先看看<code>bootmain()</code>当中是怎么操作的：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">bootmain</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Proghdr</span> *<span class="title">ph</span>, *<span class="title">eph</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// read 1st page off disk</span></span><br><span class="line">	readseg((<span class="type">uint32_t</span>) ELFHDR, SECTSIZE*<span class="number">8</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// is this a valid ELF?</span></span><br><span class="line">	<span class="keyword">if</span> (ELFHDR-&gt;e_magic != ELF_MAGIC)</span><br><span class="line">		<span class="keyword">goto</span> bad;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// load each program segment (ignores ph flags)</span></span><br><span class="line">	ph = (<span class="keyword">struct</span> Proghdr *) ((<span class="type">uint8_t</span> *) ELFHDR + ELFHDR-&gt;e_phoff);</span><br><span class="line">	eph = ph + ELFHDR-&gt;e_phnum;</span><br><span class="line">	<span class="keyword">for</span> (; ph &lt; eph; ph++)</span><br><span class="line">		<span class="comment">// p_pa is the load address of this segment (as well</span></span><br><span class="line">		<span class="comment">// as the physical address)</span></span><br><span class="line">		readseg(ph-&gt;p_pa, ph-&gt;p_memsz, ph-&gt;p_offset);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// call the entry point from the ELF header</span></span><br><span class="line">	<span class="comment">// note: does not return!</span></span><br><span class="line">	((<span class="type">void</span> (*)(<span class="type">void</span>)) (ELFHDR-&gt;e_entry))();</span><br><span class="line"></span><br><span class="line">bad:</span><br><span class="line">	outw(<span class="number">0x8A00</span>, <span class="number">0x8A00</span>);</span><br><span class="line">	outw(<span class="number">0x8A00</span>, <span class="number">0x8E00</span>);</span><br><span class="line">	<span class="keyword">while</span> (<span class="number">1</span>)</span><br><span class="line">		<span class="comment">/* do nothing */</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>仿照第13-19行进行下面的code：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Set up the initial program binary, stack, and processor flags</span></span><br><span class="line"><span class="comment">// for a user process.</span></span><br><span class="line"><span class="comment">// This function is ONLY called during kernel initialization,</span></span><br><span class="line"><span class="comment">// before running the first user-mode environment.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This function loads all loadable segments from the ELF binary image</span></span><br><span class="line"><span class="comment">// into the environment&#x27;s user memory, starting at the appropriate</span></span><br><span class="line"><span class="comment">// virtual addresses indicated in the ELF program header.</span></span><br><span class="line"><span class="comment">// At the same time it clears to zero any portions of these segments</span></span><br><span class="line"><span class="comment">// that are marked in the program header as being mapped</span></span><br><span class="line"><span class="comment">// but not actually present in the ELF file - i.e., the program&#x27;s bss section.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// All this is very similar to what our boot loader does, except the boot</span></span><br><span class="line"><span class="comment">// loader also needs to read the code from disk.  Take a look at</span></span><br><span class="line"><span class="comment">// boot/main.c to get ideas.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Finally, this function maps one page for the program&#x27;s initial stack.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// load_icode panics if it encounters problems.</span></span><br><span class="line"><span class="comment">//  - How might load_icode fail?  What might be wrong with the given input?</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">load_icode</span><span class="params">(<span class="keyword">struct</span> Env *e, <span class="type">uint8_t</span> *binary)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// Hints:</span></span><br><span class="line">	<span class="comment">//  Load each program segment into virtual memory</span></span><br><span class="line">	<span class="comment">//  at the address specified in the ELF segment header.</span></span><br><span class="line">	<span class="comment">//  You should only load segments with ph-&gt;p_type == ELF_PROG_LOAD.</span></span><br><span class="line">	<span class="comment">//  Each segment&#x27;s virtual address can be found in ph-&gt;p_va</span></span><br><span class="line">	<span class="comment">//  and its size in memory can be found in ph-&gt;p_memsz.</span></span><br><span class="line">	<span class="comment">//  The ph-&gt;p_filesz bytes from the ELF binary, starting at</span></span><br><span class="line">	<span class="comment">//  &#x27;binary + ph-&gt;p_offset&#x27;, should be copied to virtual address</span></span><br><span class="line">	<span class="comment">//  ph-&gt;p_va.  Any remaining memory bytes should be cleared to zero.</span></span><br><span class="line">	<span class="comment">//  (The ELF header should have ph-&gt;p_filesz &lt;= ph-&gt;p_memsz.)</span></span><br><span class="line">	<span class="comment">//  Use functions from the previous lab to allocate and map pages.</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">//  All page protection bits should be user read/write for now.</span></span><br><span class="line">	<span class="comment">//  ELF segments are not necessarily page-aligned, but you can</span></span><br><span class="line">	<span class="comment">//  assume for this function that no two segments will touch</span></span><br><span class="line">	<span class="comment">//  the same virtual page.</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">//  You may find a function like region_alloc useful.</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">//  Loading the segments is much simpler if you can move data</span></span><br><span class="line">	<span class="comment">//  directly into the virtual addresses stored in the ELF binary.</span></span><br><span class="line">	<span class="comment">//  So which page directory should be in force during</span></span><br><span class="line">	<span class="comment">//  this function?</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">//  You must also do something with the program&#x27;s entry point,</span></span><br><span class="line">	<span class="comment">//  to make sure that the environment starts executing there.</span></span><br><span class="line">	<span class="comment">//  What?  (See env_run() and env_pop_tf() below.)</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Elf</span> * <span class="title">ELFHDR</span> =</span> (<span class="keyword">struct</span> Elf *)binary;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Proghdr</span> * <span class="title">ph</span>, * <span class="title">eph</span>;</span></span><br><span class="line">	lcr3(PADDR(e-&gt;env_pgdir));</span><br><span class="line">	ph = (<span class="keyword">struct</span> Proghdr *)(binary + ELFHDR-&gt;e_phoff);</span><br><span class="line">	eph = ph + ELFHDR-&gt;e_phnum;</span><br><span class="line">	<span class="keyword">for</span>(; ph &lt; eph; ++ph)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(ph-&gt;p_type == ELF_PROG_LOAD)</span><br><span class="line">		&#123;</span><br><span class="line">			region_alloc(e, (<span class="type">void</span> *)ph-&gt;p_va, ph-&gt;p_memsz);</span><br><span class="line">			<span class="built_in">memset</span>((<span class="type">void</span> *)ph-&gt;p_va, <span class="number">0</span>, ph-&gt;p_memsz);</span><br><span class="line">			<span class="built_in">memcpy</span>((<span class="type">void</span> *)ph-&gt;p_va, binary + ph-&gt;p_offset, ph-&gt;p_filesz);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	e-&gt;env_tf.tf_eip = ELFHDR-&gt;e_entry;</span><br><span class="line"></span><br><span class="line">	lcr3(PADDR(kern_pgdir));</span><br><span class="line">	<span class="comment">// Now map one page for the program&#x27;s initial stack</span></span><br><span class="line">	<span class="comment">// at virtual address USTACKTOP - PGSIZE.</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">	region_alloc(e, (<span class="type">void</span> *)(USTACKTOP - PGSIZE), PGSIZE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="env_create"><a class="markdownIt-Anchor" href="#env_create"></a> env_create()</h3>
<p>直接调用<code>env_alloc()</code>和<code>load_icode()</code>就可以了，可以看做是在上面的一层封装：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Allocates a new env with env_alloc, loads the named elf</span></span><br><span class="line"><span class="comment">// binary into it with load_icode, and sets its env_type.</span></span><br><span class="line"><span class="comment">// This function is ONLY called during kernel initialization,</span></span><br><span class="line"><span class="comment">// before running the first user-mode environment.</span></span><br><span class="line"><span class="comment">// The new env&#x27;s parent ID is set to 0.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">env_create</span><span class="params">(<span class="type">uint8_t</span> *binary, <span class="keyword">enum</span> EnvType type)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Env</span> * <span class="title">e</span>;</span></span><br><span class="line">	<span class="keyword">if</span>(env_alloc(&amp;e, <span class="number">0</span>))</span><br><span class="line">		panic(<span class="string">&quot;env_create: env alloc failed!\n&quot;</span>);</span><br><span class="line">	load_icode(e, binary);</span><br><span class="line">	e-&gt;env_type = type;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="env_run"><a class="markdownIt-Anchor" href="#env_run"></a> env_run()</h3>
<p>要完成的是进行一个上下文的切换，这里主要做的就是首先对于env需要进行状态的改变，之后需要进行地址空间的切换。同时利用已经存在的<code>env_pop_tf()</code>函数来进行寄存器的恢复，具体的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Context switch from curenv to env e.</span></span><br><span class="line"><span class="comment">// Note: if this is the first call to env_run, curenv is NULL.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This function does not return.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">env_run</span><span class="params">(<span class="keyword">struct</span> Env *e)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// Step 1: If this is a context switch (a new environment is running):</span></span><br><span class="line">	<span class="comment">//	   1. Set the current environment (if any) back to</span></span><br><span class="line">	<span class="comment">//	      ENV_RUNNABLE if it is ENV_RUNNING (think about</span></span><br><span class="line">	<span class="comment">//	      what other states it can be in),</span></span><br><span class="line">	<span class="comment">//	   2. Set &#x27;curenv&#x27; to the new environment,</span></span><br><span class="line">	<span class="comment">//	   3. Set its status to ENV_RUNNING,</span></span><br><span class="line">	<span class="comment">//	   4. Update its &#x27;env_runs&#x27; counter,</span></span><br><span class="line">	<span class="comment">//	   5. Use lcr3() to switch to its address space.</span></span><br><span class="line">	<span class="comment">// Step 2: Use env_pop_tf() to restore the environment&#x27;s</span></span><br><span class="line">	<span class="comment">//	   registers and drop into user mode in the</span></span><br><span class="line">	<span class="comment">//	   environment.</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Hint: This function loads the new environment&#x27;s state from</span></span><br><span class="line">	<span class="comment">//	e-&gt;env_tf.  Go back through the code you wrote above</span></span><br><span class="line">	<span class="comment">//	and make sure you have set the relevant parts of</span></span><br><span class="line">	<span class="comment">//	e-&gt;env_tf to sensible values.</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// LAB 3: Your code here.</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(curenv != <span class="literal">NULL</span> &amp;&amp; curenv-&gt;env_status == ENV_RUNNING)</span><br><span class="line">		curenv-&gt;env_status = ENV_RUNNABLE;</span><br><span class="line">	curenv = e;</span><br><span class="line">	e-&gt;env_status = ENV_RUNNING;</span><br><span class="line">	++(e-&gt;env_runs);</span><br><span class="line">	lcr3(PADDR(e-&gt;env_pgdir));</span><br><span class="line"></span><br><span class="line">	env_pop_tf(&amp;(e-&gt;env_tf));</span><br><span class="line"></span><br><span class="line">	<span class="comment">//panic(&quot;env_run not yet implemented&quot;);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="gdb对hello进行断点调试"><a class="markdownIt-Anchor" href="#gdb对hello进行断点调试"></a> gdb对hello进行断点调试</h3>
<p>在obj/user/hello.asm里面可以看到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">void</span><br><span class="line">sys_cputs(const char *s, size_t len)</span><br><span class="line">&#123;</span><br><span class="line">  800a1c:	55                   	push   %ebp</span><br><span class="line">  800a1d:	89 e5                	mov    %esp,%ebp</span><br><span class="line">  800a1f:	57                   	push   %edi</span><br><span class="line">  800a20:	56                   	push   %esi</span><br><span class="line">  800a21:	53                   	push   %ebx</span><br><span class="line">	//</span><br><span class="line">	// The last clause tells the assembler that this can</span><br><span class="line">	// potentially change the condition codes and arbitrary</span><br><span class="line">	// memory locations.</span><br><span class="line"></span><br><span class="line">	asm volatile(&quot;int %1\n&quot;</span><br><span class="line">  800a22:	b8 00 00 00 00       	mov    $0x0,%eax</span><br><span class="line">  800a27:	8b 4d 0c             	mov    0xc(%ebp),%ecx</span><br><span class="line">  800a2a:	8b 55 08             	mov    0x8(%ebp),%edx</span><br><span class="line">  800a2d:	89 c3                	mov    %eax,%ebx</span><br><span class="line">  800a2f:	89 c7                	mov    %eax,%edi</span><br><span class="line">  800a31:	89 c6                	mov    %eax,%esi</span><br><span class="line">  800a33:	cd 30                	int    $0x30</span><br></pre></td></tr></table></figure>
<p>对应的地址为0x800a33，利用gdb进行断点设置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(gdb) b *0x800a33</span><br><span class="line">Breakpoint 2 at 0x800a33</span><br><span class="line">(gdb) c</span><br><span class="line">Continuing.</span><br><span class="line">=&gt; 0x800a33:	int    $0x30</span><br><span class="line"></span><br><span class="line">Breakpoint 2, 0x00800a33 in ?? ()</span><br></pre></td></tr></table></figure>
<p>发现确实执行到了这一条指令，以上的实现应该是没有问题。</p>
<h2 id="exercise-3"><a class="markdownIt-Anchor" href="#exercise-3"></a> Exercise 3</h2>
<p>内容为阅读Chapter 9，是关于Exceptions和Interrupts的内容。</p>
<h2 id="exercise-4"><a class="markdownIt-Anchor" href="#exercise-4"></a> Exercise 4</h2>
<p>从inc/trap.h当中可以发现，TrapFrame有着如下的结构：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Trapframe</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">PushRegs</span> <span class="title">tf_regs</span>;</span></span><br><span class="line">	<span class="type">uint16_t</span> tf_es;</span><br><span class="line">	<span class="type">uint16_t</span> tf_padding1;</span><br><span class="line">	<span class="type">uint16_t</span> tf_ds;</span><br><span class="line">	<span class="type">uint16_t</span> tf_padding2;</span><br><span class="line">	<span class="type">uint32_t</span> tf_trapno;</span><br><span class="line">	<span class="comment">/* below here defined by x86 hardware */</span></span><br><span class="line">	<span class="type">uint32_t</span> tf_err;</span><br><span class="line">	<span class="type">uintptr_t</span> tf_eip;</span><br><span class="line">	<span class="type">uint16_t</span> tf_cs;</span><br><span class="line">	<span class="type">uint16_t</span> tf_padding3;</span><br><span class="line">	<span class="type">uint32_t</span> tf_eflags;</span><br><span class="line">	<span class="comment">/* below here only when crossing rings, such as from user to kernel */</span></span><br><span class="line">	<span class="type">uintptr_t</span> tf_esp;</span><br><span class="line">	<span class="type">uint16_t</span> tf_ss;</span><br><span class="line">	<span class="type">uint16_t</span> tf_padding4;</span><br><span class="line">&#125; __attribute__((packed));</span><br></pre></td></tr></table></figure>
<p>可以知道对于剩下的就是要保存%es和%ds，来使得最终结构为一个<code>Trapframe</code>，剩下的按照Exercise的描述操作就可以了，得到<code>_alltraps</code>的结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Lab 3: Your code here for _alltraps</span><br><span class="line"> */</span><br><span class="line">.global _alltraps</span><br><span class="line">_alltraps:</span><br><span class="line">	pushl %ds</span><br><span class="line">	pushl %es</span><br><span class="line">	pushal</span><br><span class="line">	pushl $GD_KD</span><br><span class="line">	popl %ds</span><br><span class="line">	pushl $GD_KD</span><br><span class="line">	popl %es</span><br><span class="line">	pushl %esp</span><br><span class="line">	call trap</span><br></pre></td></tr></table></figure>
<p>利用已经存在的<code>TRAPHANDLER</code>和<code>TRAPHANDLER_NOEC</code>宏可以来生成handler的入口，只需要区分有没有错误码就可以了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Lab 3: Your code here for generating entry points for the different traps.</span><br><span class="line"> */</span><br><span class="line"></span><br><span class="line">	TRAPHANDLER_NOEC(handler_divide, T_DIVIDE)</span><br><span class="line">	TRAPHANDLER_NOEC(handler_debug, T_DEBUG)</span><br><span class="line">	TRAPHANDLER_NOEC(handler_nmi, T_NMI)</span><br><span class="line">	TRAPHANDLER_NOEC(handler_brkpt, T_BRKPT)</span><br><span class="line">	TRAPHANDLER_NOEC(handler_oflow, T_OFLOW)</span><br><span class="line">	TRAPHANDLER_NOEC(handler_bound, T_BOUND)</span><br><span class="line">	TRAPHANDLER_NOEC(handler_illop, T_ILLOP)</span><br><span class="line">	TRAPHANDLER_NOEC(handler_device, T_DEVICE)</span><br><span class="line">	TRAPHANDLER(handler_dblflt, T_DBLFLT)</span><br><span class="line">	TRAPHANDLER(handler_tss, T_TSS)</span><br><span class="line">	TRAPHANDLER(handler_segnp, T_SEGNP)</span><br><span class="line">	TRAPHANDLER(handler_stack, T_STACK)</span><br><span class="line">	TRAPHANDLER(handler_gpflt, T_GPFLT)</span><br><span class="line">	TRAPHANDLER(handler_pgflt, T_PGFLT)</span><br><span class="line">	TRAPHANDLER_NOEC(handler_fperr, T_FPERR)</span><br><span class="line">	TRAPHANDLER(handler_align, T_ALIGN)</span><br><span class="line">	TRAPHANDLER_NOEC(handler_mchk, T_MCHK)</span><br><span class="line">	TRAPHANDLER_NOEC(handler_simderr, T_SIMDERR)</span><br><span class="line">	TRAPHANDLER_NOEC(handler_syscall, T_SYSCALL)</span><br><span class="line">	TRAPHANDLER_NOEC(handler_default, T_DEFAULT)</span><br></pre></td></tr></table></figure>
<p>通过查询80386手册的9.10可以看到如下关于error code的总结：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Description                       Interrupt     Error Code</span><br><span class="line">Number</span><br><span class="line"></span><br><span class="line">Divide error                       0            No</span><br><span class="line">Debug exceptions                   1            No</span><br><span class="line">Breakpoint                         3            No</span><br><span class="line">Overflow                           4            No</span><br><span class="line">Bounds check                       5            No</span><br><span class="line">Invalid opcode                     6            No</span><br><span class="line">Coprocessor not available          7            No</span><br><span class="line">System error                       8            Yes (always 0)</span><br><span class="line">Coprocessor Segment Overrun        9            No</span><br><span class="line">Invalid TSS                       10            Yes</span><br><span class="line">Segment not present               11            Yes</span><br><span class="line">Stack exception                   12            Yes</span><br><span class="line">General protection fault          13            Yes</span><br><span class="line">Page fault                        14            Yes</span><br><span class="line">Coprocessor error                 16            No</span><br><span class="line">Two-byte SW interrupt             0-255         No</span><br></pre></td></tr></table></figure>
<p>在inc/mmu.h当中可以看到有关SETGATE的描述：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">// Set up a normal interrupt/trap gate descriptor.</span><br><span class="line">// - istrap: 1 for a trap (= exception) gate, 0 for an interrupt gate.</span><br><span class="line">    //   see section 9.6.1.3 of the i386 reference: &quot;The difference between</span><br><span class="line">    //   an interrupt gate and a trap gate is in the effect on IF (the</span><br><span class="line">    //   interrupt-enable flag). An interrupt that vectors through an</span><br><span class="line">    //   interrupt gate resets IF, thereby preventing other interrupts from</span><br><span class="line">    //   interfering with the current interrupt handler. A subsequent IRET</span><br><span class="line">    //   instruction restores IF to the value in the EFLAGS image on the</span><br><span class="line">    //   stack. An interrupt through a trap gate does not change IF.&quot;</span><br><span class="line">// - sel: Code segment selector for interrupt/trap handler</span><br><span class="line">// - off: Offset in code segment for interrupt/trap handler</span><br><span class="line">// - dpl: Descriptor Privilege Level -</span><br><span class="line">//	  the privilege level required for software to invoke</span><br><span class="line">//	  this interrupt/trap gate explicitly using an int instruction.</span><br><span class="line">#define SETGATE(gate, istrap, sel, off, dpl)			\</span><br><span class="line">&#123;								\</span><br><span class="line">	(gate).gd_off_15_0 = (uint32_t) (off) &amp; 0xffff;		\</span><br><span class="line">	(gate).gd_sel = (sel);					\</span><br><span class="line">	(gate).gd_args = 0;					\</span><br><span class="line">	(gate).gd_rsv1 = 0;					\</span><br><span class="line">	(gate).gd_type = (istrap) ? STS_TG32 : STS_IG32;	\</span><br><span class="line">	(gate).gd_s = 0;					\</span><br><span class="line">	(gate).gd_dpl = (dpl);					\</span><br><span class="line">	(gate).gd_p = 1;					\</span><br><span class="line">	(gate).gd_off_31_16 = (uint32_t) (off) &gt;&gt; 16;		\</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>之后再<code>trap_init()</code>当中进行这样的填充，要注意到断点和系统调用的dpl需要设置为3（用户）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">// LAB 3: Your code here.</span><br><span class="line">	void handler_divide();</span><br><span class="line">	SETGATE(idt[T_DIVIDE], 0, GD_KT, handler_divide, 0);</span><br><span class="line">	void handler_debug();</span><br><span class="line">	SETGATE(idt[T_DEBUG], 0, GD_KT, handler_debug, 0);</span><br><span class="line">	void handler_nmi();</span><br><span class="line">	SETGATE(idt[T_NMI], 0, GD_KT, handler_nmi, 0);</span><br><span class="line">	void handler_brkpt();</span><br><span class="line">	SETGATE(idt[T_BRKPT], 0, GD_KT, handler_brkpt, 3);</span><br><span class="line">	void handler_oflow();</span><br><span class="line">	SETGATE(idt[T_OFLOW], 0, GD_KT, handler_oflow, 0);</span><br><span class="line">	void handler_bound();</span><br><span class="line">	SETGATE(idt[T_BOUND], 0, GD_KT, handler_bound, 0);</span><br><span class="line">	void handler_illop();</span><br><span class="line">	SETGATE(idt[T_ILLOP], 0, GD_KT, handler_illop, 0);</span><br><span class="line">	void handler_device();</span><br><span class="line">	SETGATE(idt[T_DEVICE], 0, GD_KT, handler_device, 0);</span><br><span class="line">	void handler_dblflt();</span><br><span class="line">	SETGATE(idt[T_DBLFLT], 0, GD_KT, handler_dblflt, 0);</span><br><span class="line">	void handler_tss();</span><br><span class="line">	SETGATE(idt[T_TSS], 0, GD_KT, handler_tss, 0);</span><br><span class="line">	void handler_segnp();</span><br><span class="line">	SETGATE(idt[T_SEGNP], 0, GD_KT, handler_segnp, 0);</span><br><span class="line">	void handler_stack();</span><br><span class="line">	SETGATE(idt[T_STACK], 0, GD_KT, handler_stack, 0);</span><br><span class="line">	void handler_gpflt();</span><br><span class="line">	SETGATE(idt[T_GPFLT], 0, GD_KT, handler_gpflt, 0);</span><br><span class="line">	void handler_pgflt();</span><br><span class="line">	SETGATE(idt[T_PGFLT], 0, GD_KT, handler_pgflt, 0);</span><br><span class="line">	void handler_fperr();</span><br><span class="line">	SETGATE(idt[T_FPERR], 0, GD_KT, handler_fperr, 0);</span><br><span class="line">	void handler_align();</span><br><span class="line">	SETGATE(idt[T_ALIGN], 0, GD_KT, handler_align, 0);</span><br><span class="line">	void handler_mchk();</span><br><span class="line">	SETGATE(idt[T_MCHK], 0, GD_KT, handler_mchk, 0);</span><br><span class="line">	void handler_simderr();</span><br><span class="line">	SETGATE(idt[T_SIMDERR], 0, GD_KT, handler_simderr, 0);</span><br><span class="line">	void handler_syscall();</span><br><span class="line">	SETGATE(idt[T_SYSCALL], 1, GD_KT, handler_syscall, 3);</span><br><span class="line">	void handler_default();</span><br><span class="line">	SETGATE(idt[T_DEFAULT], 0, GD_KT, handler_default, 0);</span><br></pre></td></tr></table></figure>
<p>利用<code>make grade</code>可以得到下面的输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">divzero: OK (1.8s)</span><br><span class="line">    (Old jos.out.divzero failure log removed)</span><br><span class="line">softint: OK (1.7s)</span><br><span class="line">    (Old jos.out.softint failure log removed)</span><br><span class="line">badsegment: OK (2.1s)</span><br><span class="line">    (Old jos.out.badsegment failure log removed)</span><br><span class="line">Part A score: 30/30</span><br></pre></td></tr></table></figure>
<p>说明这里Part A的实现没有问题。</p>
<h2 id="question"><a class="markdownIt-Anchor" href="#question"></a> Question</h2>
<ol>
<li>
<p>如果所有的exception/interrupt都通过同样一个handler，那么就没有办法知道是通过哪一个中断进来的，不能设置对应的中断号，后面不能进行分发。</p>
</li>
<li>
<p>除了系统调用门，其他的特权级都设置成0，这里int $14本来应当触发page fault，但是这个时候权限不对，所以会触发general protection fault。如果允许他能够触发page fault的话，那么者会造成安全隐患。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[00000000] new env 00001000</span><br><span class="line">Incoming TRAP frame at 0xefffffbc</span><br><span class="line">TRAP frame at 0xf0226000</span><br><span class="line">  edi  0x00000000</span><br><span class="line">  esi  0x00000000</span><br><span class="line">  ebp  0xeebfdfd0</span><br><span class="line">  oesp 0xefffffdc</span><br><span class="line">  ebx  0x00000000</span><br><span class="line">  edx  0x00000000</span><br><span class="line">  ecx  0x00000000</span><br><span class="line">  eax  0x00000000</span><br><span class="line">  es   0x----0023</span><br><span class="line">  ds   0x----0023</span><br><span class="line">  trap 0x0000000d General Protection</span><br><span class="line">  err  0x00000072</span><br><span class="line">  eip  0x00800037</span><br><span class="line">  cs   0x----001b</span><br><span class="line">  flag 0x00000046</span><br><span class="line">  esp  0xeebfdfd0</span><br><span class="line">  ss   0x----0023</span><br><span class="line">[00001000] free env 00001000</span><br></pre></td></tr></table></figure>
<p>当允许触发page fault的时候，可以看到保存的内容如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[00000000] new env 00001000</span><br><span class="line">Incoming TRAP frame at 0xefffffc0</span><br><span class="line">TRAP frame at 0xefffffc0</span><br><span class="line">  edi  0x00000000</span><br><span class="line">  esi  0x00000000</span><br><span class="line">  ebp  0xeebfdfd0</span><br><span class="line">  oesp 0xefffffe0</span><br><span class="line">  ebx  0x00000000</span><br><span class="line">  edx  0x00000000</span><br><span class="line">  ecx  0x00000000</span><br><span class="line">  eax  0x00000000</span><br><span class="line">  es   0x----0023</span><br><span class="line">  ds   0x----0023</span><br><span class="line">  trap 0x0000000e Page Fault</span><br><span class="line">  cr2  0x00000000</span><br><span class="line">  err  0x00800039 [kernel, read, protection]</span><br><span class="line">  eip  0x0000001b</span><br><span class="line">  cs   0x----0046</span><br><span class="line">  flag 0xeebfdfd0</span><br><span class="line">  esp  0x00000023</span><br><span class="line">  ss   0x----ff53</span><br><span class="line">[00001000] free env 00001000</span><br></pre></td></tr></table></figure>
<p>在这里我的想法是第15行往后全部进行了一位的上移，可以看到之后的err当中的内容实际上应该是eip，eip的内容实际上是cs，以此类推。应该是cr2或者err code没有进行压入导致的。</p>
</li>
</ol>
<h2 id="exercise-5"><a class="markdownIt-Anchor" href="#exercise-5"></a> Exercise 5</h2>
<p>只需要在<code>trap_dispatch()</code>当中添加一个分支即可：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(tf-&gt;tf_trapno == T_PGFLT)</span><br><span class="line">&#123;</span><br><span class="line">	page_fault_handler(tf);</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="exercise-6"><a class="markdownIt-Anchor" href="#exercise-6"></a> Exercise 6</h2>
<p>和Exercise 5相同，只需要在<code>trap_dispatch()</code>里面添加一个分支：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(tf-&gt;tf_trapno == T_BRKPT)</span><br><span class="line">&#123;</span><br><span class="line">	monitor(tf);</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="question-2"><a class="markdownIt-Anchor" href="#question-2"></a> Question</h2>
<ol start="3">
<li>
<p>在于前面Exercise 4中的设置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SETGATE(idt[T_BRKPT], 0, GD_KT, handler_brkpt, 3);</span><br></pre></td></tr></table></figure>
<p>这里当最后的dpl设置为3的时候，会正确的触发为break point exception，当设置为0的时候，会触发为general protection fault。其原因在于，如果设置为0，会导致断点触发需要内核级的权限，因为权限不够从而触发GPF。</p>
</li>
<li>
<p>这个测试的目的主要是检查权限是否设置正确，需要正确的区分用户和内核，防止用户对于内核代码进行操作产生安全隐患。</p>
</li>
</ol>
<h2 id="exercise-7"><a class="markdownIt-Anchor" href="#exercise-7"></a> Exercise 7</h2>
<p>在kern/trap.c里面，同之前两个Exercise一样进行分发的设置：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(tf-&gt;tf_trapno == T_SYSCALL)</span><br><span class="line">&#123;</span><br><span class="line">	tf-&gt;tf_regs.reg_eax = syscall(tf-&gt;tf_regs.reg_eax,</span><br><span class="line">	tf-&gt;tf_regs.reg_edx, tf-&gt;tf_regs.reg_ecx, tf-&gt;tf_regs.reg_ebx,</span><br><span class="line">	tf-&gt;tf_regs.reg_edi, tf-&gt;tf_regs.reg_esi);</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在kern/syscall.c当中，利用switch进行分发即可，注意不同系统调用的参数就可以了：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Dispatches to the correct kernel function, passing the arguments.</span></span><br><span class="line"><span class="type">int32_t</span></span><br><span class="line"><span class="title function_">syscall</span><span class="params">(<span class="type">uint32_t</span> syscallno, <span class="type">uint32_t</span> a1, <span class="type">uint32_t</span> a2, <span class="type">uint32_t</span> a3, <span class="type">uint32_t</span> a4, <span class="type">uint32_t</span> a5)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// Call the function corresponding to the &#x27;syscallno&#x27; parameter.</span></span><br><span class="line">	<span class="comment">// Return any appropriate return value.</span></span><br><span class="line">	<span class="comment">// LAB 3: Your code here.</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">//panic(&quot;syscall not implemented&quot;);</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (syscallno) &#123;</span><br><span class="line">		<span class="keyword">case</span> SYS_cputs:</span><br><span class="line">			sys_cputs((<span class="type">const</span> <span class="type">char</span> *)a1, (<span class="type">size_t</span>)a2);</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> SYS_cgetc:</span><br><span class="line">			<span class="keyword">return</span> sys_cgetc();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> SYS_getenvid:</span><br><span class="line">			<span class="keyword">return</span> sys_getenvid();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> SYS_env_destroy:</span><br><span class="line">			<span class="keyword">return</span> sys_env_destroy((<span class="type">envid_t</span>)a1);</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> NSYSCALLS:</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			<span class="keyword">return</span> -E_INVAL;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="exercise-8"><a class="markdownIt-Anchor" href="#exercise-8"></a> Exercise 8</h2>
<p>在lib/libmain.c当中，进行env_id的指定：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">libmain</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// set thisenv to point at our Env structure in envs[].</span></span><br><span class="line">	<span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">	<span class="type">envid_t</span> envid = sys_getenvid();</span><br><span class="line">	thisenv = &amp;envs[ENVX(envid)];</span><br><span class="line"></span><br><span class="line">	<span class="comment">// save the name of the program so that panic() can use it</span></span><br><span class="line">	<span class="keyword">if</span> (argc &gt; <span class="number">0</span>)</span><br><span class="line">		binaryname = argv[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">	<span class="comment">// call user main routine</span></span><br><span class="line">	umain(argc, argv);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// exit gracefully</span></span><br><span class="line">	<span class="built_in">exit</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="exercise-9"><a class="markdownIt-Anchor" href="#exercise-9"></a> Exercise 9</h2>
<p>在kern/trap.c当中的<code>page_fault_handler()</code>函数当中，利用tf_cs来判断是不是在kernel-mode，如果是直接触发一个panic：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Handle kernel-mode page faults.</span></span><br><span class="line"><span class="comment">// LAB 3: Your code here.</span></span><br><span class="line"><span class="keyword">if</span>(((tf-&gt;tf_cs)&amp;<span class="number">3</span>) == <span class="number">0</span>)</span><br><span class="line">	panic(<span class="string">&quot;page fault: happen in kernel mode! %08x\n&quot;</span>, tf-&gt;tf_cs);</span><br></pre></td></tr></table></figure>
<p>在kern/pmap.c当中，采用一个for循环对虚拟地址区间进行权限的检查，具体内容遵循注释就可以。当检查没有问题的时候返回值为0，否则返回值为-E_FAULT。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Check that an environment is allowed to access the range of memory</span></span><br><span class="line"><span class="comment">// [va, va+len) with permissions &#x27;perm | PTE_P&#x27;.</span></span><br><span class="line"><span class="comment">// Normally &#x27;perm&#x27; will contain PTE_U at least, but this is not required.</span></span><br><span class="line"><span class="comment">// &#x27;va&#x27; and &#x27;len&#x27; need not be page-aligned; you must test every page that</span></span><br><span class="line"><span class="comment">// contains any of that range.  You will test either &#x27;len/PGSIZE&#x27;,</span></span><br><span class="line"><span class="comment">// &#x27;len/PGSIZE + 1&#x27;, or &#x27;len/PGSIZE + 2&#x27; pages.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// A user program can access a virtual address if (1) the address is below</span></span><br><span class="line"><span class="comment">// ULIM, and (2) the page table gives it permission.  These are exactly</span></span><br><span class="line"><span class="comment">// the tests you should implement here.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// If there is an error, set the &#x27;user_mem_check_addr&#x27; variable to the first</span></span><br><span class="line"><span class="comment">// erroneous virtual address.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Returns 0 if the user program can access this range of addresses,</span></span><br><span class="line"><span class="comment">// and -E_FAULT otherwise.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">user_mem_check</span><span class="params">(<span class="keyword">struct</span> Env *env, <span class="type">const</span> <span class="type">void</span> *va, <span class="type">size_t</span> len, <span class="type">int</span> perm)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">	<span class="type">int</span> newperm = perm | PTE_P;</span><br><span class="line">	<span class="type">uint32_t</span> cur_addr;</span><br><span class="line">	<span class="type">pte_t</span> * pte;</span><br><span class="line">	<span class="keyword">for</span>(cur_addr = (<span class="type">uint32_t</span>)va; cur_addr &lt; (<span class="type">uint32_t</span>)(va + len); cur_addr = ROUNDDOWN((cur_addr+PGSIZE),PGSIZE))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(cur_addr &gt;= ULIM)</span><br><span class="line">		&#123;</span><br><span class="line">			user_mem_check_addr = cur_addr;</span><br><span class="line">			<span class="keyword">return</span> -E_FAULT;</span><br><span class="line">		&#125;</span><br><span class="line">		pte = pgdir_walk(env-&gt;env_pgdir, (<span class="type">void</span> *)cur_addr, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span>((!pte) || ((*pte) &amp; newperm) != newperm)&#123;</span><br><span class="line">			user_mem_check_addr = cur_addr;</span><br><span class="line">			<span class="keyword">return</span> -E_FAULT;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要注意的是要在kern/syscall.c当中需要填充上有关检查的部分！</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Print a string to the system console.</span></span><br><span class="line"><span class="comment">// The string is exactly &#x27;len&#x27; characters long.</span></span><br><span class="line"><span class="comment">// Destroys the environment on memory errors.</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">sys_cputs</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *s, <span class="type">size_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// Check that the user has permission to read memory [s, s+len).</span></span><br><span class="line">	<span class="comment">// Destroy the environment if not.</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">	user_mem_assert(curenv, s, len, PTE_W);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Print the string supplied by the user.</span></span><br><span class="line">	cprintf(<span class="string">&quot;%.*s&quot;</span>, len, s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果这里没有进行<code>user_mem_assert()</code>的话，执行buggyhello会进入系统调用然后在内核态触发page fault。</p>
<p>之后为backtrace相关的内容，在kern/kdebug.c当中添加有关usd，stabs，stabstr的检查如下，这里注意<code>user_mem_check()</code>当正常的时候返回值为0：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="comment">// The user-application linker script, user/user.ld,</span></span><br><span class="line">		<span class="comment">// puts information about the application&#x27;s stabs (equivalent</span></span><br><span class="line">		<span class="comment">// to __STAB_BEGIN__, __STAB_END__, __STABSTR_BEGIN__, and</span></span><br><span class="line">		<span class="comment">// __STABSTR_END__) in a structure located at virtual address</span></span><br><span class="line">		<span class="comment">// USTABDATA.</span></span><br><span class="line">		<span class="type">const</span> <span class="keyword">struct</span> UserStabData *usd = (<span class="type">const</span> <span class="keyword">struct</span> UserStabData *) USTABDATA;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Make sure this memory is valid.</span></span><br><span class="line">		<span class="comment">// Return -1 if it is not.  Hint: Call user_mem_check.</span></span><br><span class="line">		<span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">		<span class="keyword">if</span>(user_mem_check(curenv, (<span class="type">void</span> *)usd, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> UserStabData), PTE_U))</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">		stabs = usd-&gt;stabs;</span><br><span class="line">		stab_end = usd-&gt;stab_end;</span><br><span class="line">		stabstr = usd-&gt;stabstr;</span><br><span class="line">		stabstr_end = usd-&gt;stabstr_end;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Make sure the STABS and string table memory is valid.</span></span><br><span class="line">		<span class="comment">// LAB 3: Your code here.</span></span><br><span class="line">		<span class="keyword">if</span>(user_mem_check(curenv, (<span class="type">void</span> *)stabs, (<span class="type">uint32_t</span>)stabs-(<span class="type">uint32_t</span>)stab_end, PTE_U))</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">		<span class="keyword">if</span>(user_mem_check(curenv, (<span class="type">void</span> *)stabstr, (<span class="type">uint32_t</span>)stabstr_end-(<span class="type">uint32_t</span>)stabstr, PTE_U))</span><br><span class="line">			<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>在执行breakpoint之后，利用backtrace得到的结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">K&gt; backtrace</span><br><span class="line">Stack backtrace:</span><br><span class="line">ebp efffff10 eip f01010d6 args 00000001 efffff28 f0228000 00000000 f01e6a40</span><br><span class="line">	     kern/monitor.c:448: monitor+260</span><br><span class="line">ebp efffff80 eip f01048ca args f0228000 efffffbc 00000000 00000000 00000000</span><br><span class="line">	     kern/trap.c:195: trap+180</span><br><span class="line">ebp efffffb0 eip f0104a43 args efffffbc 00000000 00000000 eebfdfd0 efffffdc</span><br><span class="line">	     kern/trapentry.S:85: &lt;unknown&gt;+0</span><br><span class="line">ebp eebfdfd0 eip 0080007b args 00000000 00000000 00000000 00000000 00000000</span><br><span class="line">	     lib/libmain.c:27: libmain+63</span><br><span class="line">ebp eebfdff0 eip 00800031 args 00000000 00000000Incoming TRAP frame at 0xeffffec</span><br><span class="line">kernel panic at kern/trap.c:270: page fault: happen in kernel mode! 00000008</span><br></pre></td></tr></table></figure>
<p>可以看到最后为lib/libmain.c，并且最终在内核态发生了page fault。可以发现，这个地方args在输出到第三个参数的时候突然触发，那应该是从ebp向上读取args触发的page fault。</p>
<p>结合<code>mom_backtrace()</code>的实现如下，应该是在13行的语句处出现的错误：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">mon_backtrace</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv, <span class="keyword">struct</span> Trapframe *tf)</span></span><br><span class="line">&#123;</span><br><span class="line">	cprintf(<span class="string">&quot;Stack backtrace:\n&quot;</span>);</span><br><span class="line">	<span class="type">uint32_t</span>* ebp = (<span class="type">uint32_t</span>*)read_ebp();</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Eipdebuginfo</span> <span class="title">info</span>;</span></span><br><span class="line">	<span class="keyword">while</span>(ebp)&#123;</span><br><span class="line">		cprintf(<span class="string">&quot;ebp %08x &quot;</span>,ebp);</span><br><span class="line">		cprintf(<span class="string">&quot;eip %08x &quot;</span>,ebp[<span class="number">1</span>]);</span><br><span class="line">		cprintf(<span class="string">&quot;args&quot;</span>);</span><br><span class="line">		<span class="type">int</span> i;</span><br><span class="line">		<span class="keyword">for</span>(i=<span class="number">2</span>;i&lt;=<span class="number">6</span>;++i)</span><br><span class="line">			cprintf(<span class="string">&quot; %08x&quot;</span>,ebp[i]);</span><br><span class="line">		cprintf(<span class="string">&quot;\n&quot;</span>);</span><br></pre></td></tr></table></figure>
<h2 id="exercise-10"><a class="markdownIt-Anchor" href="#exercise-10"></a> Exercise 10</h2>
<p>运行evilhello可以看到如下的输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[00000000] new env 00001000</span><br><span class="line">Incoming TRAP frame at 0xefffffbc</span><br><span class="line">Incoming TRAP frame at 0xefffffbc</span><br><span class="line">[00001000] user_mem_check assertion failure for va f010000c</span><br><span class="line">[00001000] free env 00001000</span><br><span class="line">Destroyed the only environment - nothing more to do!</span><br><span class="line">Welcome to the JOS kernel monitor!</span><br></pre></td></tr></table></figure>
<p>用户环境被销毁了，并且kernel没有panic，说明行为符合预期。</p>
<p>使用make grade命令可以得到如下结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">divzero: OK (1.4s)</span><br><span class="line">softint: OK (1.4s)</span><br><span class="line">badsegment: OK (2.0s)</span><br><span class="line">Part A score: 30/30</span><br><span class="line"></span><br><span class="line">faultread: OK (1.9s)</span><br><span class="line">faultreadkernel: OK (1.6s)</span><br><span class="line">faultwrite: OK (0.9s)</span><br><span class="line">faultwritekernel: OK (1.6s)</span><br><span class="line">breakpoint: OK (2.0s)</span><br><span class="line">testbss: OK (2.1s)</span><br><span class="line">hello: OK (1.8s)</span><br><span class="line">buggyhello: OK (1.7s)</span><br><span class="line">buggyhello2: OK (0.8s)</span><br><span class="line">evilhello: OK (1.6s)</span><br><span class="line">Part B score: 50/50</span><br><span class="line"></span><br><span class="line">Score: 80/80</span><br></pre></td></tr></table></figure>
<p>说明lab3的内容已经被完成了。</p>
<h2 id="challenge-1"><a class="markdownIt-Anchor" href="#challenge-1"></a> Challenge 1</h2>
<p>参考了github上<a target="_blank" rel="noopener" href="https://github.com/SimpCosm/6.828/tree/master/lab3%E7%9A%84%E5%AE%9E%E7%8E%B0%E3%80%82">https://github.com/SimpCosm/6.828/tree/master/lab3的实现。</a></p>
<p>其中TRAPHANDLER和TRAPHANDLER_NOEC的主要区别就在于有没有压入error code，这里采用一个if语句来进行判断：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#define GENERALHANDLER(name, num)	\</span><br><span class="line">  .data;  \</span><br><span class="line">    .long name; \</span><br><span class="line">  .text;  \</span><br><span class="line">    .globl name;	\</span><br><span class="line">   	.type name, @function;	\</span><br><span class="line">   	.align 2;		\</span><br><span class="line">	name:	\</span><br><span class="line">    .if !(num == 8 || (num &gt;= 10 &amp;&amp; num &lt;= 14) || num == 17 );   \</span><br><span class="line">    pushl $0;   \</span><br><span class="line">   	.endif;     \</span><br><span class="line"> 		pushl $(num);							\</span><br><span class="line">  	jmp _alltraps</span><br></pre></td></tr></table></figure>
<p>之后构建一个数组vectors用来保存相关函数，就可以采用脚本语言批量生成重复代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">.data</span><br><span class="line">	.globl vectors</span><br><span class="line">vectors:</span><br><span class="line">		GENERALHANDLER(handler0, 0)</span><br><span class="line">    GENERALHANDLER(handler1, 1)</span><br><span class="line">    GENERALHANDLER(handler2, 2)</span><br><span class="line">    GENERALHANDLER(handler3, 3)</span><br><span class="line">    GENERALHANDLER(handler4, 4)</span><br><span class="line">    GENERALHANDLER(handler5, 5)</span><br><span class="line">    GENERALHANDLER(handler6, 6)</span><br><span class="line">    GENERALHANDLER(handler7, 7)</span><br><span class="line">    GENERALHANDLER(handler8, 8)</span><br><span class="line">    GENERALHANDLER(handler9, 9)</span><br><span class="line">    GENERALHANDLER(handler10, 10)</span><br><span class="line">    GENERALHANDLER(handler11, 11)</span><br><span class="line">    GENERALHANDLER(handler12, 12)</span><br><span class="line">    GENERALHANDLER(handler13, 13)</span><br><span class="line">    GENERALHANDLER(handler14, 14)</span><br><span class="line">    GENERALHANDLER(handler15, 15)</span><br><span class="line">    GENERALHANDLER(handler16, 16)</span><br><span class="line">    GENERALHANDLER(handler17, 17)</span><br><span class="line">    GENERALHANDLER(handler18, 18)</span><br><span class="line">    GENERALHANDLER(handler19, 19)</span><br><span class="line">    GENERALHANDLER(handler20, 20)</span><br><span class="line">    GENERALHANDLER(handler21, 21)</span><br><span class="line">    GENERALHANDLER(handler22, 22)</span><br><span class="line">    GENERALHANDLER(handler23, 23)</span><br><span class="line">    GENERALHANDLER(handler24, 24)</span><br><span class="line">    GENERALHANDLER(handler25, 25)</span><br><span class="line">    GENERALHANDLER(handler26, 26)</span><br><span class="line">    GENERALHANDLER(handler27, 27)</span><br><span class="line">    GENERALHANDLER(handler28, 28)</span><br><span class="line">    GENERALHANDLER(handler29, 29)</span><br><span class="line">    GENERALHANDLER(handler30, 30)</span><br><span class="line">    GENERALHANDLER(handler31, 31)</span><br><span class="line">    GENERALHANDLER(handler32, 32)</span><br><span class="line">    GENERALHANDLER(handler33, 33)</span><br><span class="line">    GENERALHANDLER(handler34, 34)</span><br><span class="line">    GENERALHANDLER(handler35, 35)</span><br><span class="line">    GENERALHANDLER(handler36, 36)</span><br><span class="line">    GENERALHANDLER(handler37, 37)</span><br><span class="line">    GENERALHANDLER(handler38, 38)</span><br><span class="line">    GENERALHANDLER(handler39, 39)</span><br><span class="line">    GENERALHANDLER(handler40, 40)</span><br><span class="line">    GENERALHANDLER(handler41, 41)</span><br><span class="line">    GENERALHANDLER(handler42, 42)</span><br><span class="line">    GENERALHANDLER(handler43, 43)</span><br><span class="line">    GENERALHANDLER(handler44, 44)</span><br><span class="line">    GENERALHANDLER(handler45, 45)</span><br><span class="line">    GENERALHANDLER(handler46, 46)</span><br><span class="line">    GENERALHANDLER(handler47, 47)</span><br><span class="line">    GENERALHANDLER(handler48, 48)</span><br><span class="line">    GENERALHANDLER(handler49, 49)</span><br><span class="line">    GENERALHANDLER(handler50, 50)</span><br><span class="line">    GENERALHANDLER(handler51, 51)</span><br><span class="line">    GENERALHANDLER(handler52, 52)</span><br><span class="line">    GENERALHANDLER(handler53, 53)</span><br></pre></td></tr></table></figure>
<p>之后就可以在kern/trap.c中对<code>trap_init()</code>采用循环构建入口，节省大量代码，对于特殊的可以单独提出来进行构造：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> i;</span><br><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; <span class="number">54</span>; ++i)</span><br><span class="line">	SETGATE(idt[i], <span class="number">0</span>, GD_KT, vectors[i], <span class="number">0</span>);</span><br><span class="line">SETGATE(idt[T_BRKPT], <span class="number">0</span>, GD_KT, vectors[T_BRKPT], <span class="number">3</span>);</span><br><span class="line">SETGATE(idt[T_SYSCALL], <span class="number">1</span>, GD_KT, vectors[T_SYSCALL], <span class="number">3</span>);</span><br></pre></td></tr></table></figure>
<p>在完成以上的修改之后，通过<code>make grade</code>仍然可以得到80分结果，说明没有问题：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">divzero: OK (1.4s)</span><br><span class="line">softint: OK (1.4s)</span><br><span class="line">badsegment: OK (1.6s)</span><br><span class="line">Part A score: 30/30</span><br><span class="line"></span><br><span class="line">faultread: OK (0.9s)</span><br><span class="line">faultreadkernel: OK (1.5s)</span><br><span class="line">faultwrite: OK (2.0s)</span><br><span class="line">faultwritekernel: OK (1.6s)</span><br><span class="line">breakpoint: OK (0.9s)</span><br><span class="line">    (Old jos.out.breakpoint failure log removed)</span><br><span class="line">testbss: OK (1.5s)</span><br><span class="line">hello: OK (1.6s)</span><br><span class="line">buggyhello: OK (1.0s)</span><br><span class="line">buggyhello2: OK (1.4s)</span><br><span class="line">evilhello: OK (1.6s)</span><br><span class="line">Part B score: 50/50</span><br><span class="line"></span><br><span class="line">Score: 80/80</span><br></pre></td></tr></table></figure>
<h2 id="challenge-2"><a class="markdownIt-Anchor" href="#challenge-2"></a> Challenge 2</h2>
<p>Intel手册中12.3.1.4节为关于单步调试的相关内容：</p>
<blockquote>
<p>This debug condition occurs at the end of an instruction if the trap flag (TF) of the flags register held the value one at the beginning of that instruction. Note that the exception does not occur at the end of an instruction that sets TF. For example, if POPF is used to set TF, a single-step trap does not occur until after the instruction that follows POPF.</p>
</blockquote>
<p>意思就是设置了TF之后，执行完下一条命令会触发一个DEBUG。于是可以照如下写continue和stepi指令：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">mon_continue</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv, <span class="keyword">struct</span> Trapframe *tf)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(!tf)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	tf-&gt;tf_eflags &amp;= ~FL_TF;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">mon_stepi</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv, <span class="keyword">struct</span> Trapframe *tf)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(!tf)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	tf-&gt;tf_eflags |= FL_TF;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里需要注意第六行，如果在continue里面不进行eflags维护单纯返回的话，会导致在执行了stepi指令之后，continue指令无效的情况。</p>
<p>同时为了使得stepi触发DEBUG之后能够回到monitor，需要在<code>trap_dispatch()</code>当中添加关于T_DEBUG的分发：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(tf-&gt;tf_trapno == T_BRKPT || tf-&gt;tf_trapno == T_DEBUG)</span><br><span class="line">&#123;</span><br><span class="line">	monitor(tf);</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时利用continue可以在断点程序之后继续执行，效果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[00000000] new env 00001000</span><br><span class="line">Incoming TRAP frame at 0xefffffbc</span><br><span class="line">Incoming TRAP frame at 0xefffffbc</span><br><span class="line">Welcome to the JOS kernel monitor!</span><br><span class="line">Type &#x27;help&#x27; for a list of commands.</span><br><span class="line">TRAP frame at 0xf0228000</span><br><span class="line">  edi  0x00000000</span><br><span class="line">  esi  0x00000000</span><br><span class="line">  ebp  0xeebfdfd0</span><br><span class="line">  oesp 0xefffffdc</span><br><span class="line">  ebx  0x00000000</span><br><span class="line">  edx  0x00000000</span><br><span class="line">  ecx  0x00000000</span><br><span class="line">  eax  0xeec00000</span><br><span class="line">  es   0x----0023</span><br><span class="line">  ds   0x----0023</span><br><span class="line">  trap 0x00000003 Breakpoint</span><br><span class="line">  err  0x00000000</span><br><span class="line">  eip  0x00800038</span><br><span class="line">  cs   0x----001b</span><br><span class="line">  flag 0x00000046</span><br><span class="line">  esp  0xeebfdfd0</span><br><span class="line">  ss   0x----0023</span><br><span class="line">K&gt; continue</span><br><span class="line">Incoming TRAP frame at 0xefffffbc</span><br><span class="line">[00001000] exiting gracefully</span><br><span class="line">[00001000] free env 00001000</span><br><span class="line">Destroyed the only environment - nothing more to do!</span><br><span class="line">Welcome to the JOS kernel monitor!</span><br><span class="line">Type &#x27;help&#x27; for a list of commands.</span><br><span class="line">K&gt;</span><br></pre></td></tr></table></figure>
<h2 id="challenge-3"><a class="markdownIt-Anchor" href="#challenge-3"></a> Challenge 3</h2>
<p>从lab中所给的链接可以找到<code>rdmsr</code>和<code>wrmsr</code>的宏定义：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#define rdmsr(msr,val1,val2) \</span><br><span class="line">	__asm__ __volatile__(&quot;rdmsr&quot; \</span><br><span class="line">	: &quot;=a&quot; (val1), &quot;=d&quot; (val2) \</span><br><span class="line">	: &quot;c&quot; (msr))</span><br><span class="line"></span><br><span class="line">#define wrmsr(msr,val1,val2) \</span><br><span class="line">	__asm__ __volatile__(&quot;wrmsr&quot; \</span><br><span class="line">	: /* no outputs */ \</span><br><span class="line">	: &quot;c&quot; (msr), &quot;a&quot; (val1), &quot;d&quot; (val2))</span><br></pre></td></tr></table></figure>
<p>从IA32的手册当中可以找到在使用SYSENTER之前所需要设置的相关内容：</p>
<blockquote>
<ul>
<li><strong>IA32_SYSENTER_CS</strong> (MSR address 174H) — The lower 16 bits of this MSR are the segment selector for the privilege level 0 code segment. This value is also used to determine the segment selector of the privilege level 0 stack segment (see the Operation section). This value cannot indicate a null selector.</li>
<li><strong>IA32_SYSENTER_EIP</strong> (MSR address 176H) — The value of this MSR is loaded into RIP (thus, this value references the first instruction of the selected operating procedure or routine). In protected mode, only bits 31:0 are loaded.</li>
<li><strong>IA32_SYSENTER_ESP</strong> (MSR address 175H) — The value of this MSR is loaded into RSP (thus, this value contains the stack pointer for the privilege level 0 stack). This value cannot represent a non-canonical address. In protected mode, only bits 31:0 are loaded.</li>
</ul>
</blockquote>
<p>添加一个<code>sysenter_init()</code>并且在<code>trap_init()</code>内进行调用来实现初始化：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">sysenter_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	wrmsr(<span class="number">0x174</span>, GD_KT, <span class="number">0</span>);</span><br><span class="line">	wrmsr(<span class="number">0x176</span>, syscall_fast, <span class="number">0</span>);</span><br><span class="line">	wrmsr(<span class="number">0x175</span>, KSTACKTOP, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在lib/syscall.c里面需要仿照syscall写一个syscall_fast，与syscall不同的是，这里采用sysenter而不是int 0x30。同时需要将%esi保存为sysenter之后的位置，并且push和pop保存%ebp。这里参数同syscall相似，只是少了最后一个a5。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int32_t</span></span><br><span class="line"><span class="title function_">syscall_fast</span><span class="params">(<span class="type">int</span> num, <span class="type">int</span> check, <span class="type">uint32_t</span> a1, <span class="type">uint32_t</span> a2, <span class="type">uint32_t</span> a3, <span class="type">uint32_t</span> a4)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int32_t</span> ret;</span><br><span class="line">	<span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(</span></span><br><span class="line"><span class="params">			<span class="string">&quot;leal .after_sysenter_label, %%esi\n&quot;</span></span></span><br><span class="line"><span class="params">			<span class="string">&quot;push %%ebp\n&quot;</span></span></span><br><span class="line"><span class="params">			<span class="string">&quot;movl %%esp, %%ebp\n&quot;</span></span></span><br><span class="line"><span class="params">			<span class="string">&quot;sysenter\n&quot;</span></span></span><br><span class="line"><span class="params">			<span class="string">&quot;.after_sysenter_label: popl %%ebp\n&quot;</span></span></span><br><span class="line"><span class="params">		     : <span class="string">&quot;=a&quot;</span> (ret)</span></span><br><span class="line"><span class="params">		     : <span class="string">&quot;a&quot;</span> (num),</span></span><br><span class="line"><span class="params">		       <span class="string">&quot;d&quot;</span> (a1),</span></span><br><span class="line"><span class="params">		       <span class="string">&quot;c&quot;</span> (a2),</span></span><br><span class="line"><span class="params">		       <span class="string">&quot;b&quot;</span> (a3),</span></span><br><span class="line"><span class="params">		       <span class="string">&quot;D&quot;</span> (a4)</span></span><br><span class="line"><span class="params">		     :)</span>;	</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span>(check &amp;&amp; ret &gt; <span class="number">0</span>)</span><br><span class="line">		panic(<span class="string">&quot;syscall %d returned %d (&gt; 0)&quot;</span>, num, ret);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在kern/syscall.c中要写一个handler用来处理对应的系统调用，这个就是之前在init里面所填充的入口，流程为从保存的寄存器中取得参数，执行相应的内容，结束之后将返回值保存并利用sysexit返回（这里如果参数不都采用&quot;=m&quot;的约束会出现bug，原因未知）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">syscall_fast</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">uint32_t</span> syscallno, a1, a2, a3, a4, ret;</span><br><span class="line">	<span class="type">uint32_t</span> eip, esp;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(</span></span><br><span class="line"><span class="params">		<span class="string">&quot;mov %%eax, %0\n&quot;</span></span></span><br><span class="line"><span class="params">		<span class="string">&quot;mov %%edx, %1\n&quot;</span></span></span><br><span class="line"><span class="params">		<span class="string">&quot;mov %%ecx, %2\n&quot;</span></span></span><br><span class="line"><span class="params">		<span class="string">&quot;mov %%ebx, %3\n&quot;</span></span></span><br><span class="line"><span class="params">		<span class="string">&quot;mov %%edi, %4\n&quot;</span></span></span><br><span class="line"><span class="params">		<span class="string">&quot;mov %%esi, %5\n&quot;</span></span></span><br><span class="line"><span class="params">		<span class="string">&quot;mov (%%ebp), %6\n&quot;</span></span></span><br><span class="line"><span class="params">		:<span class="string">&quot;=r&quot;</span> (syscallno),</span></span><br><span class="line"><span class="params">		 <span class="string">&quot;=m&quot;</span> (a1),</span></span><br><span class="line"><span class="params">		 <span class="string">&quot;=m&quot;</span> (a2),</span></span><br><span class="line"><span class="params">		 <span class="string">&quot;=m&quot;</span> (a3),</span></span><br><span class="line"><span class="params">		 <span class="string">&quot;=m&quot;</span> (a4),</span></span><br><span class="line"><span class="params">		 <span class="string">&quot;=r&quot;</span> (eip),</span></span><br><span class="line"><span class="params">		 <span class="string">&quot;=r&quot;</span> (esp)</span></span><br><span class="line"><span class="params">	)</span>;	</span><br><span class="line"></span><br><span class="line">	<span class="keyword">switch</span> (syscallno) &#123;</span><br><span class="line">		<span class="keyword">case</span> SYS_cputs:</span><br><span class="line">			sys_cputs((<span class="type">const</span> <span class="type">char</span> *)a1, (<span class="type">size_t</span>)a2);</span><br><span class="line">			ret = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> SYS_cgetc:</span><br><span class="line">			ret = sys_cgetc();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> SYS_getenvid:</span><br><span class="line">			ret = sys_getenvid();</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> SYS_env_destroy:</span><br><span class="line">			ret = sys_env_destroy((<span class="type">envid_t</span>)a1);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">case</span> NSYSCALLS:</span><br><span class="line">			ret = <span class="number">0</span>;</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">default</span>:</span><br><span class="line">			panic(<span class="string">&quot;syscall_fast: wrong syscallno\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">asm</span> <span class="title function_">volatile</span><span class="params">(</span></span><br><span class="line"><span class="params">		<span class="string">&quot;sysexit\n&quot;</span></span></span><br><span class="line"><span class="params">			:</span></span><br><span class="line"><span class="params">			: <span class="string">&quot;a&quot;</span> (ret),</span></span><br><span class="line"><span class="params">			  <span class="string">&quot;d&quot;</span> (eip),</span></span><br><span class="line"><span class="params">			  <span class="string">&quot;c&quot;</span> (esp)</span></span><br><span class="line"><span class="params">			:)</span>;	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在lib/syscall.c中修改<code>sys_cputs()</code>让其调用<code>syscall_fast()</code>进行测试（实际上就是丢掉最后一个传入的参数就可以了）：</p>
<figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span></span></span><br><span class="line"><span class="function"><span class="title">sys_cputs</span>(<span class="params"><span class="keyword">const</span> <span class="built_in">char</span> *s, size_t len</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	syscall_fast(SYS_cputs, <span class="number">0</span>, (uint32_t)s, len, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="comment">//syscall(SYS_cputs, 0, (uint32_t)s, len, 0, 0, 0);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行hello能够得到的输出如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[00000000] new env 00001000</span><br><span class="line">Incoming TRAP frame at 0xefffffbc</span><br><span class="line">hello, world</span><br><span class="line">i am environment 00001000</span><br><span class="line">Incoming TRAP frame at 0xefffffbc</span><br><span class="line">[00001000] exiting gracefully</span><br><span class="line">[00001000] free env 00001000</span><br><span class="line">Destroyed the only environment - nothing more to do!</span><br></pre></td></tr></table></figure>
<p>对比原来的输出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">00000000</span>] new env <span class="number">00001000</span></span><br><span class="line">Incoming TRAP frame at <span class="number">0xefffffbc</span></span><br><span class="line">Incoming TRAP frame at <span class="number">0xefffffbc</span></span><br><span class="line">hello, world</span><br><span class="line">Incoming TRAP frame at <span class="number">0xefffffbc</span></span><br><span class="line">i am environment <span class="number">00001000</span></span><br><span class="line">Incoming TRAP frame at <span class="number">0xefffffbc</span></span><br><span class="line">[<span class="number">00001000</span>] exiting gracefully</span><br><span class="line">[<span class="number">00001000</span>] <span class="built_in">free</span> env <span class="number">00001000</span></span><br><span class="line">Destroyed the only environment - nothing more to <span class="keyword">do</span>!</span><br></pre></td></tr></table></figure>
<p>可以发现由于在进行系统调用的时候没有采用<code>int 0x30</code>，所以这里在每次输出前并没有都进入<code>trap()</code>函数，使得少去了两行<code>Incoming TRAP frame at ....</code>的输出。</p>
<p>替换后使用<code>make grade</code>也能够得到满分80分，至少在这个lab中采用sysenter不会有问题。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://phimos.github.io/2020/03/30/6828-lab2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Pims">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pims的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/30/6828-lab2/" class="post-title-link" itemprop="url">MIT6.828 Lab2</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-30 04:48:43" itemprop="dateCreated datePublished" datetime="2020-03-30T04:48:43+08:00">2020-03-30</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="before-start"><a class="markdownIt-Anchor" href="#before-start"></a> Before start</h2>
<p>以下是memlayout.h中对于虚拟地址空间布局的描述：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Virtual memory map:                                Permissions</span><br><span class="line"> *                                                    kernel/user</span><br><span class="line"> *</span><br><span class="line"> *    4 Gig --------&gt;  +------------------------------+</span><br><span class="line"> *                     |                              | RW/--</span><br><span class="line"> *                     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line"> *                     :              .               :</span><br><span class="line"> *                     :              .               :</span><br><span class="line"> *                     :              .               :</span><br><span class="line"> *                     |~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~| RW/--</span><br><span class="line"> *                     |                              | RW/--</span><br><span class="line"> *                     |   Remapped Physical Memory   | RW/--</span><br><span class="line"> *                     |                              | RW/--</span><br><span class="line"> *    KERNBASE, ----&gt;  +------------------------------+ 0xf0000000      --+</span><br><span class="line"> *    KSTACKTOP        |     CPU0&#x27;s Kernel Stack      | RW/--  KSTKSIZE   |</span><br><span class="line"> *                     | - - - - - - - - - - - - - - -|                   |</span><br><span class="line"> *                     |      Invalid Memory (*)      | --/--  KSTKGAP    |</span><br><span class="line"> *                     +------------------------------+                   |</span><br><span class="line"> *                     |     CPU1&#x27;s Kernel Stack      | RW/--  KSTKSIZE   |</span><br><span class="line"> *                     | - - - - - - - - - - - - - - -|                 PTSIZE</span><br><span class="line"> *                     |      Invalid Memory (*)      | --/--  KSTKGAP    |</span><br><span class="line"> *                     +------------------------------+                   |</span><br><span class="line"> *                     :              .               :                   |</span><br><span class="line"> *                     :              .               :                   |</span><br><span class="line"> *    MMIOLIM ------&gt;  +------------------------------+ 0xefc00000      --+</span><br><span class="line"> *                     |       Memory-mapped I/O      | RW/--  PTSIZE</span><br><span class="line"> * ULIM, MMIOBASE --&gt;  +------------------------------+ 0xef800000</span><br><span class="line"> *                     |  Cur. Page Table (User R-)   | R-/R-  PTSIZE</span><br><span class="line"> *    UVPT      ----&gt;  +------------------------------+ 0xef400000</span><br><span class="line"> *                     |          RO PAGES            | R-/R-  PTSIZE</span><br><span class="line"> *    UPAGES    ----&gt;  +------------------------------+ 0xef000000</span><br><span class="line"> *                     |           RO ENVS            | R-/R-  PTSIZE</span><br><span class="line"> * UTOP,UENVS ------&gt;  +------------------------------+ 0xeec00000</span><br><span class="line"> * UXSTACKTOP -/       |     User Exception Stack     | RW/RW  PGSIZE</span><br><span class="line"> *                     +------------------------------+ 0xeebff000</span><br><span class="line"> *                     |       Empty Memory (*)       | --/--  PGSIZE</span><br><span class="line"> *    USTACKTOP  ---&gt;  +------------------------------+ 0xeebfe000</span><br><span class="line"> *                     |      Normal User Stack       | RW/RW  PGSIZE</span><br><span class="line"> *                     +------------------------------+ 0xeebfd000</span><br><span class="line"> *                     |                              |</span><br><span class="line"> *                     |                              |</span><br><span class="line"> *                     ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br><span class="line"> *                     .                              .</span><br><span class="line"> *                     .                              .</span><br><span class="line"> *                     .                              .</span><br><span class="line"> *                     |~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~|</span><br><span class="line"> *                     |     Program Data &amp; Heap      |</span><br><span class="line"> *    UTEXT --------&gt;  +------------------------------+ 0x00800000</span><br><span class="line"> *    PFTEMP -------&gt;  |       Empty Memory (*)       |        PTSIZE</span><br><span class="line"> *                     |                              |</span><br><span class="line"> *    UTEMP --------&gt;  +------------------------------+ 0x00400000      --+</span><br><span class="line"> *                     |       Empty Memory (*)       |                   |</span><br><span class="line"> *                     | - - - - - - - - - - - - - - -|                   |</span><br><span class="line"> *                     |  User STAB Data (optional)   |                 PTSIZE</span><br><span class="line"> *    USTABDATA ----&gt;  +------------------------------+ 0x00200000        |</span><br><span class="line"> *                     |       Empty Memory (*)       |                   |</span><br><span class="line"> *    0 ------------&gt;  +------------------------------+                 --+</span><br><span class="line"> *</span><br><span class="line"> * (*) Note: The kernel ensures that &quot;Invalid Memory&quot; is *never* mapped.</span><br><span class="line"> *     &quot;Empty Memory&quot; is normally unmapped, but user programs may map pages</span><br><span class="line"> *     there if desired.  JOS user programs map pages temporarily at UTEMP.</span><br><span class="line"> */</span><br></pre></td></tr></table></figure>
<p>总体的虚拟内存布局是如上的一个状态。</p>
<p>在inc/mmu.h文件的注释中可以看到对于线性地址的结构描述如下，是按二级页表的方式进行地址转换的。前十位是一级页表的索引，中间十位是二级页表索引，最后的12位表示的是4K页面内部的偏移量。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// A linear address &#x27;la&#x27; has a three-part structure as follows:</span><br><span class="line">//</span><br><span class="line">// +--------10------+-------10-------+---------12----------+</span><br><span class="line">// | Page Directory |   Page Table   | Offset within Page  |</span><br><span class="line">// |      Index     |      Index     |                     |</span><br><span class="line">// +----------------+----------------+---------------------+</span><br><span class="line">//  \--- PDX(la) --/ \--- PTX(la) --/ \---- PGOFF(la) ----/</span><br><span class="line">//  \---------- PGNUM(la) ----------/</span><br></pre></td></tr></table></figure>
<p>在inc/memlayout.h中可以看到PageInfo的结构如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PageInfo</span> &#123;</span></span><br><span class="line">	<span class="comment">// Next page on the free list.</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">PageInfo</span> *<span class="title">pp_link</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// pp_ref is the count of pointers (usually in page table entries)</span></span><br><span class="line">	<span class="comment">// to this page, for pages allocated using page_alloc.</span></span><br><span class="line">	<span class="comment">// Pages allocated at boot time using pmap.c&#x27;s</span></span><br><span class="line">	<span class="comment">// boot_alloc do not have valid reference count fields.</span></span><br><span class="line"></span><br><span class="line">	<span class="type">uint16_t</span> pp_ref;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>其中pp_link链接的是free list当中下一个空闲的页面，而pp_ref表示的是指向该页面的指针的个数，当清零的时候说明页面就没有被指向了。在全局是利用一个PageInfo的数组来存放物理页面状态：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="class"><span class="keyword">struct</span> <span class="title">PageInfo</span> *<span class="title">pages</span>;</span></span><br></pre></td></tr></table></figure>
<p>可以发现页面是通过一个PageInfo类型进行描述，指针与pages地址的差值就是页面号，物理地址就直接是一个32-bit的整数，相互转换依照上方的三级结构进行:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">physaddr_t</span></span><br><span class="line"><span class="title function_">page2pa</span><span class="params">(<span class="keyword">struct</span> PageInfo *pp)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> (pp - pages) &lt;&lt; PGSHIFT;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> PageInfo*</span><br><span class="line"><span class="title function_">pa2page</span><span class="params">(<span class="type">physaddr_t</span> pa)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (PGNUM(pa) &gt;= npages)</span><br><span class="line">		panic(<span class="string">&quot;pa2page called with invalid pa&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> &amp;pages[PGNUM(pa)];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以以上两个函数提供了一个在page和物理地址之间进行相互转换的方式。</p>
<h2 id="exercise-1"><a class="markdownIt-Anchor" href="#exercise-1"></a> Exercise 1</h2>
<h3 id="boot_alloc"><a class="markdownIt-Anchor" href="#boot_alloc"></a> boot_alloc</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This simple physical memory allocator is used only while JOS is setting</span></span><br><span class="line"><span class="comment">// up its virtual memory system.  page_alloc() is the real allocator.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// If n&gt;0, allocates enough pages of contiguous physical memory to hold &#x27;n&#x27;</span></span><br><span class="line"><span class="comment">// bytes.  Doesn&#x27;t initialize the memory.  Returns a kernel virtual address.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// If n==0, returns the address of the next free page without allocating</span></span><br><span class="line"><span class="comment">// anything.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// If we&#x27;re out of memory, boot_alloc should panic.</span></span><br><span class="line"><span class="comment">// This function may ONLY be used during initialization,</span></span><br><span class="line"><span class="comment">// before the page_free_list list has been set up.</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *</span><br><span class="line"><span class="title function_">boot_alloc</span><span class="params">(<span class="type">uint32_t</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">static</span> <span class="type">char</span> *nextfree;	<span class="comment">// virtual address of next byte of free memory</span></span><br><span class="line">	<span class="type">char</span> *result;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Initialize nextfree if this is the first time.</span></span><br><span class="line">	<span class="comment">// &#x27;end&#x27; is a magic symbol automatically generated by the linker,</span></span><br><span class="line">	<span class="comment">// which points to the end of the kernel&#x27;s bss segment:</span></span><br><span class="line">	<span class="comment">// the first virtual address that the linker did *not* assign</span></span><br><span class="line">	<span class="comment">// to any kernel code or global variables.</span></span><br><span class="line">	<span class="keyword">if</span> (!nextfree) &#123;</span><br><span class="line">		<span class="keyword">extern</span> <span class="type">char</span> end[];</span><br><span class="line">		nextfree = ROUNDUP((<span class="type">char</span> *) end, PGSIZE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Allocate a chunk large enough to hold &#x27;n&#x27; bytes, then update</span></span><br><span class="line">	<span class="comment">// nextfree.  Make sure nextfree is kept aligned</span></span><br><span class="line">	<span class="comment">// to a multiple of PGSIZE.</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// LAB 2: Your code here.</span></span><br><span class="line">	<span class="keyword">if</span>(npages * PGSIZE &lt; (<span class="type">uint32_t</span>)(nextfree + n - KERNBASE)) <span class="comment">// out of memory</span></span><br><span class="line">		panic(<span class="string">&quot;boot_alloc: We are out of memory.\n&quot;</span>);</span><br><span class="line">	result = nextfree;</span><br><span class="line">	nextfree = ROUNDUP(nextfree + n, PGSIZE);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从34行开始为补充的代码部分，nextfree作为static变量只会初始化一次，用来表示往后第一个没有被分配的virtual address。</p>
<p>由于在注释中要求要对于对于out of memory的情况需要触发panic，所以这里在34行进行了一个分配内容是否超过物理内存限制的检查。如果一切正常的话就进行分配，采用已经定义好的ROUNDUP宏来进行页面对齐。</p>
<p>如果n为0的时候，37行代码不会产生任何改变，符合注释中所描述的代码逻辑。</p>
<h3 id="mem_init"><a class="markdownIt-Anchor" href="#mem_init"></a> mem_init</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Allocate an array of npages &#x27;struct PageInfo&#x27;s and store it in &#x27;pages&#x27;.</span></span><br><span class="line"><span class="comment">// The kernel uses this array to keep track of physical pages: for</span></span><br><span class="line"><span class="comment">// each physical page, there is a corresponding struct PageInfo in this</span></span><br><span class="line"><span class="comment">// array.  &#x27;npages&#x27; is the number of physical pages in memory.  Use memset</span></span><br><span class="line"><span class="comment">// to initialize all fields of each struct PageInfo to 0.</span></span><br><span class="line"><span class="comment">// Your code goes here:</span></span><br><span class="line"></span><br><span class="line">pages = (<span class="keyword">struct</span> PageInfo *) boot_alloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> PageInfo) * npages);</span><br><span class="line"><span class="built_in">memset</span>(pages, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> PageInfo)*npages);</span><br></pre></td></tr></table></figure>
<p>这里所需要进行的就是对于pages这样一个存储PageInfo的数组进行空间分配，并且初始化为0。首先先利用boot_alloc进行空间的分配，之后利用memset进行清零就可以了。</p>
<p>这里可以看到，pages实际上就是在页目录之后进行分配的一串物理地址。</p>
<p><img src="https://s2.loli.net/2023/01/10/RlbTjedBpP9o2QO.jpg" alt="" /></p>
<h3 id="page_init"><a class="markdownIt-Anchor" href="#page_init"></a> page_init</h3>
<p>在memlayout.h中可以看到</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// At IOPHYSMEM (640K) there is a 384K hole for I/O.  From the kernel,</span></span><br><span class="line"><span class="comment">// IOPHYSMEM can be addressed at KERNBASE + IOPHYSMEM.  The hole ends</span></span><br><span class="line"><span class="comment">// at physical address EXTPHYSMEM.</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> IOPHYSMEM	0x0A0000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EXTPHYSMEM	0x100000</span></span><br></pre></td></tr></table></figure>
<p>IOPHYSMEM对应的是640K的位置，EXTPHYSMEM对应的是1M的位置。在lab1当中内核代码就是被加载到了1M的后面，之后再之前的<code>mem_init()</code>当中，我们又在上面进行了pages的分配，当前可以使用的free空间应当是从之前分配的内容后面开始。<code>boot_alloc()</code>返回的是一个<em>kernel virtual address</em>，需要将其转换得到对应的<em>physical address</em>。</p>
<p>从pmap.h文件中可以看到从PA向KVA的转换如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* This macro takes a physical address and returns the corresponding kernel</span></span><br><span class="line"><span class="comment"> * virtual address.  It panics if you pass an invalid physical address. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> KADDR(pa) _kaddr(__FILE__, __LINE__, pa)</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span>*</span><br><span class="line">_kaddr(<span class="type">const</span> <span class="type">char</span> *file, <span class="type">int</span> line, <span class="type">physaddr_t</span> pa)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (PGNUM(pa) &gt;= npages)</span><br><span class="line">		_panic(file, line, <span class="string">&quot;KADDR called with invalid pa %08lx&quot;</span>, pa);</span><br><span class="line">	<span class="keyword">return</span> (<span class="type">void</span> *)(pa + KERNBASE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么从KVA向PA的转换只需要进行一个逆操作。</p>
<p>最后的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Initialize page structure and memory free list.</span></span><br><span class="line"><span class="comment">// After this is done, NEVER use boot_alloc again.  ONLY use the page</span></span><br><span class="line"><span class="comment">// allocator functions below to allocate and deallocate physical</span></span><br><span class="line"><span class="comment">// memory via the page_free_list.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">page_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// The example code here marks all physical pages as free.</span></span><br><span class="line">	<span class="comment">// However this is not truly the case.  What memory is free?</span></span><br><span class="line">	<span class="comment">//  1) Mark physical page 0 as in use.</span></span><br><span class="line">	<span class="comment">//     This way we preserve the real-mode IDT and BIOS structures</span></span><br><span class="line">	<span class="comment">//     in case we ever need them.  (Currently we don&#x27;t, but...)</span></span><br><span class="line">	<span class="comment">//  2) The rest of base memory, [PGSIZE, npages_basemem * PGSIZE)</span></span><br><span class="line">	<span class="comment">//     is free.</span></span><br><span class="line">	<span class="comment">//  3) Then comes the IO hole [IOPHYSMEM, EXTPHYSMEM), which must</span></span><br><span class="line">	<span class="comment">//     never be allocated.</span></span><br><span class="line">	<span class="comment">//  4) Then extended memory [EXTPHYSMEM, ...).</span></span><br><span class="line">	<span class="comment">//     Some of it is in use, some is free. Where is the kernel</span></span><br><span class="line">	<span class="comment">//     in physical memory?  Which pages are already in use for</span></span><br><span class="line">	<span class="comment">//     page tables and other data structures?</span></span><br><span class="line">	<span class="comment">//</span></span><br><span class="line">	<span class="comment">// Change the code to reflect this.</span></span><br><span class="line">	<span class="comment">// NB: DO NOT actually touch the physical memory corresponding to</span></span><br><span class="line">	<span class="comment">// free pages!</span></span><br><span class="line">	<span class="type">size_t</span> i;</span><br><span class="line">	<span class="type">uint32_t</span> pa_free_start = (<span class="type">uint32_t</span>)((<span class="type">char</span> *)boot_alloc(<span class="number">0</span>) - KERNBASE);</span><br><span class="line">	<span class="comment">// case 1:</span></span><br><span class="line">	pages[<span class="number">0</span>].pp_ref = <span class="number">1</span>;</span><br><span class="line">	pages[<span class="number">0</span>].pp_link = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="comment">// case 2, 3, 4:</span></span><br><span class="line">	<span class="keyword">for</span> (i = <span class="number">1</span>; i &lt; npages; i++) &#123;</span><br><span class="line">		<span class="keyword">if</span>(IOPHYSMEM &lt;= i * PGSIZE &amp;&amp; i * PGSIZE &lt; pa_free_start)</span><br><span class="line">		&#123;</span><br><span class="line">			pages[i].pp_ref = <span class="number">1</span>;</span><br><span class="line">			pages[i].pp_link = <span class="literal">NULL</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			pages[i].pp_ref = <span class="number">0</span>;</span><br><span class="line">			pages[i].pp_link = page_free_list;</span><br><span class="line">			page_free_list = &amp;pages[i];</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>pa_free_start表示，这个物理地址后面的空间在当前都是空闲的，所以3和4的一部分都需要被设置成已经分配的状态。剩下的内容都被设置成空闲页面，加入到page_free_list当中。</p>
<h3 id="page_alloc"><a class="markdownIt-Anchor" href="#page_alloc"></a> page_alloc</h3>
<p>这里完成的是对于页面的分配，根据alloc_flags来判断是否对于页面进行初始化。如果进行分配的话，那么就将page_free_list的头一个页面取出进行分配即可，初始化利用page2kva得到对应的地址，然后进行初始化操作。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Allocates a physical page.  If (alloc_flags &amp; ALLOC_ZERO), fills the entire</span></span><br><span class="line"><span class="comment">// returned physical page with &#x27;\0&#x27; bytes.  Does NOT increment the reference</span></span><br><span class="line"><span class="comment">// count of the page - the caller must do these if necessary (either explicitly</span></span><br><span class="line"><span class="comment">// or via page_insert).</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Be sure to set the pp_link field of the allocated page to NULL so</span></span><br><span class="line"><span class="comment">// page_free can check for double-free bugs.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Returns NULL if out of free memory.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Hint: use page2kva and memset</span></span><br><span class="line"><span class="keyword">struct</span> PageInfo *</span><br><span class="line"><span class="title function_">page_alloc</span><span class="params">(<span class="type">int</span> alloc_flags)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// Fill this function in</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">PageInfo</span>* <span class="title">alloc_page</span> =</span> page_free_list;</span><br><span class="line">	<span class="keyword">if</span>(alloc_page == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	page_free_list = alloc_page-&gt;pp_link;</span><br><span class="line">	alloc_page-&gt;pp_link = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">if</span>(alloc_flags &amp;&amp; ALLOC_ZERO)</span><br><span class="line">		<span class="built_in">memset</span>(page2kva(alloc_page), <span class="number">0</span>, PGSIZE);</span><br><span class="line">	<span class="keyword">return</span> alloc_page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="page_free"><a class="markdownIt-Anchor" href="#page_free"></a> page_free</h3>
<p>这里做的操作是释放页面，将页面插入page_free_list的头部就可以，但是首先需要检查是否pp_ref为0且pp_link为_NULL，前者不为0表示对于仍在使用的页面进行了释放的操作，后者不为NULL说明它本身就已经是被释放的页面，进行了double free的操作，都要触发panic。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Return a page to the free list.</span></span><br><span class="line"><span class="comment">// (This function should only be called when pp-&gt;pp_ref reaches 0.)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">page_free</span><span class="params">(<span class="keyword">struct</span> PageInfo *pp)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// Fill this function in</span></span><br><span class="line">	<span class="comment">// Hint: You may want to panic if pp-&gt;pp_ref is nonzero or</span></span><br><span class="line">	<span class="comment">// pp-&gt;pp_link is not NULL.</span></span><br><span class="line">	<span class="keyword">if</span>(pp-&gt;pp_ref != <span class="number">0</span> || pp-&gt;pp_link != <span class="literal">NULL</span>)</span><br><span class="line">		panic(<span class="string">&quot;page_free: pp_ref or pp_link is not zero!\n&quot;</span>);</span><br><span class="line">	pp-&gt;pp_link = page_free_list;</span><br><span class="line">	page_free_list = pp;</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到这里可以得到如下的输出内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">check_page_free_list() succeeded!</span><br><span class="line">check_page_alloc() succeeded!</span><br></pre></td></tr></table></figure>
<p>说明关于page_free_list的维护和page_alloc的操作都没有问题。</p>
<h2 id="exercise-2"><a class="markdownIt-Anchor" href="#exercise-2"></a> Exercise 2</h2>
<p>主要是关于Intel 80386手册的描述，其中第五章主要是对分段机制的描述，第六章是对分页机制的描述。由于在JOS当中将整个空间看做一个段，所以段偏移量就是线性地址，只需要明白关于分页机制以及对应的线性地址转换到物理地址的过程就好。</p>
<h2 id="exercise-3"><a class="markdownIt-Anchor" href="#exercise-3"></a> Exercise 3</h2>
<p>主要是GDB和QEMU命令的熟悉。</p>
<h2 id="exercise-4"><a class="markdownIt-Anchor" href="#exercise-4"></a> Exercise 4</h2>
<h3 id="pgdir_walk"><a class="markdownIt-Anchor" href="#pgdir_walk"></a> pgdir_walk</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Given &#x27;pgdir&#x27;, a pointer to a page directory, pgdir_walk returns</span></span><br><span class="line"><span class="comment">// a pointer to the page table entry (PTE) for linear address &#x27;va&#x27;.</span></span><br><span class="line"><span class="comment">// This requires walking the two-level page table structure.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// The relevant page table page might not exist yet.</span></span><br><span class="line"><span class="comment">// If this is true, and create == false, then pgdir_walk returns NULL.</span></span><br><span class="line"><span class="comment">// Otherwise, pgdir_walk allocates a new page table page with page_alloc.</span></span><br><span class="line"><span class="comment">//    - If the allocation fails, pgdir_walk returns NULL.</span></span><br><span class="line"><span class="comment">//    - Otherwise, the new page&#x27;s reference count is incremented,</span></span><br><span class="line"><span class="comment">//	the page is cleared,</span></span><br><span class="line"><span class="comment">//	and pgdir_walk returns a pointer into the new page table page.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Hint 1: you can turn a PageInfo * into the physical address of the</span></span><br><span class="line"><span class="comment">// page it refers to with page2pa() from kern/pmap.h.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Hint 2: the x86 MMU checks permission bits in both the page directory</span></span><br><span class="line"><span class="comment">// and the page table, so it&#x27;s safe to leave permissions in the page</span></span><br><span class="line"><span class="comment">// directory more permissive than strictly necessary.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Hint 3: look at inc/mmu.h for useful macros that manipulate page</span></span><br><span class="line"><span class="comment">// table and page directory entries.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">pte_t</span> *</span><br><span class="line"><span class="title function_">pgdir_walk</span><span class="params">(<span class="type">pde_t</span> *pgdir, <span class="type">const</span> <span class="type">void</span> *va, <span class="type">int</span> create)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// Fill this function in</span></span><br><span class="line">	<span class="type">uint32_t</span> pdx = PDX(va);</span><br><span class="line">	<span class="type">uint32_t</span> ptx = PTX(va);</span><br><span class="line">	<span class="keyword">if</span>(pgdir[pdx] == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(create)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">PageInfo</span>* <span class="title">newpte</span> =</span> page_alloc(<span class="number">1</span>);</span><br><span class="line">			<span class="keyword">if</span>(newpte == <span class="literal">NULL</span>)</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">			++(newpte-&gt;pp_ref);</span><br><span class="line">			pgdir[pdx] = page2pa(newpte) | PTE_P | PTE_W | PTE_U;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">physaddr_t</span> pte = PTE_ADDR(pgdir[pdx]) | (ptx &lt;&lt; <span class="number">2</span>);</span><br><span class="line">	<span class="keyword">return</span> KADDR(pte);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>pgdir_walk()</code>函数做的内容实际上是通过虚拟地址va来进行一个地址翻译，找到所对应的pte。这里传入的三个参数，pgdir是一个指向页目录基址的指针，va是要进行翻译的虚拟地址，create是一个标志，如果非0说明对于对应的va不存在pte的话需要进行分配。</p>
<p>那么首先检查就是页目录中对应的页表到底存在不存在，如果存在的话，直接取出然后进行pte的计算。那么如果不存在的话，就需要page_alloc来分配一个物理页面用来存储页表，并且将该物理页面的引用添加，之后由于关于权限的确认在后面的pte项当中也会进行，所以这里关于页表就可以直接提供全部的权限，将其填入对应的页目录的项中。</p>
<p>那创建了页表之后，就如同之前一样进行进一步的地址转换。但是由于这里物理地址是不能直接进行解引用操作的，所以利用<code>KADDR</code>宏将得到的物理地址转换成remap过的虚拟地址，这样可以通过解引用来获得对应的物理地址也能对于所存储的内容进行修改。</p>
<h3 id="boot_map_region"><a class="markdownIt-Anchor" href="#boot_map_region"></a> boot_map_region</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Map [va, va+size) of virtual address space to physical [pa, pa+size)</span></span><br><span class="line"><span class="comment">// in the page table rooted at pgdir.  Size is a multiple of PGSIZE, and</span></span><br><span class="line"><span class="comment">// va and pa are both page-aligned.</span></span><br><span class="line"><span class="comment">// Use permission bits perm|PTE_P for the entries.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This function is only intended to set up the ``static&#x27;&#x27; mappings</span></span><br><span class="line"><span class="comment">// above UTOP. As such, it should *not* change the pp_ref field on the</span></span><br><span class="line"><span class="comment">// mapped pages.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Hint: the TA solution uses pgdir_walk</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">boot_map_region</span><span class="params">(<span class="type">pde_t</span> *pgdir, <span class="type">uintptr_t</span> va, <span class="type">size_t</span> size, <span class="type">physaddr_t</span> pa, <span class="type">int</span> perm)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// Fill this function in</span></span><br><span class="line">	<span class="keyword">while</span>(size &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">pte_t</span>* pte = pgdir_walk(pgdir, (<span class="type">void</span> *)va, <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">if</span>(pte == <span class="literal">NULL</span>)</span><br><span class="line">			panic(<span class="string">&quot;boot_map_region: Fail to alloc new page, run out of memory!\n&quot;</span>);</span><br><span class="line">		*pte = pa | perm | PTE_P;</span><br><span class="line">		size -= PGSIZE;</span><br><span class="line">		va += PGSIZE, pa += PGSIZE;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这个函数的作用是将一串连续的虚拟地址映射到一串连续的物理地址，其中映射的地址的大小是页面大小的整数倍。那么可以知道，直接的想法就是通过虚拟地址进行地址查询，然后将页表中对应的表项修改为映射到的物理地址就可以了。那么以每个页面单位来进行这样的操作。</p>
<p>首先通过<code>pgdir_walk()</code>来找到虚拟地址对应的表项，如果对应的二级页表不存在那么就进行空间的分配，如果分配失败则进行报错，出发一个panic。</p>
<p>之后就将物理地址以及对应的权限填到表项里面，然后对下一个需要映射的页进行相同的操作。</p>
<h3 id="page_lookup"><a class="markdownIt-Anchor" href="#page_lookup"></a> page_lookup</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Return the page mapped at virtual address &#x27;va&#x27;.</span></span><br><span class="line"><span class="comment">// If pte_store is not zero, then we store in it the address</span></span><br><span class="line"><span class="comment">// of the pte for this page.  This is used by page_remove and</span></span><br><span class="line"><span class="comment">// can be used to verify page permissions for syscall arguments,</span></span><br><span class="line"><span class="comment">// but should not be used by most callers.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Return NULL if there is no page mapped at va.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Hint: the TA solution uses pgdir_walk and pa2page.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">struct</span> PageInfo *</span><br><span class="line"><span class="title function_">page_lookup</span><span class="params">(<span class="type">pde_t</span> *pgdir, <span class="type">void</span> *va, <span class="type">pte_t</span> **pte_store)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// Fill this function in</span></span><br><span class="line">	<span class="type">pte_t</span>* pte = pgdir_walk(pgdir, va, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span>(pte == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="type">physaddr_t</span> pa = PTE_ADDR(*pte);</span><br><span class="line">	<span class="keyword">if</span>(pte_store)</span><br><span class="line">		*pte_store = pte;</span><br><span class="line">	<span class="keyword">return</span> pa2page(pa);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个地方的<code>page_lookup()</code>想要做的是通过虚拟地址va来查找对应的映射页的PageInfo结构，这边的操作就是首先去找pte，如果找到说明该虚拟地址被映射到了一个页面，得到映射页面的物理页面首地址，再通过<code>pa2page()</code>完成转换。那么如果没有找到的话，说明这个虚拟地址并没有映射到任何物理页面。如果传入的pte_store非空的话，就将其进行保存。</p>
<h3 id="page_remove"><a class="markdownIt-Anchor" href="#page_remove"></a> page_remove</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Unmaps the physical page at virtual address &#x27;va&#x27;.</span></span><br><span class="line"><span class="comment">// If there is no physical page at that address, silently does nothing.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Details:</span></span><br><span class="line"><span class="comment">//   - The ref count on the physical page should decrement.</span></span><br><span class="line"><span class="comment">//   - The physical page should be freed if the refcount reaches 0.</span></span><br><span class="line"><span class="comment">//   - The pg table entry corresponding to &#x27;va&#x27; should be set to 0.</span></span><br><span class="line"><span class="comment">//     (if such a PTE exists)</span></span><br><span class="line"><span class="comment">//   - The TLB must be invalidated if you remove an entry from</span></span><br><span class="line"><span class="comment">//     the page table.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Hint: The TA solution is implemented using page_lookup,</span></span><br><span class="line"><span class="comment">// 	tlb_invalidate, and page_decref.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">page_remove</span><span class="params">(<span class="type">pde_t</span> *pgdir, <span class="type">void</span> *va)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// Fill this function in</span></span><br><span class="line">	<span class="type">pte_t</span>* pte_store;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">PageInfo</span>* <span class="title">pp</span> =</span> page_lookup(pgdir, va, &amp;pte_store);</span><br><span class="line">	<span class="keyword">if</span>(pp == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	*pte_store = <span class="number">0</span>;</span><br><span class="line">	page_decref(pp);</span><br><span class="line">	tlb_invalidate(pgdir, va);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>page_remove()</code>所做的操作是将va映射到的物理页面给取消映射。要完成remove的操作需要做两件事情，一个就是将页表项中的对应内容给修改，另外一个就是对于PageInfo结构的修改，需要将其引用数减少，如果引用数为0，那么就将其加入空闲链表。在25行处的<code>page_decref()</code>函数做的实际上就是上述这个减少引用的操作。</p>
<p>那么一开始利用<code>page_lookup()</code>来找到对应的页面和pte，在24行修改pte，在25行修改链表结构，在26行调用<code>tlb_invalidate()</code>函数把TLB里面的内容给标注为无效。</p>
<h3 id="page_insert"><a class="markdownIt-Anchor" href="#page_insert"></a> page_insert</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Map the physical page &#x27;pp&#x27; at virtual address &#x27;va&#x27;.</span></span><br><span class="line"><span class="comment">// The permissions (the low 12 bits) of the page table entry</span></span><br><span class="line"><span class="comment">// should be set to &#x27;perm|PTE_P&#x27;.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Requirements</span></span><br><span class="line"><span class="comment">//   - If there is already a page mapped at &#x27;va&#x27;, it should be page_remove()d.</span></span><br><span class="line"><span class="comment">//   - If necessary, on demand, a page table should be allocated and inserted</span></span><br><span class="line"><span class="comment">//     into &#x27;pgdir&#x27;.</span></span><br><span class="line"><span class="comment">//   - pp-&gt;pp_ref should be incremented if the insertion succeeds.</span></span><br><span class="line"><span class="comment">//   - The TLB must be invalidated if a page was formerly present at &#x27;va&#x27;.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Corner-case hint: Make sure to consider what happens when the same</span></span><br><span class="line"><span class="comment">// pp is re-inserted at the same virtual address in the same pgdir.</span></span><br><span class="line"><span class="comment">// However, try not to distinguish this case in your code, as this</span></span><br><span class="line"><span class="comment">// frequently leads to subtle bugs; there&#x27;s an elegant way to handle</span></span><br><span class="line"><span class="comment">// everything in one code path.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// RETURNS:</span></span><br><span class="line"><span class="comment">//   0 on success</span></span><br><span class="line"><span class="comment">//   -E_NO_MEM, if page table couldn&#x27;t be allocated</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Hint: The TA solution is implemented using pgdir_walk, page_remove,</span></span><br><span class="line"><span class="comment">// and page2pa.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">page_insert</span><span class="params">(<span class="type">pde_t</span> *pgdir, <span class="keyword">struct</span> PageInfo *pp, <span class="type">void</span> *va, <span class="type">int</span> perm)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// Fill this function in</span></span><br><span class="line">	<span class="type">pte_t</span>* pte = pgdir_walk(pgdir, va, <span class="number">1</span>);</span><br><span class="line">	<span class="keyword">if</span>(pte == <span class="literal">NULL</span>)</span><br><span class="line">		<span class="keyword">return</span> -E_NO_MEM;</span><br><span class="line">	<span class="type">physaddr_t</span> pa = page2pa(pp);</span><br><span class="line">	++(pp-&gt;pp_ref);</span><br><span class="line">	<span class="keyword">if</span>(*pte)</span><br><span class="line">		page_remove(pgdir, va);</span><br><span class="line">	*pte = pa | perm | PTE_P;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>page_insert()</code>的操作就是将va映射到pp所指向的物理页面上去，而对应的权限通过perm来进行表示。那么利用<code>pgdir_walk()</code>函数来获得pte, 如果没有就进行创建。那么这个情况下如果返回为NULL，只有可能是空间不足无法创建，于是返回-E_NO_MEM。那么如果能够得到pte，就对于对应的物理页面进行处理，添加引用数，然后把本来pte可能存在的映射关系给消除，之后再进行映射。</p>
<p>这里存在的一个问题是，如果我这里提供的pp本来就是va映射的对象，可能会出现问题。考虑将34行进行引用数增加的内容移到36行后面，那么他首先进行了page_remove。如果之前的引用数为1，那这个页面将被加入空闲链表。而之后再给他加了一个引用数，这就相当于空闲链表中存在着不空闲的页面，他可能会被二次分配。存在一个bug。而将该语句保存在34行的位置，就可以确保remove之后，如果本来就是va映射的页面，也不会被加入到空闲链表中，规避了之前所说的那种bug的出现。</p>
<h2 id="exercise-5"><a class="markdownIt-Anchor" href="#exercise-5"></a> Exercise 5</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Map &#x27;pages&#x27; read-only by the user at linear address UPAGES</span></span><br><span class="line"><span class="comment">// Permissions:</span></span><br><span class="line"><span class="comment">//    - the new image at UPAGES -- kernel R, user R</span></span><br><span class="line"><span class="comment">//      (ie. perm = PTE_U | PTE_P)</span></span><br><span class="line"><span class="comment">//    - pages itself -- kernel RW, user NONE</span></span><br><span class="line"><span class="comment">// Your code goes here:</span></span><br><span class="line">n = ROUNDUP(npages*<span class="keyword">sizeof</span>(<span class="keyword">struct</span> PageInfo), PGSIZE);</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; n; i += PGSIZE)</span><br><span class="line">	page_insert(kern_pgdir, pa2page(PADDR(pages) + i), (<span class="type">void</span> *)(UPAGES + i), PTE_U | PTE_P);</span><br></pre></td></tr></table></figure>
<p>这里是要将pages个映射到UPAGES以上的内容，那么这里要考虑到pages这整个内容实际上是对应着许多PageInfo结构的，在进行映射的同时需要对于PageInfo内部的引用数进行修改，这里采用一个for循环将所有页面依次进行映射。权限位由于在注释中说明，需要内核和用户都可读，所以标注成PTE_U|PTE_P。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Use the physical memory that &#x27;bootstack&#x27; refers to as the kernel</span></span><br><span class="line"><span class="comment">// stack.  The kernel stack grows down from virtual address KSTACKTOP.</span></span><br><span class="line"><span class="comment">// We consider the entire range from [KSTACKTOP-PTSIZE, KSTACKTOP)</span></span><br><span class="line"><span class="comment">// to be the kernel stack, but break this into two pieces:</span></span><br><span class="line"><span class="comment">//     * [KSTACKTOP-KSTKSIZE, KSTACKTOP) -- backed by physical memory</span></span><br><span class="line"><span class="comment">//     * [KSTACKTOP-PTSIZE, KSTACKTOP-KSTKSIZE) -- not backed; so if</span></span><br><span class="line"><span class="comment">//       the kernel overflows its stack, it will fault rather than</span></span><br><span class="line"><span class="comment">//       overwrite memory.  Known as a &quot;guard page&quot;.</span></span><br><span class="line"><span class="comment">//     Permissions: kernel RW, user NONE</span></span><br><span class="line"><span class="comment">// Your code goes here:</span></span><br><span class="line">boot_map_region(kern_pgdir, KSTACKTOP - KSTKSIZE, KSTKSIZE, PADDR(bootstack), PTE_W);</span><br></pre></td></tr></table></figure>
<p>这里进行的是一个连续地址的映射，完成的是内核栈的一个映射。这个地方被划分成了<code>[KSTACKTOP-KSTKSIZE, KSTACKTOP)</code>和<code>[KSTACKTOP-PTSIZE, KSTACKTOP-KSTKSIZE)</code>两个部分，通过注释内容可以知道，前一段是需要映射到物理地址的，后一段是不需要的。所以我们要做的只是将前一段进行映射。这里bootstack是已经知道的，通过PADDR将其转换为物理地址，然后映射以KSTACKTOP-KSTKSIZE为起点，KSTKSIZE大小的内容。权限由于在<code>boot_map_region()</code>当中会自动加上PTE_P，所以这里只要标注PTE_W。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Map all of physical memory at KERNBASE.</span></span><br><span class="line"><span class="comment">// Ie.  the VA range [KERNBASE, 2^32) should map to</span></span><br><span class="line"><span class="comment">//      the PA range [0, 2^32 - KERNBASE)</span></span><br><span class="line"><span class="comment">// We might not have 2^32 - KERNBASE bytes of physical memory, but</span></span><br><span class="line"><span class="comment">// we just set up the mapping anyway.</span></span><br><span class="line"><span class="comment">// Permissions: kernel RW, user NONE</span></span><br><span class="line"><span class="comment">// Your code goes here:</span></span><br><span class="line"><span class="comment">//cprintf(&quot;kernbase: %x 2^32-kernbase: %x&quot;, KERNBASE, (~KERNBASE)+1);</span></span><br><span class="line">boot_map_region(kern_pgdir, KERNBASE, (~KERNBASE) + <span class="number">1</span>, <span class="number">0</span>, PTE_W);</span><br></pre></td></tr></table></figure>
<p>同样的是一个进行简单的连续地址映射的操作，那么这个地方也是采用<code>boot_map_region()</code>来进行，但是这里需要得到2^32，而32位大小是表示不出这么大的数的，所以这里采用<code>(~KERNBASE)+1</code>来得到需要进行映射的大小。这里的权限同样由于<code>boot_map_region()</code>会自动加上PTE_P，所以只需要标注PTE_W就可以了。</p>
<p>到这里为止，通过执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make grade</span><br></pre></td></tr></table></figure>
<p>可以得到如下的结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">running JOS: (2.8s)</span><br><span class="line">  Physical page allocator: OK</span><br><span class="line">  Page management: OK</span><br><span class="line">  Kernel page directory: OK</span><br><span class="line">  Page management 2: OK</span><br><span class="line">Score: 70/70</span><br></pre></td></tr></table></figure>
<p>说明已经满足所有check函数的需求，完成了虚拟内存系统的一个初始化。</p>
<h2 id="questions"><a class="markdownIt-Anchor" href="#questions"></a> Questions：</h2>
<ul>
<li></li>
</ul>
<p><img src="https://s2.loli.net/2023/01/10/AEWDsbFePZNw8Mq.jpg" alt="" /></p>
<p>这里的value应当是一个虚拟地址，在程序里面，并不能直接对于物理地址进行操控，所有的指针都应当是虚拟地址。</p>
<p>这里需要注意的是：JOS将从0开始的所有物理内存映射到虚拟地址0xf0000000就是为了让内核能够读写只知道物理地址的内容。那么为了完成从物理地址到虚拟地址的转换，对于只知道物理地址的，就将其物理地址加上0xf0000000，就可以得到对应的虚拟地址了。利用定义好的宏<code>KADDA(pa)</code>可以做到，而宏<code>PADDA(va)</code>就是这个的逆操作。在Exercise4当中这两个宏能够有效地进行虚拟地址物理地址之间的转换，从而使的解引用等操作可以进行执行。</p>
<ul>
<li>表格如下：</li>
</ul>
<table>
<thead>
<tr>
<th>Entry</th>
<th>Base Virtual Address</th>
<th>Points to (logically)</th>
</tr>
</thead>
<tbody>
<tr>
<td>960</td>
<td>0xf0000000</td>
<td>以上映射到物理地址从0开始的位置</td>
</tr>
<tr>
<td>959</td>
<td>0xefff8000</td>
<td>内核栈</td>
</tr>
<tr>
<td>958</td>
<td>0xef800000</td>
<td>页表（UVPT）</td>
</tr>
<tr>
<td>957</td>
<td>0xef400000</td>
<td>pages数组（UPAGES）</td>
</tr>
<tr>
<td>.</td>
<td>.</td>
<td>.</td>
</tr>
<tr>
<td>0</td>
<td>0x00000000</td>
<td>[see next question]</td>
</tr>
</tbody>
</table>
<ul>
<li>We have placed the kernel and user environment in the same address space. Why will user programs not be able to read or write the kernel’s memory? What specific mechanisms protect the kernel memory?</li>
</ul>
<p>因为在表项中存在权限为，只有PTE_U被设置成1的时候才可以让user访问，kernel memory只需要修改权限为就可以不被user读写。</p>
<ul>
<li>What is the maximum amount of physical memory that this operating system can support? Why?</li>
</ul>
<p>在kern/pmap.c中的<code>mem_init()</code>函数中可以看到将pages数组映射到了线性地址的UPAGES上方。那么在inc/memlayout.h的图中可以看到，给只读的pages数组分配的空间为4M大小（一个PTSIZE）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">*    UVPT      ----&gt;  +------------------------------+ 0xef400000</span><br><span class="line">*                     |          RO PAGES            | R-/R-  PTSIZE</span><br><span class="line">*    UPAGES    ----&gt;  +------------------------------+ 0xef000000</span><br></pre></td></tr></table></figure>
<p>一个PageInfo的大小是8Byte，一个页面的大小是4K。所以可以得到4M的pages数组对应的物理内存大小是：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mfrac><mrow><mn>4</mn><mo>∗</mo><msup><mn>2</mn><mrow><mn>2</mn><mn>0</mn></mrow></msup></mrow><mrow><mn>8</mn></mrow></mfrac><mo>∗</mo><mn>4</mn><mo>∗</mo><msup><mn>2</mn><mrow><mn>1</mn><mn>0</mn></mrow></msup><mo>=</mo><mn>2</mn><mo>∗</mo><msup><mn>2</mn><mrow><mn>3</mn><mn>0</mn></mrow></msup></mrow><annotation encoding="application/x-tex">\frac{4*2^{20}}{8}*4*2^{10} = 2*2^{30}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.491108em;"></span><span class="strut bottom" style="height:2.177108em;vertical-align:-0.686em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.686em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord mathrm">8</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord mathrm">4</span><span class="mbin">∗</span><span class="mord"><span class="mord mathrm">2</span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathrm">2</span><span class="mord mathrm">0</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mbin">∗</span><span class="mord mathrm">4</span><span class="mbin">∗</span><span class="mord"><span class="mord mathrm">2</span><span class="vlist"><span style="top:-0.413em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathrm">1</span><span class="mord mathrm">0</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord mathrm">2</span><span class="mbin">∗</span><span class="mord"><span class="mord mathrm">2</span><span class="vlist"><span style="top:-0.413em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathrm">3</span><span class="mord mathrm">0</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span></span></p>
<p>即操作系统能够支持的物理内存大小不会超过2G，理由如上。</p>
<ul>
<li>How much space overhead is there for managing memory, if we actually had the maximum amount of physical memory? How is this overhead broken down?</li>
</ul>
<p>如果所有虚拟地址都被映射的话，那么页表的开销，一级页表需要1个page，二级页表需要1024个page。总共需要1025个page。所以页表上的开销为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><mn>0</mn><mn>2</mn><mn>5</mn><mo>∗</mo><mn>4</mn><mo>=</mo><mn>4</mn><mn>1</mn><mn>0</mn><mn>0</mn><mi>K</mi><mi>B</mi></mrow><annotation encoding="application/x-tex">1025*4=4100KB</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mathrm">2</span><span class="mord mathrm">5</span><span class="mbin">∗</span><span class="mord mathrm">4</span><span class="mrel">=</span><span class="mord mathrm">4</span><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mathrm">0</span><span class="mord mathit" style="margin-right:0.07153em;">K</span><span class="mord mathit" style="margin-right:0.05017em;">B</span></span></span></span>。</p>
<p>采用大页可以减少开销，这样只需要一级页表就可以进行索引，需要一个page也就是4KB就可以了。</p>
<ul>
<li>Revisit the page table setup in kern/entry.S and kern/entrypgdir.c. Immediately after we turn on paging, EIP is still a low number (a little over 1MB). At what point do we transition to running at an EIP above KERNBASE? What makes it possible for us to continue executing at a low EIP between when we enable paging and when we begin running at an EIP above KERNBASE? Why is this transition necessary?</li>
</ul>
<p>在27行处利用<code>jmp	*%eax</code>进行了跳转，完成了在高地址执行的转换。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">.globl entry</span><br><span class="line">entry:</span><br><span class="line">	movw	$<span class="number">0x1234</span>,<span class="number">0x472</span>			<span class="meta"># warm boot</span></span><br><span class="line"></span><br><span class="line">	# We haven<span class="number">&#x27;</span>t <span class="built_in">set</span> up virtual memory yet, so we<span class="number">&#x27;</span>re running from</span><br><span class="line">	<span class="meta"># the physical address the boot loader loaded the kernel at: 1MB</span></span><br><span class="line">	# (plus a few bytes).  However, the C code is linked to run at</span><br><span class="line">	# KERNBASE+<span class="number">1</span>MB.  Hence, we <span class="built_in">set</span> up a trivial page directory that</span><br><span class="line">	<span class="meta"># translates virtual addresses [KERNBASE, KERNBASE+4MB) to</span></span><br><span class="line">	<span class="meta"># physical addresses [0, 4MB).  This 4MB region will be</span></span><br><span class="line">	<span class="meta"># sufficient until we set up our real page table in mem_init</span></span><br><span class="line">	<span class="meta"># in lab 2.</span></span><br><span class="line"></span><br><span class="line">	# Load the physical address of entry_pgdir into cr3.  entry_pgdir</span><br><span class="line">	<span class="meta"># is defined in entrypgdir.c.</span></span><br><span class="line">	movl	$(RELOC(entry_pgdir)), %eax</span><br><span class="line">	movl	%eax, %cr3</span><br><span class="line">	# Turn on paging.</span><br><span class="line">	movl	%cr0, %eax</span><br><span class="line">	orl	$(CR0_PE|CR0_PG|CR0_WP), %eax</span><br><span class="line">	movl	%eax, %cr0</span><br><span class="line"></span><br><span class="line">	# Now paging is enabled, but we<span class="number">&#x27;</span>re still running at a low EIP</span><br><span class="line">	# (why is this okay?).  Jump up above KERNBASE before entering</span><br><span class="line">	# C code.</span><br><span class="line">	mov	$relocated, %eax</span><br><span class="line">	jmp	*%eax</span><br><span class="line">relocated:</span><br><span class="line"></span><br><span class="line">	# Clear the frame pointer <span class="title function_">register</span> <span class="params">(EBP)</span></span><br><span class="line">	<span class="meta"># so that once we get into debugging C code,</span></span><br><span class="line">	<span class="meta"># stack backtraces will be terminated properly.</span></span><br><span class="line">	movl	$0x0,%ebp			<span class="meta"># nuke frame pointer</span></span><br><span class="line"></span><br><span class="line">	# Set the <span class="built_in">stack</span> pointer</span><br><span class="line">	movl	$<span class="params">(bootstacktop)</span>,%esp</span><br><span class="line"></span><br><span class="line">	<span class="meta"># now to C code</span></span><br><span class="line">	call	i386_init</span><br></pre></td></tr></table></figure>
<p>同时在低EIP和高EIP访问的原因是，我们将虚拟地址的[0, 4MB)和[KERNBASE, KERNBASE+4MB)都映射到了物理地址的[0, 4MB)，所以无论从低地址还是高地址都可以进行访问。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">__attribute__((__aligned__(PGSIZE)))</span><br><span class="line"><span class="type">pde_t</span> entry_pgdir[NPDENTRIES] = &#123;</span><br><span class="line">	<span class="comment">// Map VA&#x27;s [0, 4MB) to PA&#x27;s [0, 4MB)</span></span><br><span class="line">	[<span class="number">0</span>]</span><br><span class="line">		= ((<span class="type">uintptr_t</span>)entry_pgtable - KERNBASE) + PTE_P,</span><br><span class="line">	<span class="comment">// Map VA&#x27;s [KERNBASE, KERNBASE+4MB) to PA&#x27;s [0, 4MB)</span></span><br><span class="line">	[KERNBASE&gt;&gt;PDXSHIFT]</span><br><span class="line">		= ((<span class="type">uintptr_t</span>)entry_pgtable - KERNBASE) + PTE_P + PTE_W</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>从前面的内容可以看到，他在完成分页之后还有在低地址执行的语句，如果不同时将高地址和低地址都映射到物理地址的最低4M的话，那么在低地址运行的代码会出错。</p>
<h2 id="challenge"><a class="markdownIt-Anchor" href="#challenge"></a> Challenge</h2>
<p>可以在inc/mmu.h当中找到关于PTE/PDE flag的描述，具体内容如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Page table/directory entry flags.</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_P		0x001	<span class="comment">// Present</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_W		0x002	<span class="comment">// Writeable</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_U		0x004	<span class="comment">// User</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_PWT		0x008	<span class="comment">// Write-Through</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_PCD		0x010	<span class="comment">// Cache-Disable</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_A		0x020	<span class="comment">// Accessed</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_D		0x040	<span class="comment">// Dirty</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_PS		0x080	<span class="comment">// Page Size</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_G		0x100	<span class="comment">// Global</span></span></span><br></pre></td></tr></table></figure>
<p>第九行所示的就是PTE_PS位，是用来调整Page Size大小的。</p>
<p>采用大页只有一级页表，对应的地址翻译方式如下：</p>
<img src="https://s2.loli.net/2023/01/10/yLHc5X9f4QURwvD.jpg" alt="image-20200310182755807" style="zoom:50%;" />
<p>通过Intel IA32手册3.6.1节关于Page Option的描述可以知道，需要开启cr4里面的PSE标志位，来说明提供对于大页的支持，在<code>mem_init()</code>当中添加如下代码进行实现：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Set CR4_PSE</span></span><br><span class="line">cr4 = rcr4();</span><br><span class="line">cr4 |= CR4_PSE;</span><br><span class="line">lcr4(cr4);</span><br></pre></td></tr></table></figure>
<p>考虑到lab整体要对于这种大小页混合的方式进行适配的话，需要对于页面相关的许多函数进行重写。所以这里只考虑虚拟地址高256M到物理地址低256M的映射采用大页实现，只对于boot_map_region及其相关函数进行修改。</p>
<p>修改<code>pgdir_walk()</code>函数如下，其中normal状态是针对仅存在4K大小页的情况，而ex表示的是大小页混合状态的情况：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">pte_t</span> *</span><br><span class="line"><span class="title function_">pgdir_walk_normal</span><span class="params">(<span class="type">pde_t</span> *pgdir, <span class="type">const</span> <span class="type">void</span> *va, <span class="type">int</span> create)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// Fill this function in</span></span><br><span class="line">	<span class="type">uint32_t</span> pdx = PDX(va);</span><br><span class="line">	<span class="type">uint32_t</span> ptx = PTX(va);</span><br><span class="line">	<span class="keyword">if</span>(pgdir[pdx] == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(create)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">PageInfo</span>* <span class="title">newpte</span> =</span> page_alloc(<span class="number">1</span>);</span><br><span class="line">			<span class="keyword">if</span>(newpte == <span class="literal">NULL</span>)</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">			++(newpte-&gt;pp_ref);</span><br><span class="line">			pgdir[pdx] = page2pa(newpte) | PTE_P | PTE_W | PTE_U;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">physaddr_t</span> pte = PTE_ADDR(pgdir[pdx]) | (ptx &lt;&lt; <span class="number">2</span>);</span><br><span class="line">	<span class="keyword">return</span> KADDR(pte);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">pte_t</span> *</span><br><span class="line"><span class="title function_">pgdir_walk_ex</span><span class="params">(<span class="type">pde_t</span> *pgdir, <span class="type">const</span> <span class="type">void</span> *va, <span class="type">int</span> create)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">uint32_t</span> pdx = PDX(va);</span><br><span class="line">	<span class="keyword">if</span>(pgdir[pdx] == <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(create == <span class="number">1</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">PageInfo</span>* <span class="title">newpte</span> =</span> page_alloc(<span class="number">1</span>);</span><br><span class="line">			<span class="keyword">if</span>(newpte == <span class="literal">NULL</span>)</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">			++(newpte-&gt;pp_ref);</span><br><span class="line">			pgdir[pdx] = page2pa(newpte) | PTE_P | PTE_W | PTE_U;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span>(create == <span class="number">2</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			pgdir[pdx] = PTE_PS;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(create == <span class="number">2</span> &amp;&amp; (!(pgdir[pdx] &amp; PTE_PS)))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">struct</span> PageInfo * pp = pa2page(PTE_ADDR(pgdir[pdx]));</span><br><span class="line">		page_decref(pp);</span><br><span class="line">		tlb_invalidate(pgdir, (<span class="type">void</span>*)va);</span><br><span class="line">		pgdir[pdx] = PTE_PS;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">uint32_t</span> pde = pgdir[pdx];</span><br><span class="line">	<span class="keyword">if</span>(pde &amp; PTE_PS)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> pgdir + pdx;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> KADDR(PTE_ADDR(pgdir[pdx]) | (PTX(va) &lt;&lt; <span class="number">2</span>));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">pte_t</span> *</span><br><span class="line"><span class="title function_">pgdir_walk</span><span class="params">(<span class="type">pde_t</span> *pgdir, <span class="type">const</span> <span class="type">void</span> *va, <span class="type">int</span> create)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">uint32_t</span> size_ex = rcr4() &amp; CR4_PSE;</span><br><span class="line">	<span class="keyword">if</span>(size_ex)</span><br><span class="line">		<span class="keyword">return</span> pgdir_walk_normal(pgdir, va, create);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		<span class="keyword">return</span> pgdir_walk_ex(pgdir, va, create);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里仅仅对ex函数进行讨论，首先create可能为0、1或者2，不同于normal函数只存在0、1两种情况。0的时候表示不进行额外的分配。1的情况表示是一个小页，2的情况表示是一个大页，只要非0都是表示若不存在则进行分配。</p>
<p>那么如果当前当做一个大页的话，进行分配的情况不需要再去分配一个页面作为二级页表，只需要标记<code>PTE_PS</code>位返回填充对应的物理地址基址就好了。但是存在一个情况在于，原本这个pde指向的是一个二级页表，但是当前是采用大页进行分配的。所以在45行处有针对这种情况的特判。需要做的是将对应的二级页表的页面给清空，然后当做一个新分配的大页进行返回就可以了。</p>
<p>之后考虑的是<code>boot_map_region()</code>函数，同样重写：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">boot_map_region_normal</span><span class="params">(<span class="type">pde_t</span> *pgdir, <span class="type">uintptr_t</span> va, <span class="type">size_t</span> size, <span class="type">physaddr_t</span> pa, <span class="type">int</span> perm)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">// Fill this function in</span></span><br><span class="line">	<span class="keyword">while</span>(size &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">pte_t</span>* pte = pgdir_walk(pgdir, (<span class="type">void</span> *)va, <span class="number">1</span>);</span><br><span class="line">		<span class="keyword">if</span>(pte == <span class="literal">NULL</span>)</span><br><span class="line">			panic(<span class="string">&quot;boot_map_region: Fail to alloc new page, run out of memory!\n&quot;</span>);</span><br><span class="line">		*pte = pa | perm | PTE_P;</span><br><span class="line">		size -= PGSIZE;</span><br><span class="line">		va += PGSIZE, pa += PGSIZE;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">boot_map_region_ex</span><span class="params">(<span class="type">pde_t</span> *pgdir, <span class="type">uintptr_t</span> va, <span class="type">size_t</span> size, <span class="type">physaddr_t</span> pa, <span class="type">int</span> perm)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">while</span>(size &gt; <span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">pte_t</span>* pte = pgdir_walk_ex(pgdir, (<span class="type">void</span> *)va, <span class="number">2</span>);</span><br><span class="line">		<span class="keyword">if</span>(pte == <span class="literal">NULL</span>)</span><br><span class="line">			panic(<span class="string">&quot;boot_map_region: Fail to alloc new page, run out of memory!\n&quot;</span>);</span><br><span class="line">		*pte = pa | perm | PTE_P | PTE_PS;</span><br><span class="line">		size -= PTSIZE;</span><br><span class="line">		va += PTSIZE, pa+= PTSIZE;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">boot_map_region</span><span class="params">(<span class="type">pde_t</span> *pgdir, <span class="type">uintptr_t</span> va, <span class="type">size_t</span> size, <span class="type">physaddr_t</span> pa, <span class="type">int</span> perm)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">uint32_t</span> size_ex = rcr4() &amp; CR4_PSE;</span><br><span class="line">	<span class="keyword">if</span>(size_ex)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(ROUNDUP(pa, PTSIZE) &lt; ROUNDDOWN(pa+size, PTSIZE))</span><br><span class="line">		&#123;</span><br><span class="line">			boot_map_region_normal(pgdir, va, ROUNDUP(pa, PTSIZE) - pa, pa, perm);</span><br><span class="line">			boot_map_region_ex(pgdir, va+ROUNDUP(pa, PTSIZE)-pa, ROUNDDOWN(pa+size, PTSIZE) - ROUNDUP(pa, PTSIZE), ROUNDUP(pa, PTSIZE), perm);</span><br><span class="line">			boot_map_region_normal(pgdir, va+ROUNDDOWN(pa+size, PTSIZE)-pa, pa+size - ROUNDDOWN(pa+size, PTSIZE), ROUNDDOWN(pa+size, PTSIZE), perm);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			boot_map_region_normal(pgdir, va, size, pa, perm);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		boot_map_region_normal(pgdir, va, size, pa, perm);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这里boot_map_region也被分成了两种情况，normal表示的是以4K为一个页面进行映射构造，ex表示的是以4M为一个页面大小进行映射构造。</p>
<p>在36行处的判断说明，仅当cr4被标识成拓展的页面大小且进行映射的区间内存在连续的4M空间的时候，对可以采用大页进行分配的部分采用大页，即调用<code>boot_map_region_ex()</code>函数。所以像是内核栈这种大小只有几十K的映射，在cr4设置之后仍然是采用原有的小页方法进行映射的。</p>
<p>这个时候采用原有的check函数会产生错误，原因在于原有的check函数所进行的地址转换方法是二级的。</p>
<p>重写原来给定的va2pa函数如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">physaddr_t</span></span><br><span class="line"><span class="title function_">check_va2pa</span><span class="params">(<span class="type">pde_t</span> *pgdir, <span class="type">uintptr_t</span> va)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">pte_t</span> *p;</span><br><span class="line">	pgdir = &amp;pgdir[PDX(va)];</span><br><span class="line">	<span class="keyword">if</span>(!(*pgdir &amp; PTE_P))</span><br><span class="line">		<span class="keyword">return</span> ~<span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span>((*pgdir &amp; PTE_PS))</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> ((*pgdir) &amp; <span class="number">0xffc00000</span>) | (va &amp; <span class="number">0x3ff000</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		p = (<span class="type">pte_t</span>*) KADDR(PTE_ADDR(*pgdir));</span><br><span class="line">		<span class="keyword">if</span> (!(p[PTX(va)] &amp; PTE_P))</span><br><span class="line">			<span class="keyword">return</span> ~<span class="number">0</span>;</span><br><span class="line">		<span class="keyword">return</span> PTE_ADDR(p[PTX(va)]);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>根据PTE_PS标志位来决定采用一级寻址还是二级寻址，这样就可以得到正常的结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">check_page_free_list() succeeded!</span><br><span class="line">check_page_alloc() succeeded!</span><br><span class="line">check_page() succeeded!</span><br><span class="line">check_kern_pgdir() succeeded!</span><br><span class="line">check_page_installed_pgdir() succeeded!</span><br><span class="line">Welcome to the JOS kernel monitor!</span><br><span class="line">Type &#x27;help&#x27; for a list of commands.</span><br><span class="line">K&gt;</span><br></pre></td></tr></table></figure>
<p>这里在清空cr4之后都是采用normal的方式来进行映射和寻址，所以会保持和原来相同的行为。</p>
<h2 id="challenge2"><a class="markdownIt-Anchor" href="#challenge2"></a> Challenge2</h2>
<h3 id="showmappings"><a class="markdownIt-Anchor" href="#showmappings"></a> showmappings</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> </span><br><span class="line"><span class="title function_">mon_showmappings</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv, <span class="keyword">struct</span> Trapframe *tf)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(argc != <span class="number">3</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		cprintf(<span class="string">&quot;showmappings: should input 3 arguments!\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">uint32_t</span> lowerbound = strtol(argv[<span class="number">1</span>], <span class="string">&#x27;\0&#x27;</span>, <span class="number">16</span>);</span><br><span class="line">	<span class="type">uint32_t</span> upperbound = strtol(argv[<span class="number">2</span>], <span class="string">&#x27;\0&#x27;</span>, <span class="number">16</span>);</span><br><span class="line">	<span class="type">uint32_t</span> va;</span><br><span class="line">	cprintf(<span class="string">&quot;Virtual Address\tPhysical Address\turw\n&quot;</span>);</span><br><span class="line">	<span class="keyword">for</span>(va = ROUNDDOWN(lowerbound, PGSIZE); va &lt;= ROUNDUP(upperbound, PGSIZE); va += PGSIZE)</span><br><span class="line">	&#123;</span><br><span class="line">		</span><br><span class="line">		<span class="type">pte_t</span> * pte = pgdir_walk(kern_pgdir, (<span class="type">void</span> *)va, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span>(pte &amp;&amp; ((*pte) &amp; PTE_P))</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">physaddr_t</span> pa = PTE_ADDR(*pte);</span><br><span class="line">			<span class="type">char</span> perm_U = ((*pte) &amp; PTE_U) ? <span class="string">&#x27;u&#x27;</span> : <span class="string">&#x27;-&#x27;</span>;</span><br><span class="line">			<span class="type">char</span> perm_P = ((*pte) &amp; PTE_P) ? <span class="string">&#x27;r&#x27;</span> : <span class="string">&#x27;-&#x27;</span>;</span><br><span class="line">			<span class="type">char</span> perm_W = ((*pte) &amp; PTE_W) ? <span class="string">&#x27;w&#x27;</span> : <span class="string">&#x27;-&#x27;</span>;</span><br><span class="line">			cprintf(<span class="string">&quot;  0x%08x\t  0x%08x\t%c%c%c\n&quot;</span> , va, pa, perm_U, perm_P, perm_W);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			cprintf(<span class="string">&quot;  0x%08x\t  0x--------\t---\n&quot;</span>, va);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码如上，可以采用如下形式进行[start_va, end_va]区间内虚拟地址到物理地址页面映射的查询：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">showmappings &lt;start_va&gt; &lt;end_va&gt;</span><br></pre></td></tr></table></figure>
<p>结果如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">K&gt; showmappings 0xefff0000 0xf0000000</span><br><span class="line">Virtual Address	     Physical Address	     urw</span><br><span class="line">  0xefff0000	       0x--------	     ---</span><br><span class="line">  0xefff1000	       0x--------	     ---</span><br><span class="line">  0xefff2000	       0x--------	     ---</span><br><span class="line">  0xefff3000	       0x--------	     ---</span><br><span class="line">  0xefff4000	       0x--------	     ---</span><br><span class="line">  0xefff5000	       0x--------	     ---</span><br><span class="line">  0xefff6000	       0x--------	     ---</span><br><span class="line">  0xefff7000	       0x--------	     ---</span><br><span class="line">  0xefff8000	       0x00117000	     -rw</span><br><span class="line">  0xefff9000	       0x00118000	     -rw</span><br><span class="line">  0xefffa000	       0x00119000	     -rw</span><br><span class="line">  0xefffb000	       0x0011a000	     -rw</span><br><span class="line">  0xefffc000	       0x0011b000	     -rw</span><br><span class="line">  0xefffd000	       0x0011c000	     -rw</span><br><span class="line">  0xefffe000	       0x0011d000	     -rw</span><br><span class="line">  0xeffff000	       0x0011e000	     -rw</span><br><span class="line">  0xf0000000	       0x00000000	     -rw</span><br></pre></td></tr></table></figure>
<h3 id="setperm"><a class="markdownIt-Anchor" href="#setperm"></a> setperm</h3>
<p>提供权限位的设置方法，代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">mon_setperm</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv, <span class="keyword">struct</span> Trapframe * tf)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(argc == <span class="number">3</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">uint32_t</span> va = strtol(argv[<span class="number">1</span>], <span class="string">&#x27;\0&#x27;</span>, <span class="number">16</span>);</span><br><span class="line">		<span class="type">int</span> perm_U = <span class="number">0</span>;</span><br><span class="line">		<span class="type">int</span> perm_P = <span class="number">0</span>;</span><br><span class="line">		<span class="type">int</span> perm_W = <span class="number">0</span>;</span><br><span class="line">		<span class="type">int</span> i;</span><br><span class="line">		<span class="keyword">for</span>(i = <span class="number">0</span>; argv[<span class="number">2</span>][i]; ++i)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(argv[<span class="number">2</span>][i] == <span class="string">&#x27;u&#x27;</span>)</span><br><span class="line">				perm_U = <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(argv[<span class="number">2</span>][i] == <span class="string">&#x27;p&#x27;</span>)</span><br><span class="line">				perm_P = <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(argv[<span class="number">2</span>][i] == <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">				perm_W = <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="type">pte_t</span> * pte = pgdir_walk(kern_pgdir, (<span class="type">void</span> *)va, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span>(pte)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(perm_U)</span><br><span class="line">				*pte = (*pte) | PTE_U;</span><br><span class="line">			<span class="keyword">if</span>(perm_P)</span><br><span class="line">				*pte = (*pte) | PTE_P;</span><br><span class="line">			<span class="keyword">if</span>(perm_W)</span><br><span class="line">				*pte = (*pte) | PTE_W;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">		&#123;</span><br><span class="line">			cprintf(<span class="string">&quot;The virtual address 0x%08x is unmapped\n&quot;</span>, va);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(argc == <span class="number">4</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">uint32_t</span> lowerbound = strtol(argv[<span class="number">1</span>], <span class="string">&#x27;\0&#x27;</span>, <span class="number">16</span>);</span><br><span class="line">		<span class="type">uint32_t</span> upperbound = strtol(argv[<span class="number">2</span>], <span class="string">&#x27;\0&#x27;</span>, <span class="number">16</span>);</span><br><span class="line">		<span class="type">int</span> perm_U = <span class="number">0</span>;</span><br><span class="line">		<span class="type">int</span> perm_P = <span class="number">0</span>;</span><br><span class="line">		<span class="type">int</span> perm_W = <span class="number">0</span>;</span><br><span class="line">		<span class="type">int</span> i, va;</span><br><span class="line">		<span class="keyword">for</span>(i = <span class="number">0</span>; argv[<span class="number">3</span>][i]; ++i)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>(argv[<span class="number">3</span>][i] == <span class="string">&#x27;u&#x27;</span>)</span><br><span class="line">				perm_U = <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(argv[<span class="number">3</span>][i] == <span class="string">&#x27;p&#x27;</span>)</span><br><span class="line">				perm_P = <span class="number">1</span>;</span><br><span class="line">			<span class="keyword">else</span> <span class="keyword">if</span>(argv[<span class="number">3</span>][i] == <span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">				perm_W = <span class="number">1</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span>(va = ROUNDDOWN(lowerbound, PGSIZE); va &lt;= ROUNDUP(upperbound, PGSIZE); va += PGSIZE)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="type">pte_t</span> * pte = pgdir_walk(kern_pgdir, (<span class="type">void</span> *)va, <span class="number">0</span>);</span><br><span class="line">			<span class="keyword">if</span>(pte)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">if</span>(perm_U)</span><br><span class="line">					*pte = (*pte) | PTE_U;</span><br><span class="line">				<span class="keyword">if</span>(perm_P)</span><br><span class="line">					*pte = (*pte) | PTE_P;</span><br><span class="line">				<span class="keyword">if</span>(perm_W)</span><br><span class="line">					*pte = (*pte) | PTE_W;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				cprintf(<span class="string">&quot;The virtual address 0x%08x is unmapped\n&quot;</span>, va);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		cprintf(<span class="string">&quot;setperm: should give one address or an address range!\n&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>支持输入单个虚拟地址对对应的页表项进行更改，或者对一个虚拟地址区间进行修改：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setperm &lt;va&gt; &lt;perm&gt;</span><br><span class="line">setperm &lt;start_va&gt; &lt;end_va&gt; &lt;perm&gt;</span><br></pre></td></tr></table></figure>
<p>样例如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">K&gt; showmappings 0xf0000000 0xf0001000</span><br><span class="line">Virtual Address	     Physical Address	     urw</span><br><span class="line">  0xf0000000	       0x00000000	     -rw</span><br><span class="line">  0xf0001000	       0x00001000	     -rw</span><br><span class="line">K&gt; setperm 0xf0000000 u</span><br><span class="line">K&gt; showmappings 0xf0000000 0xf0001000</span><br><span class="line">Virtual Address	     Physical Address	     urw</span><br><span class="line">  0xf0000000	       0x00000000	     urw</span><br><span class="line">  0xf0001000	       0x00001000	     -rw</span><br></pre></td></tr></table></figure>
<p>可以发现确实对权限位进行了设置。</p>
<h3 id="clearperm"><a class="markdownIt-Anchor" href="#clearperm"></a> clearperm</h3>
<p>对权限位进行清空，整体框架和setperm相同，只需要将修改部分的代码改成：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(perm_U)</span><br><span class="line">	*pte = (*pte) &amp; (~PTE_U);</span><br><span class="line"><span class="keyword">if</span>(perm_P)</span><br><span class="line">	*pte = (*pte) &amp; (~PTE_P);</span><br><span class="line"><span class="keyword">if</span>(perm_W)</span><br><span class="line">	*pte = (*pte) &amp; (~PTE_W);</span><br></pre></td></tr></table></figure>
<p>测试结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">K&gt; showmappings 0xf0000000 0xf0001000</span><br><span class="line">Virtual Address	     Physical Address	     urw</span><br><span class="line">  0xf0000000	       0x00000000	     -rw</span><br><span class="line">  0xf0001000	       0x00001000	     -rw</span><br><span class="line">K&gt; clearperm 0xf0000000 w</span><br><span class="line">K&gt; showmappings 0xf0000000 0xf0001000</span><br><span class="line">Virtual Address	     Physical Address	     urw</span><br><span class="line">  0xf0000000	       0x00000000	     -r-</span><br><span class="line">  0xf0001000	       0x00001000	     -rw</span><br></pre></td></tr></table></figure>
<h3 id="changeperm"><a class="markdownIt-Anchor" href="#changeperm"></a> changeperm</h3>
<p>对权限位进行修改，整体框架和setperm相同，只需要将修改部分的代码改成：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(perm_U)</span><br><span class="line">	*pte = (*pte) ^ PTE_U;</span><br><span class="line"><span class="keyword">if</span>(perm_P)</span><br><span class="line">	*pte = (*pte) ^ PTE_P;</span><br><span class="line"><span class="keyword">if</span>(perm_W)</span><br><span class="line">	*pte = (*pte) ^ PTE_W;</span><br></pre></td></tr></table></figure>
<p>测试结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">K&gt; showmappings 0xf0000000 0xf0001000</span><br><span class="line">Virtual Address	     Physical Address	     urw</span><br><span class="line">  0xf0000000	       0x00000000	     -rw</span><br><span class="line">  0xf0001000	       0x00001000	     -rw</span><br><span class="line">K&gt; changeperm 0xf0000000 w</span><br><span class="line">K&gt; showmappings 0xf0000000 0xf0001000</span><br><span class="line">Virtual Address	     Physical Address	     urw</span><br><span class="line">  0xf0000000	       0x00000000	     -r-</span><br><span class="line">  0xf0001000	       0x00001000	     -rw</span><br><span class="line">K&gt; changeperm 0xf0000000 w</span><br><span class="line">K&gt; showmappings 0xf0000000 0xf0001000</span><br><span class="line">Virtual Address	     Physical Address	     urw</span><br><span class="line">  0xf0000000	       0x00000000	     -rw</span><br><span class="line">  0xf0001000	       0x00001000	     -rw</span><br></pre></td></tr></table></figure>
<h3 id="content"><a class="markdownIt-Anchor" href="#content"></a> content</h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">mon_content</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv, <span class="keyword">struct</span> Trapframe *tf)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span>(argc != <span class="number">4</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		cprintf(<span class="string">&quot;content: type \&quot;help\&quot; to see the example!\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">physaddr_t</span> pa;</span><br><span class="line">	<span class="keyword">if</span>(argv[<span class="number">1</span>][<span class="number">1</span>] == <span class="string">&#x27;v&#x27;</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="type">uint32_t</span> base_va = strtol(argv[<span class="number">2</span>], <span class="string">&#x27;\0&#x27;</span>, <span class="number">16</span>);</span><br><span class="line">		<span class="type">pte_t</span> * pte = pgdir_walk(kern_pgdir, (<span class="type">void</span> *)base_va, <span class="number">0</span>);</span><br><span class="line">		pa = PTE_ADDR(*pte) | PGOFF(base_va);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span>(argv[<span class="number">1</span>][<span class="number">1</span>] == <span class="string">&#x27;p&#x27;</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		pa = strtol(argv[<span class="number">2</span>], <span class="string">&#x27;\0&#x27;</span>, <span class="number">16</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		cprintf(<span class="string">&quot;content: -p means physical address, -v means virtual address!\n&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">uint32_t</span> count = strtol(argv[<span class="number">3</span>], <span class="string">&#x27;\0&#x27;</span>, <span class="number">10</span>);</span><br><span class="line">	<span class="type">int</span> check;</span><br><span class="line">	<span class="keyword">for</span>(check = <span class="number">0</span>; count &gt; <span class="number">0</span>; --count, ++check)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span>(check == <span class="number">0</span>)</span><br><span class="line">			cprintf(<span class="string">&quot;0x%08x:&quot;</span>, pa);</span><br><span class="line">		cprintf(<span class="string">&quot; 0x%08x&quot;</span>, *(<span class="type">uint32_t</span>*)(KADDR(pa)));</span><br><span class="line">		pa += <span class="number">4</span>;</span><br><span class="line">		<span class="keyword">if</span>(check == <span class="number">3</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			check = <span class="number">-1</span>;</span><br><span class="line">			cprintf(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span>(check)</span><br><span class="line">		cprintf(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码如上，用来查看虚拟地址或者物理地址对应的具体内容，可以利用如下的命令形式进行查询：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">content -p &lt;pa&gt; &lt;number&gt;</span><br><span class="line">content -v &lt;va&gt; &lt;number&gt;</span><br></pre></td></tr></table></figure>
<p>其中利用-p或者-v来表明查询的是物理地址还是虚拟地址，number表示要查询的多少，示例结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">K&gt; content -p 0x0 8</span><br><span class="line">0x00000000: 0xf000ff53 0xf000ff53 0xf000e2c3 0xf000ff53</span><br><span class="line">0x00000010: 0xf000ff53 0xf000ff54 0xf000ff53 0xf000ff53</span><br><span class="line">K&gt; content -v 0xf0000000 8</span><br><span class="line">0x00000000: 0xf000ff53 0xf000ff53 0xf000e2c3 0xf000ff53</span><br><span class="line">0x00000010: 0xf000ff53 0xf000ff54 0xf000ff53 0xf000ff53</span><br></pre></td></tr></table></figure>
<p>之前可以知道，KERNBASE以上的虚拟地址映射到的是从零开始的虚拟地址，所以上面得到的结果是完全相同的。利用qemu的指令进行检查：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(qemu) xp /8x 0x0</span><br><span class="line">0000000000000000: 0xf000ff53 0xf000ff53 0xf000e2c3 0xf000ff53</span><br><span class="line">0000000000000010: 0xf000ff53 0xf000ff54 0xf000ff53 0xf000ff53</span><br></pre></td></tr></table></figure>
<p>可以发现得到的结果完全相同，说明指令运行没有问题。</p>
<h2 id="challenge34"><a class="markdownIt-Anchor" href="#challenge34"></a> Challenge3&amp;4</h2>
<p>没写代码，感觉两个Challenge是递进的关系。challenge3可以考虑只保存包括内核自身的页目录，以及内核栈地址用来往内核栈写入参数保存信息，中断向量表等陷入内核态需要的信息。这样可能只需要几个page就足够了。陷入内核之后通过内核自身的页目录来完成地址映射进行寻址以及执行。这几个和内核相关的页面都应该是内核可读写，用户没有权限。</p>
<p>之后Challenge4由于Challenge3已经将内核相关的地址空间大小缩小了。如果进程想要对于这些地址进行分配的话，那么由于权限不够，会触发异常。处理的手段就是将这部分内容放到暂时还没有使用的地址，并且对相应的地址链接等内容进行修改，然后再次进行分配操作。我感觉这可能是bouncing kernel的意思，找了很久也没有找到bouncing kernel相关的资料或者论文。由于在challenge3当中把需要内核相关的内容缩小到了几个page，所以就可以大大减少需要触发弹跳机制的频率，降低为了更大地址空间所带来的额外时间开销。</p>
<h2 id="challenge5"><a class="markdownIt-Anchor" href="#challenge5"></a> Challenge5</h2>
<p>我觉得可以考虑采用类似ICS中malloc lab里面的方法，在PageInfo里面加入前后page的链接以及这个连续页面的大小（是PGSIZE的整数倍）。之后利用first-fit或者best-fit的方式进行适配，删除的时候考虑前后的合并。这样应该就可以完成连续地址的分配。对于比较大的连续分配还可以结合Challenge1当中的大页从而节省掉二级页表的空间。</p>
<p>题面中所说的&quot;power-of-two allocation unit sizes from 4KB up to some reasonable maximum of your choice.&quot;应该就是伙伴系统了。感觉要完全实现除去修改自己写的函数之外需要修改<code>check_page_free_list()</code>以及<code>kern/pmap.h</code>当中的宏以及辅助函数，不知道会不会引发什么其他地方未知的错误，没有进行代码实现。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://phimos.github.io/2020/03/06/OpenMP-on-macOS/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Pims">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pims的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/03/06/OpenMP-on-macOS/" class="post-title-link" itemprop="url">在macOS 10.15上使用OpenMP</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-03-06 04:00:02" itemprop="dateCreated datePublished" datetime="2020-03-06T04:00:02+08:00">2020-03-06</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>首先利用brew进行安装：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install libomp</span><br></pre></td></tr></table></figure>
<p>完成之后，采用如下的测试代码，存储为<code>hello.c</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;omp.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span> </span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123; </span><br><span class="line">  <span class="meta">#<span class="keyword">pragma</span> omp parallel </span></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hello from thread %d, nthreads %d\n&quot;</span>, omp_get_thread_num(), omp_get_num_threads());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>尝试利用gcc进行编译：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc hello.c -fopenmp -o hello &amp;&amp; ./hello</span><br></pre></td></tr></table></figure>
<p>诡异的事情出现了，会得到如下的结果，非常奇怪，gcc应该是支持这个选项的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang: error: unsupported option &#x27;-fopenmp&#x27;</span><br></pre></td></tr></table></figure>
<p>从这个地方可以发现clang进行了报错，但是明明是使用gcc进行编译的，利用<code>gcc -v</code>查看可以看到如下发现：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Apple clang version 11.0.0 (clang-1100.0.33.17)</span><br><span class="line">Target: x86_64-apple-darwin19.3.0</span><br><span class="line">Thread model: posix</span><br><span class="line">InstalledDir: /Library/Developer/CommandLineTools/usr/bin</span><br></pre></td></tr></table></figure>
<p>这里名叫gcc的东西实际上是clang，所以正常使用gcc编译的时候实际上是用的clang？？？之后采用gcc-9来指定gcc进行编译，而不采用clang：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc-9 hello.c -fopenmp -o hello &amp;&amp; ./hello </span><br></pre></td></tr></table></figure>
<p>可以正常的执行并得到如下的结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Hello from thread 1, nthreads 8</span><br><span class="line">Hello from thread 4, nthreads 8</span><br><span class="line">Hello from thread 3, nthreads 8</span><br><span class="line">Hello from thread 6, nthreads 8</span><br><span class="line">Hello from thread 5, nthreads 8</span><br><span class="line">Hello from thread 0, nthreads 8</span><br><span class="line">Hello from thread 2, nthreads 8</span><br><span class="line">Hello from thread 7, nthreads 8</span><br></pre></td></tr></table></figure>
<p>由于多线程并不能保证执行顺序，可以看到Hello的打印顺序是不一样的，到这里就可以愉快使用OpenMP了！</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://phimos.github.io/2020/02/29/RN-ResNeXt/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Pims">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pims的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/29/RN-ResNeXt/" class="post-title-link" itemprop="url">[论文笔记] (ResNeXt) Aggregated Residual Transformations for Deep Neural Networks Saining</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-02-29 06:44:06" itemprop="dateCreated datePublished" datetime="2020-02-29T06:44:06+08:00">2020-02-29</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="简介"><a class="markdownIt-Anchor" href="#简介"></a> 简介</h2>
<p>文章提出了一种利用重复一个简单基本块从而聚集一系列有着相同拓扑结构的的转换，这种多分支的结构叫做ResNeXt，相对于ResNet的有着更好地性能。</p>
<p>就像VGG和ResNet一样，都是通过堆叠有着相同拓扑结构的模块这种简单策略，来实现更好的效果。而Inception model不同，是通过一种split-transform-merge的策略，首先split来得到一些低维的embedding，然后过一系列不同的filter来进行transform，最后直接拼接merge在一起，通过这种方式来用更小的算力企图获得更大更深的网络能够带来的表现。</p>
<p>这篇论文中提出了一个同样是重复模块的简单模型，从VGG/ResNet和Inception model都借鉴了策略，将一系列有着相同拓扑结构的transformation给聚集起来了。这种聚集的transformation的多少叫做<code>cardinality</code>。实验证明，当提高网络的深度和宽度得到减少的回报的时候，提升cardinality是一个更有效的提升准确率的方法。</p>
<h2 id="网络结构"><a class="markdownIt-Anchor" href="#网络结构"></a> 网络结构</h2>
<p>这种网络有着三种等价形式：</p>
<p><img src="https://s2.loli.net/2023/01/10/MlvsFhHEoeDwp4X.jpg" alt="" /></p>
<p>可以发现最上面一层每一条路径都能够看到全部的数据，最后面一层由于最后对于多条之路要汇总求和，所以也是可以直接做卷积，能够看到全部的数据的。事实上只有中间的卷积操作，对于每一条支路而言，只能看到上一层部分的数据。虽然三者相互等价，但是显然在实现上采用c中描述的形式要简便许多。</p>
<p>以上分析针对三层以上网络，那么对于小于三层的网络而言，两种实现是完全等价的。</p>
<p><img src="https://s2.loli.net/2023/01/10/trKCeXTiBDl6N9s.jpg" alt="" /></p>
<p>那么这里采用新的形式从64变为32x4d的方法只是额外增加了网络宽度。</p>
<h2 id="参数量"><a class="markdownIt-Anchor" href="#参数量"></a> 参数量</h2>
<img src="https://s2.loli.net/2023/01/10/TtbSWCvz2U7qlKf.jpg" alt="image-20200229223535943" style="zoom:50%;" />
<p>以上是几种参数规模差不多的设置，其中<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>C</mi><mo>=</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">C=1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.07153em;">C</span><span class="mrel">=</span><span class="mord mathrm">1</span></span></span></span>的情况代表的就是普通的ResNet，实验结果最好的为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>C</mi><mo>=</mo><mn>3</mn><mn>2</mn></mrow><annotation encoding="application/x-tex">C=32</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.07153em;">C</span><span class="mrel">=</span><span class="mord mathrm">3</span><span class="mord mathrm">2</span></span></span></span>，即<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>3</mn><mn>2</mn><mo>×</mo><mn>4</mn><mi>d</mi></mrow><annotation encoding="application/x-tex">32\times4d</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">3</span><span class="mord mathrm">2</span><span class="mbin">×</span><span class="mord mathrm">4</span><span class="mord mathit">d</span></span></span></span>的模型。对于每一层的参数计算如下：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>C</mi><mo>⋅</mo><mo>(</mo><mn>2</mn><mn>5</mn><mn>6</mn><mo>∗</mo><mi>d</mi><mo>+</mo><mn>3</mn><mo>∗</mo><mi>d</mi><mo>∗</mo><mi>d</mi><mo>+</mo><mi>d</mi><mo>∗</mo><mn>2</mn><mn>5</mn><mn>6</mn><mo>)</mo></mrow><annotation encoding="application/x-tex">C \cdot(256*d+3*d*d+d*256)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord mathit" style="margin-right:0.07153em;">C</span><span class="mbin">⋅</span><span class="mopen">(</span><span class="mord mathrm">2</span><span class="mord mathrm">5</span><span class="mord mathrm">6</span><span class="mbin">∗</span><span class="mord mathit">d</span><span class="mbin">+</span><span class="mord mathrm">3</span><span class="mbin">∗</span><span class="mord mathit">d</span><span class="mbin">∗</span><span class="mord mathit">d</span><span class="mbin">+</span><span class="mord mathit">d</span><span class="mbin">∗</span><span class="mord mathrm">2</span><span class="mord mathrm">5</span><span class="mord mathrm">6</span><span class="mclose">)</span></span></span></span></span></p>
<h2 id="代码实现"><a class="markdownIt-Anchor" href="#代码实现"></a> 代码实现</h2>
<p>其实基本和ResNet的实现相同，由于pyTorch的卷积层自身有group参数，采用之前提到的三种等价形式的最后一种，只需要在Bottleneck的模块中将中间的卷积层的group设置成32，重新设置Basicblock和Bottleneck的expansion为原来的二分之一，调整channel的大小为原来的两倍，就可以得到ResNeXt了，下面是ResNeXt(32x4D)的一个实现：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">BasicBlock</span>(nn.Module):</span><br><span class="line">    expansion = <span class="number">0.5</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, input_channel, channel, stride</span>):</span><br><span class="line">        <span class="built_in">super</span>(BasicBlock, self).__init__()</span><br><span class="line">        </span><br><span class="line">        output_channel = <span class="built_in">int</span>(channel * self.expansion)</span><br><span class="line">        self.downsample = <span class="keyword">lambda</span> x: x</span><br><span class="line">        <span class="keyword">if</span>(input_channel != output_channel):</span><br><span class="line">            self.downsample = nn.Sequential(</span><br><span class="line">                nn.Conv2d(in_channels = input_channel, out_channels = output_channel, kernel_size = <span class="number">1</span>, stride = stride, bias = <span class="literal">False</span>),</span><br><span class="line">                nn.BatchNorm2d(output_channel)</span><br><span class="line">            )</span><br><span class="line">        </span><br><span class="line">        self.relu = nn.ReLU(inplace = <span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        self.convlayers = nn.Sequential(</span><br><span class="line">            nn.Conv2d(in_channels = input_channel, out_channels = channel, kernel_size = <span class="number">3</span>, stride = stride, padding = <span class="number">1</span>, bias = <span class="literal">False</span>),</span><br><span class="line">            nn.BatchNorm2d(channel),</span><br><span class="line">            nn.ReLU(inplace = <span class="literal">True</span>),</span><br><span class="line">            nn.Conv2d(in_channels = channel, out_channels = output_channel, kernel_size = <span class="number">3</span>, stride = <span class="number">1</span>, padding = <span class="number">1</span>, bias = <span class="literal">False</span>),</span><br><span class="line">            nn.BatchNorm2d(output_channel)</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        out = self.downsample(x) + self.convlayers(x)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Bottleneck</span>(nn.Module):</span><br><span class="line">    expansion = <span class="number">2</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, input_channel, channel, stride, expansion = <span class="number">2</span>, group_num = <span class="number">32</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(Bottleneck, self).__init__()</span><br><span class="line">        self.expansion = expansion</span><br><span class="line">        output_channel = channel * expansion</span><br><span class="line">        </span><br><span class="line">        self.downsample = <span class="keyword">lambda</span> x: x</span><br><span class="line">        <span class="keyword">if</span>(input_channel != output_channel):</span><br><span class="line">            self.downsample = nn.Sequential(</span><br><span class="line">                nn.Conv2d(in_channels = input_channel, out_channels = output_channel, kernel_size = <span class="number">1</span>, stride = stride, bias = <span class="literal">False</span>),</span><br><span class="line">                nn.BatchNorm2d(output_channel)</span><br><span class="line">            )</span><br><span class="line">        </span><br><span class="line">        self.relu = nn.ReLU(inplace = <span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        self.convlayers = nn.Sequential(</span><br><span class="line">            nn.Conv2d(in_channels = input_channel, out_channels = channel, kernel_size = <span class="number">1</span>, stride = <span class="number">1</span>, bias = <span class="literal">False</span>),</span><br><span class="line">            nn.BatchNorm2d(channel),</span><br><span class="line">            nn.ReLU(inplace = <span class="literal">True</span>),</span><br><span class="line">            nn.Conv2d(in_channels = channel, out_channels = channel, kernel_size = <span class="number">3</span>, stride = stride, padding = <span class="number">1</span>, groups = group_num, bias = <span class="literal">False</span>),</span><br><span class="line">            nn.BatchNorm2d(channel),</span><br><span class="line">            nn.ReLU(inplace = <span class="literal">True</span>),</span><br><span class="line">            nn.Conv2d(in_channels = channel, out_channels = output_channel, kernel_size = <span class="number">1</span>, stride = <span class="number">1</span>, bias = <span class="literal">False</span>),</span><br><span class="line">            nn.BatchNorm2d(output_channel)</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        out = self.downsample(x) + self.convlayers(x)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line">    </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ResNet</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, block, block_nums, input_channel, class_num = <span class="number">1000</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(ResNet, self).__init__()</span><br><span class="line">        </span><br><span class="line">        self.stacklayers = nn.Sequential(</span><br><span class="line">            nn.Conv2d(in_channels = input_channel, out_channels = <span class="number">64</span>, kernel_size = <span class="number">7</span>, stride = <span class="number">2</span>, padding = <span class="number">3</span>, bias = <span class="literal">False</span>),</span><br><span class="line">            nn.BatchNorm2d(<span class="number">64</span>),</span><br><span class="line">            nn.ReLU(inplace = <span class="literal">True</span>),</span><br><span class="line">            nn.MaxPool2d(kernel_size = <span class="number">3</span>, stride = <span class="number">2</span>, padding = <span class="number">1</span>),</span><br><span class="line">            self.make_layers(block = block, input_channel = <span class="number">64</span>, channel = <span class="number">128</span>, stride = <span class="number">1</span>, block_num = block_nums[<span class="number">0</span>]),</span><br><span class="line">            self.make_layers(block = block, input_channel = <span class="built_in">int</span>(<span class="number">128</span> * block.expansion), channel = <span class="number">256</span>, stride = <span class="number">2</span>, block_num = block_nums[<span class="number">1</span>]),</span><br><span class="line">            self.make_layers(block = block, input_channel = <span class="built_in">int</span>(<span class="number">256</span> * block.expansion), channel = <span class="number">512</span>, stride = <span class="number">2</span>, block_num = block_nums[<span class="number">2</span>]),</span><br><span class="line">            self.make_layers(block = block, input_channel = <span class="built_in">int</span>(<span class="number">512</span> * block.expansion), channel = <span class="number">1024</span>, stride = <span class="number">2</span>, block_num = block_nums[<span class="number">3</span>]),</span><br><span class="line">            nn.AdaptiveAvgPool2d(<span class="number">1</span>),</span><br><span class="line">            nn.Flatten(),</span><br><span class="line">            nn.Linear(<span class="built_in">int</span>(<span class="number">1024</span>*block.expansion), class_num)</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">make_layers</span>(<span class="params">self, block, input_channel, channel, stride, block_num</span>):</span><br><span class="line">        layers = []</span><br><span class="line">        layers.append(block(input_channel, channel, stride))</span><br><span class="line">        input_channel = <span class="built_in">int</span>(channel * block.expansion)</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, block_num):</span><br><span class="line">            layers.append(block(input_channel, channel, <span class="number">1</span>))</span><br><span class="line">        <span class="keyword">return</span> nn.Sequential(*layers)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        out = self.stacklayers(x)</span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ResNeXt_18</span>(<span class="params">input_channel, class_num</span>):</span><br><span class="line">    <span class="keyword">return</span> ResNet(BasicBlock, [<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>], input_channel, class_num)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ResNeXt_34</span>(<span class="params">input_channel, class_num</span>):</span><br><span class="line">    <span class="keyword">return</span> ResNet(BasicBlock, [<span class="number">3</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">3</span>], input_channel, class_num)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ResNeXt_50</span>(<span class="params">input_channel, class_num</span>):</span><br><span class="line">    <span class="keyword">return</span> ResNet(Bottleneck, [<span class="number">3</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">3</span>], input_channel, class_num)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ResNeXt_101</span>(<span class="params">input_channel, class_num</span>):</span><br><span class="line">    <span class="keyword">return</span> ResNet(Bottleneck, [<span class="number">3</span>,<span class="number">4</span>,<span class="number">23</span>,<span class="number">3</span>], input_channel, class_num)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ResNeXt_152</span>(<span class="params">input_channel, class_num</span>):</span><br><span class="line">    <span class="keyword">return</span> ResNet(Bottleneck, [<span class="number">3</span>,<span class="number">8</span>,<span class="number">36</span>,<span class="number">3</span>], input_channel, class_num)</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://phimos.github.io/2020/02/28/6828-lab1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Pims">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pims的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/28/6828-lab1/" class="post-title-link" itemprop="url">MIT6.828 Lab1</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-02-28 17:47:54" itemprop="dateCreated datePublished" datetime="2020-02-28T17:47:54+08:00">2020-02-28</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="environment-setting"><a class="markdownIt-Anchor" href="#environment-setting"></a> Environment Setting</h2>
<p>在OS X下进行的环境搭建，配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">             ###                  User: pims</span><br><span class="line">           ####                   Hostname: PimsdeMacBook-Pro</span><br><span class="line">           ###                    Distro: OS X 10.15.3</span><br><span class="line">   #######    #######             Kernel: Darwin</span><br><span class="line"> ######################           Uptime:  7:32</span><br><span class="line">#####################             Shell: /bin/zsh</span><br><span class="line">####################              Terminal: xterm-256color iTerm.app</span><br><span class="line">####################              CPU: Intel Core i5-8257U CPU @ 1.40GHz</span><br><span class="line">#####################             Memory: 16 GB</span><br><span class="line"> ######################           Disk: 26%</span><br><span class="line">  ####################            Battery: 100%</span><br><span class="line">    ################             </span><br><span class="line">     ####     #####</span><br></pre></td></tr></table></figure>
<p>由于官网提供的补丁版qemu在本地报错make不成功，所以用的是正常版的qemu，但是对于在完成exercise的过程中没有遇到很大的问题，对于lab文件的make结果如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">➜  lab git:(lab1) ✗ make</span><br><span class="line">+ as kern/entry.S</span><br><span class="line">+ cc kern/entrypgdir.c</span><br><span class="line">+ cc kern/init.c</span><br><span class="line">+ cc kern/console.c</span><br><span class="line">+ cc kern/monitor.c</span><br><span class="line">+ cc kern/printf.c</span><br><span class="line">+ cc kern/kdebug.c</span><br><span class="line">+ cc lib/printfmt.c</span><br><span class="line">+ cc lib/readline.c</span><br><span class="line">+ cc lib/string.c</span><br><span class="line">+ ld obj/kern/kernel</span><br><span class="line">i386-jos-elf-ld: warning: section `.bss&#x27; type changed to PROGBITS</span><br><span class="line">+ as boot/boot.S</span><br><span class="line">+ cc -Os boot/main.c</span><br><span class="line">+ ld boot/boot</span><br><span class="line">boot block is 382 bytes (max 510)</span><br><span class="line">+ mk obj/kern/kernel.img</span><br></pre></td></tr></table></figure>
<h2 id="exercise1"><a class="markdownIt-Anchor" href="#exercise1"></a> Exercise1</h2>
<p>内容为阅读汇编的文档，进行了阅读，了解了内嵌汇编的语法格式。</p>
<h2 id="exercise2"><a class="markdownIt-Anchor" href="#exercise2"></a> Exercise2</h2>
<p>逐步执行查看了运行过程，并且对于GDB指令进行了进一步的熟悉。</p>
<h2 id="exercise3"><a class="markdownIt-Anchor" href="#exercise3"></a> Exercise3</h2>
<ul>
<li>At what point does the processor start executing 32-bit code? What exactly causes the switch from 16- to 32-bit mode?</li>
</ul>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">lgdt    gdtdesc</span><br><span class="line">movl    %cr0, %eax        </span><br><span class="line">orl     $CR0_PE_ON, %eax  </span><br><span class="line">movl    %eax, %cr0        </span><br><span class="line"></span><br><span class="line"># Jump to next instruction, but in 32-bit code segment.</span><br><span class="line"># Switches processor into 32-bit mode.</span><br><span class="line">ljmp    $PROT_MODE_CSEG, $protcseg</span><br></pre></td></tr></table></figure>
<p>在修改完了<code>cr0</code>的值之后，通过<code>ljmp</code>指令切换到32-bit模式</p>
<ul>
<li>What is the last instruction of the boot loader executed, and what is the first instruction of the kernel it just loaded?</li>
</ul>
<p>在main.c文件中可以看到，<code>bootmain</code>结尾的最后是：</p>
 <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((<span class="type">void</span> (*)(<span class="type">void</span>)) (ELFHDR-&gt;e_entry))();</span><br></pre></td></tr></table></figure>
<p>转到ELF头里面的入口，这个函数正常情况下不会返回，所以后面bad里面的死循环在正常情况下是永远不可能执行的代码。</p>
<p>在obj/boot/boot.asm里面可以看到对应的内容为：</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">7d63:	ff 15 18 00 01 00    	call   *0x10018</span><br></pre></td></tr></table></figure>
<ul>
<li>Where is the first instruction of the kernel?</li>
</ul>
<p>在gdb窗口中<code>b *0x7d63</code>在<code>call</code>语句前面打一个断点，之后执行<code>si</code>，可以看到kernel里面的第一条语句是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x10000c:	movw   $0x1234,0x472</span><br></pre></td></tr></table></figure>
<ul>
<li>How does the boot loader decide how many sectors it must read in order to fetch the entire kernel from disk? Where does it find this information?</li>
</ul>
<p>在ELF头里面，保存了相关的信息，其中Elf数据类型的定义inc/elf.h头文件当中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Elf</span> &#123;</span></span><br><span class="line">	<span class="type">uint32_t</span> e_magic;	<span class="comment">// must equal ELF_MAGIC</span></span><br><span class="line">	<span class="type">uint8_t</span> e_elf[<span class="number">12</span>];</span><br><span class="line">	<span class="type">uint16_t</span> e_type;</span><br><span class="line">	<span class="type">uint16_t</span> e_machine;</span><br><span class="line">	<span class="type">uint32_t</span> e_version;</span><br><span class="line">	<span class="type">uint32_t</span> e_entry;</span><br><span class="line">	<span class="type">uint32_t</span> e_phoff;</span><br><span class="line">	<span class="type">uint32_t</span> e_shoff;</span><br><span class="line">	<span class="type">uint32_t</span> e_flags;</span><br><span class="line">	<span class="type">uint16_t</span> e_ehsize;</span><br><span class="line">	<span class="type">uint16_t</span> e_phentsize;</span><br><span class="line">	<span class="type">uint16_t</span> e_phnum;</span><br><span class="line">	<span class="type">uint16_t</span> e_shentsize;</span><br><span class="line">	<span class="type">uint16_t</span> e_shnum;</span><br><span class="line">	<span class="type">uint16_t</span> e_shstrndx;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>其中e_phoff表示Program header table在文件中的偏移量，e_phnum表示Program header table里面一共有多少个条目，在<code>bootmain</code>的主函数中从ELF头读入得到：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ph = (<span class="keyword">struct</span> Proghdr *) ((<span class="type">uint8_t</span> *) ELFHDR + ELFHDR-&gt;e_phoff);</span><br><span class="line">eph = ph + ELFHDR-&gt;e_phnum;</span><br></pre></td></tr></table></figure>
<h2 id="exercise4"><a class="markdownIt-Anchor" href="#exercise4"></a> Exercise4</h2>
<p>pointers.c的文件具体内容如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">f</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> a[<span class="number">4</span>];</span><br><span class="line">    <span class="type">int</span> *b = <span class="built_in">malloc</span>(<span class="number">16</span>);</span><br><span class="line">    <span class="type">int</span> *c;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;1: a = %p, b = %p, c = %p\n&quot;</span>, a, b, c);</span><br><span class="line"></span><br><span class="line">    c = a;</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)</span><br><span class="line">	a[i] = <span class="number">100</span> + i;</span><br><span class="line">    c[<span class="number">0</span>] = <span class="number">200</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;2: a[0] = %d, a[1] = %d, a[2] = %d, a[3] = %d\n&quot;</span>,</span><br><span class="line">	   a[<span class="number">0</span>], a[<span class="number">1</span>], a[<span class="number">2</span>], a[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line">    c[<span class="number">1</span>] = <span class="number">300</span>;</span><br><span class="line">    *(c + <span class="number">2</span>) = <span class="number">301</span>;</span><br><span class="line">    <span class="number">3</span>[c] = <span class="number">302</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;3: a[0] = %d, a[1] = %d, a[2] = %d, a[3] = %d\n&quot;</span>,</span><br><span class="line">	   a[<span class="number">0</span>], a[<span class="number">1</span>], a[<span class="number">2</span>], a[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line">    c = c + <span class="number">1</span>;</span><br><span class="line">    *c = <span class="number">400</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;4: a[0] = %d, a[1] = %d, a[2] = %d, a[3] = %d\n&quot;</span>,</span><br><span class="line">	   a[<span class="number">0</span>], a[<span class="number">1</span>], a[<span class="number">2</span>], a[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line">    c = (<span class="type">int</span> *) ((<span class="type">char</span> *) c + <span class="number">1</span>);</span><br><span class="line">    *c = <span class="number">500</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;5: a[0] = %d, a[1] = %d, a[2] = %d, a[3] = %d\n&quot;</span>,</span><br><span class="line">	   a[<span class="number">0</span>], a[<span class="number">1</span>], a[<span class="number">2</span>], a[<span class="number">3</span>]);</span><br><span class="line"></span><br><span class="line">    b = (<span class="type">int</span> *) a + <span class="number">1</span>;</span><br><span class="line">    c = (<span class="type">int</span> *) ((<span class="type">char</span> *) a + <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;6: a = %p, b = %p, c = %p\n&quot;</span>, a, b, c);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">main</span><span class="params">(<span class="type">int</span> ac, <span class="type">char</span> **av)</span></span><br><span class="line">&#123;</span><br><span class="line">    f();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>得到的输出结果为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1: a = 0x7ffeef413940, b = 0x7ffe70c00060, c = 0x7ffeef4139a0</span><br><span class="line">2: a[0] = 200, a[1] = 101, a[2] = 102, a[3] = 103</span><br><span class="line">3: a[0] = 200, a[1] = 300, a[2] = 301, a[3] = 302</span><br><span class="line">4: a[0] = 200, a[1] = 400, a[2] = 301, a[3] = 302</span><br><span class="line">5: a[0] = 200, a[1] = 128144, a[2] = 256, a[3] = 302</span><br><span class="line">6: a = 0x7ffeef413940, b = 0x7ffeef413944, c = 0x7ffeef413941</span><br></pre></td></tr></table></figure>
<p>可以看到b指向的是在堆上面开辟的空间，而a、c都是在栈上面开辟的空间，所以地址存在一定差异。之后都是一些比较简单的地址索引以及指针加法。</p>
<h2 id="exercise5"><a class="markdownIt-Anchor" href="#exercise5"></a> Exercise5</h2>
<p>这里将boot/Makefrag文件中的0x7C00修改成了0x7D00：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$(OBJDIR)/boot/boot: $(BOOT_OBJS)</span><br><span class="line">	@echo + ld boot/boot</span><br><span class="line">	$(V)$(LD) $(LDFLAGS) -N -e start -Ttext 0x7D00 -o $@.out $^</span><br><span class="line">	$(V)$(OBJDUMP) -S $@.out &gt;$@.asm</span><br><span class="line">	$(V)$(OBJCOPY) -S -O binary -j .text $@.out $@</span><br><span class="line">	$(V)perl boot/sign.pl $(OBJDIR)/boot/boot</span><br></pre></td></tr></table></figure>
<p>重新make之后，查看obj/boot/boot.asm可以发现链接地址已经发生了改变：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">.globl start</span><br><span class="line">start:</span><br><span class="line">  .code16                     # Assemble for 16-bit mode</span><br><span class="line">  cli                         # Disable interrupts</span><br><span class="line">    7d00:	fa                   	cli    </span><br><span class="line">  cld                         # String operations increment</span><br><span class="line">    7d01:	fc                   	cld    </span><br><span class="line"></span><br><span class="line">  # Set up the important data segment registers (DS, ES, SS).</span><br><span class="line">  xorw    %ax,%ax             # Segment number zero</span><br><span class="line">    7d02:	31 c0                	xor    %eax,%eax</span><br><span class="line">  movw    %ax,%ds             # -&gt; Data Segment</span><br><span class="line">    7d04:	8e d8                	mov    %eax,%ds</span><br><span class="line">  movw    %ax,%es             # -&gt; Extra Segment</span><br><span class="line">    7d06:	8e c0                	mov    %eax,%es</span><br><span class="line">  movw    %ax,%ss             # -&gt; Stack Segment</span><br><span class="line">    7d08:	8e d0                	mov    %eax,%ss</span><br></pre></td></tr></table></figure>
<p>但是执行GDB可以看到，事实上BIOS依然将boot loader加载到了0x7c00的位置，也就是说程序在执行到这里的时候，前面依然有一部分是可以正常执行的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">Breakpoint 1, 0x00007c00 in ?? ()</span><br><span class="line">(gdb) x/40i</span><br><span class="line">   0x7c01:	cld</span><br><span class="line">   0x7c02:	xor    %eax,%eax</span><br><span class="line">   0x7c04:	mov    %eax,%ds</span><br><span class="line">   0x7c06:	mov    %eax,%es</span><br><span class="line">   0x7c08:	mov    %eax,%ss</span><br><span class="line">   0x7c0a:	in     $0x64,%al</span><br><span class="line">   0x7c0c:	test   $0x2,%al</span><br><span class="line">   0x7c0e:	jne    0x7c0a</span><br><span class="line">   0x7c10:	mov    $0xd1,%al</span><br><span class="line">   0x7c12:	out    %al,$0x64</span><br><span class="line">   0x7c14:	in     $0x64,%al</span><br><span class="line">   0x7c16:	test   $0x2,%al</span><br><span class="line">   0x7c18:	jne    0x7c14</span><br><span class="line">   0x7c1a:	mov    $0xdf,%al</span><br><span class="line">   0x7c1c:	out    %al,$0x60</span><br><span class="line">   0x7c1e:	lgdtl  (%esi)</span><br><span class="line">   0x7c21:	fs jge 0x7c33</span><br><span class="line">   0x7c24:	and    %al,%al</span><br><span class="line">   0x7c26:	or     $0x1,%ax</span><br><span class="line">   0x7c2a:	mov    %eax,%cr0</span><br><span class="line">   0x7c2d:	ljmp   $0xb866,$0x87d32</span><br><span class="line">   0x7c34:	adc    %al,(%eax)</span><br><span class="line">   0x7c36:	mov    %eax,%ds</span><br><span class="line">   0x7c38:	mov    %eax,%es</span><br><span class="line">   0x7c3a:	mov    %eax,%fs</span><br><span class="line">   0x7c3c:	mov    %eax,%gs</span><br><span class="line">   0x7c3e:	mov    %eax,%ss</span><br><span class="line">   0x7c40:	mov    $0x7d00,%esp</span><br><span class="line">   0x7c45:	call   0x7d0b</span><br><span class="line">   0x7c4a:	jmp    0x7c4a</span><br><span class="line">   0x7c4c:	add    %al,(%eax)</span><br><span class="line">   0x7c4e:	add    %al,(%eax)</span><br><span class="line">   0x7c50:	add    %al,(%eax)</span><br><span class="line">   0x7c52:	add    %al,(%eax)</span><br><span class="line">   0x7c54:	(bad)</span><br><span class="line">   0x7c55:	incl   (%eax)</span><br><span class="line">   0x7c57:	add    %al,(%eax)</span><br><span class="line">   0x7c59:	lcall  $0x0,$0xffff00cf</span><br><span class="line">   0x7c60:	add    %dl,0x1700cf(%edx)</span><br><span class="line">   0x7c66:	dec    %esp</span><br></pre></td></tr></table></figure>
<p>但是与之前相比而言，对于<code>ljmp</code>指令发生了改变，这里附上之前的内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">Breakpoint 1, 0x00007c00 in ?? ()</span><br><span class="line">(gdb) x/40i</span><br><span class="line">   0x7c01:	cld</span><br><span class="line">   0x7c02:	xor    %eax,%eax</span><br><span class="line">   0x7c04:	mov    %eax,%ds</span><br><span class="line">   0x7c06:	mov    %eax,%es</span><br><span class="line">   0x7c08:	mov    %eax,%ss</span><br><span class="line">   0x7c0a:	in     $0x64,%al</span><br><span class="line">   0x7c0c:	test   $0x2,%al</span><br><span class="line">   0x7c0e:	jne    0x7c0a</span><br><span class="line">   0x7c10:	mov    $0xd1,%al</span><br><span class="line">   0x7c12:	out    %al,$0x64</span><br><span class="line">   0x7c14:	in     $0x64,%al</span><br><span class="line">   0x7c16:	test   $0x2,%al</span><br><span class="line">   0x7c18:	jne    0x7c14</span><br><span class="line">   0x7c1a:	mov    $0xdf,%al</span><br><span class="line">   0x7c1c:	out    %al,$0x60</span><br><span class="line">   0x7c1e:	lgdtl  (%esi)</span><br><span class="line">   0x7c21:	fs jl  0x7c33</span><br><span class="line">   0x7c24:	and    %al,%al</span><br><span class="line">   0x7c26:	or     $0x1,%ax</span><br><span class="line">   0x7c2a:	mov    %eax,%cr0</span><br><span class="line">   0x7c2d:	ljmp   $0xb866,$0x87c32</span><br><span class="line">   0x7c34:	adc    %al,(%eax)</span><br><span class="line">   0x7c36:	mov    %eax,%ds</span><br><span class="line">   0x7c38:	mov    %eax,%es</span><br><span class="line">   0x7c3a:	mov    %eax,%fs</span><br><span class="line">   0x7c3c:	mov    %eax,%gs</span><br><span class="line">   0x7c3e:	mov    %eax,%ss</span><br><span class="line">   0x7c40:	mov    $0x7c00,%esp</span><br><span class="line">   0x7c45:	call   0x7d0b</span><br><span class="line">   0x7c4a:	jmp    0x7c4a</span><br><span class="line">   0x7c4c:	add    %al,(%eax)</span><br><span class="line">   0x7c4e:	add    %al,(%eax)</span><br><span class="line">   0x7c50:	add    %al,(%eax)</span><br><span class="line">   0x7c52:	add    %al,(%eax)</span><br><span class="line">   0x7c54:	(bad)</span><br><span class="line">   0x7c55:	incl   (%eax)</span><br><span class="line">   0x7c57:	add    %al,(%eax)</span><br><span class="line">   0x7c59:	lcall  $0x0,$0xffff00cf</span><br><span class="line">   0x7c60:	add    %dl,0x1700cf(%edx)</span><br><span class="line">   0x7c66:	dec    %esp</span><br></pre></td></tr></table></figure>
<p>可以看到由<code>$0x87c32</code>变成了<code>$0x87d32</code>，在执行完了<code>ljmp</code>指令之后，程序就会出错了。</p>
<h2 id="exercise6"><a class="markdownIt-Anchor" href="#exercise6"></a> Exercise6</h2>
<p>在0x7c00处添加断点，查看0x100000地址存放的内容，可以发现是全0，这就是BIOS在进入boot loader的时候，对应的内容。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0x100000:	0x00000000	0x00000000	0x00000000	0x00000000</span><br><span class="line">0x100010:	0x00000000	0x00000000	0x00000000	0x00000000</span><br></pre></td></tr></table></figure>
<p>之后再0x7d63处添加断点，此时是boot loader要进入内核的时点，0x100000存放的内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0x100000:	0x1badb002	0x00000000	0xe4524ffe	0x7205c766</span><br><span class="line">0x100010:	0x34000004	0x7000b812	0x220f0011	0xc0200fd8</span><br></pre></td></tr></table></figure>
<p>可以发现已经发生了改变，并不是一开始的全0，说明boot loader进行了一个载入内核的工作。</p>
<h2 id="exercise7"><a class="markdownIt-Anchor" href="#exercise7"></a> Exercise7</h2>
<p>从entry.S中，可以看到<code>mov  %eax,%cr0</code>位于入口的开头处，利用gdb在入口处设置断点，逐条执行可以发现，这条指令位于0x100025，在此处设置断点：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/8x 0x00100000</span><br><span class="line">0x100000:	0x1badb002	0x00000000	0xe4524ffe	0x7205c766</span><br><span class="line">0x100010:	0x34000004	0x7000b812	0x220f0011	0xc0200fd8</span><br><span class="line">(gdb) x/8x 0xf0100000</span><br><span class="line">0xf0100000 &lt;_start-268435468&gt;:	0x00000000	0x00000000	0x00000000	0x00000000</span><br><span class="line">0xf0100010 &lt;entry+4&gt;:	0x00000000	0x00000000	0x00000000	0x00000000</span><br></pre></td></tr></table></figure>
<p>执行完这条指令之后：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/8x 0x00100000</span><br><span class="line">0x100000:	0x1badb002	0x00000000	0xe4524ffe	0x7205c766</span><br><span class="line">0x100010:	0x34000004	0x7000b812	0x220f0011	0xc0200fd8</span><br><span class="line">(gdb) x/8x 0xf0100000</span><br><span class="line">0xf0100000 &lt;_start-268435468&gt;:	0x1badb002	0x00000000	0xe4524ffe	0x7205c766</span><br><span class="line">0xf0100010 &lt;entry+4&gt;:	0x34000004	0x7000b812	0x220f0011	0xc0200fd8</span><br></pre></td></tr></table></figure>
<p>可以发现，在执行这条指令之前，0xf0100000处是全0的，在执行之后，有了和0x00100000处一样的值。设置了%cr0后启用分页，让0xf0100000和0x00100000映射到了同样的物理地址，所以查看会有相同的值。</p>
<p>在entry.S中可以看到，之后他尝试执行的指令是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mov	$relocated, %eax</span><br><span class="line">jmp	*%eax</span><br></pre></td></tr></table></figure>
<p>他要在执行C代码之前，跳转到KERNBASE上方，不再在低地址了。从gdb可以发现，这里移入<code>%eax</code>的值为0xf010002f，如果没有启用分页，那么跳转将会失败。</p>
<p>可以发现当注释掉那一行之后，会导致内核崩溃，卡在<code>Booting from Hard Disk..</code>，同时利用GDB查看也可以看到，跳转进入的0xf010002c位置为全0。</p>
<h2 id="exercise8"><a class="markdownIt-Anchor" href="#exercise8"></a> Exercise8</h2>
<p>缺失的内容定义在printfmt.c中第206行，直接仿照上面的<code>%u</code>进行修改，将base改成8就可以了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// (unsigned) octal</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">&#x27;o&#x27;</span>:</span><br><span class="line">	<span class="comment">// Replace this with your code.</span></span><br><span class="line">	num = getuint(&amp;ap, lflag);</span><br><span class="line">	base = <span class="number">8</span>;</span><br><span class="line">	<span class="keyword">goto</span> number;</span><br></pre></td></tr></table></figure>
<p>可以发现，修改完之后，命令行中的&quot;6828 decimal is 15254 octal!&quot;已经可以正确显示了。</p>
<ol>
<li>Explain the interface between <code>printf.c</code> and <code>console.c</code>. Specifically, what function does <code>console.c</code> export? How is this function used by <code>printf.c</code>?</li>
</ol>
<p><code>console.c</code>里面<code>cputchar()</code>函数在<code>printf.c</code>里面被使用了。它的作用是往屏幕上打印一个字符，被用在<code>printf.c</code>里面的<code>putch()</code>函数中，之后作为参数传入<code>vprintfmt()</code>的调用过程。</p>
<ol start="2">
<li>Explain the following from <code>console.c</code>:</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (crt_pos &gt;= CRT_SIZE) &#123;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  memmove(crt_buf, crt_buf + CRT_COLS, (CRT_SIZE - CRT_COLS) * <span class="keyword">sizeof</span>(<span class="type">uint16_t</span>));</span><br><span class="line">  <span class="keyword">for</span> (i = CRT_SIZE - CRT_COLS; i &lt; CRT_SIZE; i++)</span><br><span class="line">    crt_buf[i] = <span class="number">0x0700</span> | <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">  crt_pos -= CRT_COLS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>CRT_SIZE指的应该是crt_buff里面显示缓冲区的大小，所以这里的情况实际是超过缓冲区最大上限的时候的处理方法。<code>memmove()</code>函数的定义如下所示，其作用是将str2处复制n个字符到str1处，在有重叠区域的情况下比<code>memcpy()</code>更加安全。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *<span class="title function_">memmove</span><span class="params">(<span class="type">void</span> *str1, <span class="type">const</span> <span class="type">void</span> *str2, <span class="type">size_t</span> n)</span></span><br></pre></td></tr></table></figure>
<p>所以这里所进行的内容是将缓冲区的内容整体前移了CRT_COLS字符，腾出了一部分的缓冲区空间。</p>
<ol start="3">
<li>
<p>For the following questions you might wish to consult the notes for Lecture 2. These notes cover GCC’s calling convention on the x86.<br />
Trace the execution of the following code step-by-step:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> x = <span class="number">1</span>, y = <span class="number">3</span>, z = <span class="number">4</span>;</span><br><span class="line">cprintf(<span class="string">&quot;x %d, y %x, z %d\n&quot;</span>, x, y, z);</span><br></pre></td></tr></table></figure>
<ul>
<li>In the call to <code>cprintf()</code>, to what does <code>fmt</code> point? To what does <code>ap</code> point?</li>
<li>List (in order of execution) each call to cons_putc, va_arg, and vcprintf. For cons_putc, list its argument as well. For va_arg, list what ap points to before and after the call. For vcprintf list the values of its two arguments.</li>
</ul>
</li>
</ol>
<p>在对于<code>cprintf()</code>的调用当中，<code>fmt</code>指的是格式化的字符串，<code>ap</code>指向的是参数列表。</p>
<p>其中<code>cons_putc()</code>的内容如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// output a character to the console</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">cons_putc</span><span class="params">(<span class="type">int</span> c)</span></span><br><span class="line">&#123;</span><br><span class="line">	serial_putc(c);</span><br><span class="line">	lpt_putc(c);</span><br><span class="line">	cga_putc(c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>他的作用是向console输出一个字符，主要的操作位于<code>cga_putc()</code>内容当中，对于输入来确定字符，然后根据情况进行输出。</p>
<p><code>vcprintf()</code>内容如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">vcprintf</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *fmt, va_list ap)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> cnt = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	vprintfmt((<span class="type">void</span>*)putch, &amp;cnt, fmt, ap);</span><br><span class="line">	<span class="keyword">return</span> cnt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>传入格式化的字符串以及对应的参数列表，然后通过调用<code>vprintfmt()</code>进行输出。</p>
<p>而<code>va_arg()</code>的调用在<code>vprintfmt()</code>当中出现，例如：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">&#x27;*&#x27;</span>:</span><br><span class="line">	precision = va_arg(ap, <span class="type">int</span>);</span><br><span class="line">	<span class="keyword">goto</span> process_precision;</span><br></pre></td></tr></table></figure>
<p>他实现的内容实际上是从<code>ap</code>里面读取一个参数，然后将ap进行一个修改，即通过后面提供的数据类型来进行指针的移动。</p>
<p>这三个函数的关系是<code>vcprintf()</code>中调用了<code>vprintfmt()</code>，在<code>vprintfmt()</code>内部利用<code>va_arg()</code>对格式化字符串中的参数进行解析，之后得到确切的字符串利用<code>cons_putc()</code>函数一个一个字符的向console进行输出。</p>
<ol start="4">
<li>Run the following code.</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0x00646c72</span>;</span><br><span class="line">cprintf(<span class="string">&quot;H%x Wo%s&quot;</span>, <span class="number">57616</span>, &amp;i);</span><br></pre></td></tr></table></figure>
<p>What is the output? Explain how this output is arrived at in the step-by-step manner of the previous exercise.</p>
<p>The output depends on that fact that the x86 is little-endian. If the x86 were instead big-endian what would you set <code>i</code> to in order to yield the same output? Would you need to change 57616 to a different value?</p>
<p>得到的输出为：“He110 World”。</p>
<p>可以知道57616转换成16进制的结果为e110，所以前半部分得到的是He110。</p>
<p>后半部分对应ASCII码表可以知道：</p>
<p><img src="https://s2.loli.net/2023/01/10/8ZGbCXie5tYRn76.jpg" alt="" /></p>
<p>由于小端法存储，0x00646c72的存储实际上是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">72 6c 64 00</span><br></pre></td></tr></table></figure>
<p>对应的字符串就是&quot;rld\0&quot;，得到的后半部分为World。</p>
<p>如果改为大端法，对前半部分不会有影响，后半部分需要改成<code>i = 0x726c6400</code>。</p>
<ol start="5">
<li>In the following code, what is going to be printed after ‘y=’? (note: the answer is not a specific value.) Why does this happen?</li>
</ol>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cprintf(<span class="string">&quot;x=%d y=%d&quot;</span>, <span class="number">3</span>);</span><br></pre></td></tr></table></figure>
<p>执行得到的结果为&quot;x=3 y=-267288596&quot;，因为此处y所对应的<code>%d</code>没有给出，那么他会尝试在栈上读取内容。通过gdb调试可以知道最后传入时候<code>ap = f0117fd4</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(gdb) x/8x 0xf0117fd4</span><br><span class="line">0xf0117fd4:	0x00000003	0xf0117fec	0x00000000	0x00000000</span><br><span class="line">0xf0117fe4:	0x00000000	0x00000000	0x00646c72	0x00000000</span><br></pre></td></tr></table></figure>
<p>查看地址所对应的内容，可以发现所打印出来的y其实就是后面的<code>0xf0117fec</code>转换成int的值。</p>
<ol start="6">
<li>Let’s say that GCC changed its calling convention so that it pushed arguments on the stack in declaration order, so that the last argument is pushed last. How would you have to change cprintf or its interface so that it would still be possible to pass it a variable number of arguments?</li>
</ol>
<p>需要能够从栈顶知道一共有多少参数才能规范后面的行为，通过调整参数顺序，把fmt字符串当做最后一个参数输入，或者添加一个新参数为参数的总个数n放在末尾都可以。</p>
<h2 id="exercise9"><a class="markdownIt-Anchor" href="#exercise9"></a> Exercise9</h2>
<p>在kern/entry.S的末尾可以看到如下代码，在.data段里面为栈预留了KSTKSIZE大小的空间。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.data</span><br><span class="line">###################################################################</span><br><span class="line"># boot stack</span><br><span class="line">###################################################################</span><br><span class="line">	.p2align	PGSHIFT		# force page alignment</span><br><span class="line">	.globl		bootstack</span><br><span class="line">bootstack:</span><br><span class="line">	.space		KSTKSIZE</span><br><span class="line">	.globl		bootstacktop   </span><br><span class="line">bootstacktop:</span><br></pre></td></tr></table></figure>
<p>在obj/kern/kernel.asm中的第56-58行，通过设置%esp来初始化栈的位置。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">	# Set the stack pointer</span><br><span class="line">	movl	$(bootstacktop),%esp</span><br><span class="line">f0100034:	bc 00 80 11 f0       	mov    $0xf0118000,%esp</span><br></pre></td></tr></table></figure>
<p>栈底的位置就是<code>0xf0118000</code>，从高地址往低地址生长。</p>
<p>同时在kern/entry.S的69行处可以看到：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">relocated:</span><br><span class="line"></span><br><span class="line">	# Clear the frame pointer register (EBP)</span><br><span class="line">	# so that once we get into debugging C code,</span><br><span class="line">	# stack backtraces will be terminated properly.</span><br><span class="line">	movl	$0x0,%ebp			# nuke frame pointer</span><br></pre></td></tr></table></figure>
<p>将栈的终点设置为0，这能够使得后面进行的backtrace可以正常终止，不会陷入死循环或者出错访问到栈之外的空间。</p>
<h2 id="exercise10"><a class="markdownIt-Anchor" href="#exercise10"></a> Exercise10</h2>
<p>流程就是不断进行函数的调用，输入的参数每一次都-1，从一开始的5到最后的1然后到达递归终点。</p>
<p>obj/kern/kernel.asm中的对应内容如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">void</span><br><span class="line">test_backtrace(int x)</span><br><span class="line">&#123;</span><br><span class="line">f0100040:	55                   	push   %ebp</span><br><span class="line">f0100041:	89 e5                	mov    %esp,%ebp</span><br><span class="line">f0100043:	53                   	push   %ebx</span><br><span class="line">f0100044:	83 ec 14             	sub    $0x14,%esp</span><br><span class="line">f0100047:	8b 5d 08             	mov    0x8(%ebp),%ebx</span><br><span class="line">	cprintf(&quot;entering test_backtrace %d\n&quot;, x);</span><br><span class="line">f010004a:	89 5c 24 04          	mov    %ebx,0x4(%esp)</span><br><span class="line">f010004e:	c7 04 24 80 18 10 f0 	movl   $0xf0101880,(%esp)</span><br><span class="line">f0100055:	e8 34 09 00 00       	call   f010098e &lt;cprintf&gt;</span><br><span class="line">	if (x &gt; 0)</span><br><span class="line">f010005a:	85 db                	test   %ebx,%ebx</span><br><span class="line">f010005c:	7e 0d                	jle    f010006b &lt;test_backtrace+0x2b&gt;</span><br><span class="line">		test_backtrace(x-1);</span><br><span class="line">f010005e:	8d 43 ff             	lea    -0x1(%ebx),%eax</span><br><span class="line">f0100061:	89 04 24             	mov    %eax,(%esp)</span><br><span class="line">f0100064:	e8 d7 ff ff ff       	call   f0100040 &lt;test_backtrace&gt;</span><br><span class="line">f0100069:	eb 1c                	jmp    f0100087 &lt;test_backtrace+0x47&gt;</span><br><span class="line">	else</span><br><span class="line">		mon_backtrace(0, 0, 0);</span><br><span class="line">f010006b:	c7 44 24 08 00 00 00 	movl   $0x0,0x8(%esp)</span><br><span class="line">f0100072:	00 </span><br><span class="line">f0100073:	c7 44 24 04 00 00 00 	movl   $0x0,0x4(%esp)</span><br><span class="line">f010007a:	00 </span><br><span class="line">f010007b:	c7 04 24 00 00 00 00 	movl   $0x0,(%esp)</span><br><span class="line">f0100082:	e8 cb 06 00 00       	call   f0100752 &lt;mon_backtrace&gt;</span><br><span class="line">	cprintf(&quot;leaving test_backtrace %d\n&quot;, x);</span><br><span class="line">f0100087:	89 5c 24 04          	mov    %ebx,0x4(%esp)</span><br><span class="line">f010008b:	c7 04 24 9c 18 10 f0 	movl   $0xf010189c,(%esp)</span><br><span class="line">f0100092:	e8 f7 08 00 00       	call   f010098e &lt;cprintf&gt;</span><br><span class="line">&#125;</span><br><span class="line">f0100097:	83 c4 14             	add    $0x14,%esp</span><br><span class="line">f010009a:	5b                   	pop    %ebx</span><br><span class="line">f010009b:	5d                   	pop    %ebp</span><br><span class="line">f010009c:	c3                   	ret    </span><br></pre></td></tr></table></figure>
<p>通过:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f0100044:	83 ec 14             	sub    $0x14,%esp</span><br></pre></td></tr></table></figure>
<p>可以看到，每次栈向下生长0x14，并且每一次函数调用都会传入参数，同时保存<code>%ebp</code>和<code>%ebx</code>的值，将其压入栈中。每次栈向下生长0x20。折算成32-bit字的话应当是8个。</p>
<h2 id="exercise11"><a class="markdownIt-Anchor" href="#exercise11"></a> Exercise11</h2>
<p>补全的<code>mon_backtrace()</code>如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">mon_backtrace</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv, <span class="keyword">struct</span> Trapframe *tf)</span></span><br><span class="line">&#123;</span><br><span class="line">	cprintf(<span class="string">&quot;Stack backtrace:\n&quot;</span>);</span><br><span class="line">	<span class="type">uint32_t</span>* ebp = (<span class="type">uint32_t</span>*)read_ebp();</span><br><span class="line">	<span class="keyword">while</span>(ebp)&#123;</span><br><span class="line">		cprintf(<span class="string">&quot;ebp %08x &quot;</span>,ebp);</span><br><span class="line">		cprintf(<span class="string">&quot;eip %08x &quot;</span>,*(ebp+<span class="number">1</span>));</span><br><span class="line">		cprintf(<span class="string">&quot;args&quot;</span>);</span><br><span class="line">		<span class="type">int</span> i;</span><br><span class="line">		<span class="keyword">for</span>(i=<span class="number">2</span>;i&lt;=<span class="number">6</span>;++i)</span><br><span class="line">			cprintf(<span class="string">&quot; %08x&quot;</span>,*(ebp+i));</span><br><span class="line">		cprintf(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">		ebp = (<span class="type">uint32_t</span>*)(*ebp);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行结果如下：</p>
<img src="https://s2.loli.net/2023/01/10/7eJAEYlsKn9qOiW.jpg" alt="image-20200223161749177" style="zoom:50%;" />
<p>可以看到最顶上的是<code>mon_backtrace()</code>函数，下面是五次的<code>test_backtrace()</code>调用，符合题目要求。</p>
<h2 id="exercise12"><a class="markdownIt-Anchor" href="#exercise12"></a> Exercise12</h2>
<p>在<code>debuginfo_eip()</code>中利用<code>stab_binsearch()</code>函数来查找行号，通过观察inc/stab.h中的宏定义可以发现对应的类型应当是N_SLINE，对于搜索得到的结果，将行号从stabs数组中提取填写到info里面。如果lline&gt;rline说明出现了错误，直接返回-1。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">stab_binsearch(stabs, &amp;lline, &amp;rline, N_SLINE, addr);</span><br><span class="line"><span class="keyword">if</span>(lline &lt;= rline)</span><br><span class="line">	info-&gt;eip_line = stabs[lline].n_desc;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">-1</span>;</span><br></pre></td></tr></table></figure>
<p>之后修改<code>mon_backtrace()</code>函数内部如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">mon_backtrace</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv, <span class="keyword">struct</span> Trapframe *tf)</span></span><br><span class="line">&#123;</span><br><span class="line">	cprintf(<span class="string">&quot;Stack backtrace:\n&quot;</span>);</span><br><span class="line">	<span class="type">uint32_t</span>* ebp = (<span class="type">uint32_t</span>*)read_ebp();</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">Eipdebuginfo</span> <span class="title">info</span>;</span></span><br><span class="line">	<span class="keyword">while</span>(ebp)&#123;</span><br><span class="line">		cprintf(<span class="string">&quot;ebp %08x &quot;</span>,ebp);</span><br><span class="line">		cprintf(<span class="string">&quot;eip %08x &quot;</span>,ebp[<span class="number">1</span>]);</span><br><span class="line">		cprintf(<span class="string">&quot;args&quot;</span>);</span><br><span class="line">		<span class="type">int</span> i;</span><br><span class="line">		<span class="keyword">for</span>(i=<span class="number">2</span>;i&lt;=<span class="number">6</span>;++i)</span><br><span class="line">			cprintf(<span class="string">&quot; %08x&quot;</span>,ebp[i]);</span><br><span class="line">		cprintf(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">		debuginfo_eip(ebp[<span class="number">1</span>], &amp;info);</span><br><span class="line">		cprintf(<span class="string">&quot;\t%s:%d: %.*s+%d\n&quot;</span>, info.eip_file, info.eip_line, info.eip_fn_namelen, info.eip_fn_name, ebp[<span class="number">1</span>]-info.eip_fn_addr);</span><br><span class="line"></span><br><span class="line">		ebp = (<span class="type">uint32_t</span>*)(*ebp);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在kern/monitor.c文件中加入新的命令行指令，这样当输入backtrace的时候就会调用<code>mon_backtrace()</code>函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">Command</span> <span class="title">commands</span>[] =</span> &#123;</span><br><span class="line">	&#123; <span class="string">&quot;help&quot;</span>, <span class="string">&quot;Display this list of commands&quot;</span>, mon_help &#125;,</span><br><span class="line">	&#123; <span class="string">&quot;kerninfo&quot;</span>, <span class="string">&quot;Display information about the kernel&quot;</span>, mon_kerninfo &#125;,</span><br><span class="line">	&#123; <span class="string">&quot;backtrace&quot;</span>, <span class="string">&quot;Findout the the value of \%ebp, \%eip and the args of called functions&quot;</span>, mon_backtrace&#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>执行结果如下：</p>
<img src="https://s2.loli.net/2023/01/10/UM3YOkIGv4S6inT.jpg" alt="image-20200223195603628" style="zoom:50%;" />
<p>可见该指令可以成功被调用。</p>
<p>在本地使用<code>make grade</code>评测可以得到满分50分：</p>
<img src="https://s2.loli.net/2023/01/10/UGgApluvSIOZteD.jpg" alt="image-20200223195701827" style="zoom:50%;" />
<h2 id="challenge"><a class="markdownIt-Anchor" href="#challenge"></a> Challenge</h2>
<p>通过<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/ANSI_escape_code">WIKI百科</a>中对于ANSI escape code的描述可以知道，利用\e[可以开启一个控制序列，那么只需要调整在输出字符串的开头控制颜色，在结尾恢复就可以，例如以下代码就会将输出文本调整成红色：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">\e[31m&lt;output string&gt;\e[0m</span><br></pre></td></tr></table></figure>
<p>将<code>mon_backtrace()</code>中打印行号等部分修改如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cprintf(<span class="string">&quot;\t\e[92m%s\e[0m:\e[31m%d\e[0m: \e[36m%.*s+%d\e[0m\n&quot;</span>, info.eip_file, info.eip_line, info.eip_fn_namelen, info.eip_fn_name, ebp[<span class="number">1</span>]-info.eip_fn_addr);</span><br></pre></td></tr></table></figure>
<p>可以看到产生图中所示的彩色输出：</p>
<img src="https://s2.loli.net/2023/01/10/N7Xlr9QpwftGAaE.jpg" alt="image-20200223195925655" style="zoom:50%;" />
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://phimos.github.io/2020/02/21/jiukun/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Pims">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pims的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/21/jiukun/" class="post-title-link" itemprop="url">量化笔试回忆版</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-02-21 05:30:58" itemprop="dateCreated datePublished" datetime="2020-02-21T05:30:58+08:00">2020-02-21</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>某量化的机器学习岗笔试题，回忆如下，虽然我不知道这笔试和金融/机器学习有什么关系。考试时长四个小时，一共七道题，最后两道编程题选一题做就可以，所以平均下来是每题四十分钟。</p>
<h2 id="一-最大回撤"><a class="markdownIt-Anchor" href="#一-最大回撤"></a> 一、最大回撤</h2>
<p>题目背景：考虑一个股票的价格在<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.10903em;">N</span></span></span></span>天内的价格为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>P</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>P</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>P</mi><mi>N</mi></msub></mrow><annotation encoding="application/x-tex">P_1,P_2,\ldots,P_N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.13889em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">1</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mpunct">,</span><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.13889em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">2</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mpunct">,</span><span class="minner">…</span><span class="mpunct">,</span><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.13889em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit" style="margin-right:0.10903em;">N</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span>，一个投资者比较厌恶风险，他所能接受的最大回撤不能超过<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>D</mi></mrow><annotation encoding="application/x-tex">D</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">D</span></span></span></span>，试着计算他在这个最大回撤限制下的最大收益，算法复杂度需要是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>(</mo><mi>N</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">O(N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span>的级别。最大回撤定义为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>max</mi><mo>(</mo><msub><mi>P</mi><mi>i</mi></msub><mo>−</mo><msub><mi>P</mi><mi>j</mi></msub><mo>)</mo><mo separator="true">,</mo><mi>i</mi><mo>&lt;</mo><mi>j</mi></mrow><annotation encoding="application/x-tex">\max(P_i-P_j),i&lt;j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="base textstyle uncramped"><span class="mop">max</span><span class="mopen">(</span><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.13889em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">−</span><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">P</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.13889em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit" style="margin-right:0.05724em;">j</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mclose">)</span><span class="mpunct">,</span><span class="mord mathit">i</span><span class="mrel">&lt;</span><span class="mord mathit" style="margin-right:0.05724em;">j</span></span></span></span>，其中<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow><annotation encoding="application/x-tex">i,j</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.65952em;"></span><span class="strut bottom" style="height:0.85396em;vertical-align:-0.19444em;"></span><span class="base textstyle uncramped"><span class="mord mathit">i</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.05724em;">j</span></span></span></span>都在买卖区间内。</p>
<p>我的解答：双指针+单调队列维护区间最大值</p>
<p>双指针靠左的指向买入日，靠右的指向卖出日，利用单调队列维护买卖区间中的最大值。每次当卖出日右移的时候检查是否满足最大回撤的约束，如果是就尝试更新最大收益，否则的话就左移买入指针，并尝试更新最大收益。卖出指针移动到末端的时候，仍然要依次左移买入指针直到末端，并尝试更新最大收益。由于两个指针都要遍历数组，容易知道复杂度是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>(</mo><mi>n</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">O(n)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathit">n</span><span class="mclose">)</span></span></span></span>的。</p>
<h2 id="二-概率题打乒乓球"><a class="markdownIt-Anchor" href="#二-概率题打乒乓球"></a> 二、概率题——打乒乓球</h2>
<p>题目背景：ABC三个人喜欢打乒乓球，但是一张球桌只能有两个人，所以有如下规则：每次两人对打，输家下场，换场下的人上场和赢家对打。那么三个人都非常好强，想要赢下另外两个人至少一局才算打爽了，（如A要打得爽，那么A需要赢过B也要赢过C），且只有所有人都打爽了球局才会结束，如果任意两个人的对局，都是五五开的，那么考虑以下两种情况：</p>
<ol>
<li>如果第一局AB对阵，B胜利，第二轮BC对阵，C胜利，第三轮AC对阵，A胜利，第四轮AB对阵，A胜利。从这之后到所有人都打爽了，需要打的局数的期望是多少？</li>
<li>如果此时三个人刚刚来打球，那么要所有人都打爽了，需要打的局数的期望是多少？</li>
</ol>
<p>我的解答：</p>
<ol>
<li>
<p>考虑如下的状态转换：</p>
<p><img src="https://s2.loli.net/2023/01/10/P4xHZQa2u3JjYlV.jpg" alt="" /></p>
<p>一共有一下六个状态<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>a</mi><mi>b</mi><mi>c</mi><mi>d</mi><mi>e</mi><mi>f</mi></mrow><annotation encoding="application/x-tex">abcdef</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="base textstyle uncramped"><span class="mord mathit">a</span><span class="mord mathit">b</span><span class="mord mathit">c</span><span class="mord mathit">d</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right:0.10764em;">f</span></span></span></span>，他们对应状态要打的局数期望有以下关系：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mrow><mo fence="true">{</mo><mtable><mtr><mtd><mrow><mi>a</mi><mo>=</mo><mn>1</mn><mo>+</mo><mo>(</mo><mi>c</mi><mo>+</mo><mi>d</mi><mo>)</mo><mi mathvariant="normal">/</mi><mn>2</mn></mrow></mtd></mtr><mtr><mtd><mrow><mi>b</mi><mo>=</mo><mn>1</mn><mo>+</mo><mo>(</mo><mi>a</mi><mo>+</mo><mi>e</mi><mo>)</mo><mi mathvariant="normal">/</mi><mn>2</mn></mrow></mtd></mtr><mtr><mtd><mrow><mi>c</mi><mo>=</mo><mn>1</mn><mo>+</mo><mo>(</mo><mi>a</mi><mo>+</mo><mi>b</mi><mo>)</mo><mi mathvariant="normal">/</mi><mn>2</mn></mrow></mtd></mtr><mtr><mtd><mrow><mi>d</mi><mo>=</mo><mn>1</mn><mo>+</mo><mi>e</mi><mi mathvariant="normal">/</mi><mn>2</mn></mrow></mtd></mtr><mtr><mtd><mrow><mi>e</mi><mo>=</mo><mn>1</mn><mo>+</mo><mo>(</mo><mi>d</mi><mo>+</mo><mi>f</mi><mo>)</mo><mi mathvariant="normal">/</mi><mn>2</mn></mrow></mtd></mtr><mtr><mtd><mrow><mi>f</mi><mo>=</mo><mn>1</mn><mo>+</mo><mo>(</mo><mi>d</mi><mo>+</mo><mi>e</mi><mo>)</mo><mi mathvariant="normal">/</mi><mn>2</mn></mrow></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">\begin{cases}
a = 1 + (c+d)/2
\\
b = 1 + (a+e)/2
\\
c = 1 + (a+b)/2
\\
d = 1 + e/2
\\
e = 1+(d+f)/2
\\
f = 1 + (d+e)/2
\end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:4.570000000000001em;"></span><span class="strut bottom" style="height:8.64em;vertical-align:-4.07em;"></span><span class="base displaystyle textstyle uncramped"><span class="minner displaystyle textstyle uncramped"><span class="style-wrap reset-textstyle textstyle uncramped"><span class="delimsizing mult"><span class="vlist"><span style="top:3.0500100000000003em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:3.0500100000000003em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:2.7500100000000005em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:2.4500100000000007em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:2.150010000000001em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:1.8500100000000008em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:1.5500100000000008em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:1.2500100000000007em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:0.9500100000000007em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-0.000009999999999399378em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-1.1500099999999993em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-1.4500099999999994em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-1.7500099999999994em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-2.0500099999999994em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-2.3500099999999993em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-2.650009999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-2.950009999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-3.2500099999999987em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-3.5500199999999986em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist"><span style="top:-3.562000000000001em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord mathit">a</span><span class="mrel">=</span><span class="mord mathrm">1</span><span class="mbin">+</span><span class="mopen">(</span><span class="mord mathit">c</span><span class="mbin">+</span><span class="mord mathit">d</span><span class="mclose">)</span><span class="mord mathrm">/</span><span class="mord mathrm">2</span></span></span><span style="top:-2.122000000000001em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord mathit">b</span><span class="mrel">=</span><span class="mord mathrm">1</span><span class="mbin">+</span><span class="mopen">(</span><span class="mord mathit">a</span><span class="mbin">+</span><span class="mord mathit">e</span><span class="mclose">)</span><span class="mord mathrm">/</span><span class="mord mathrm">2</span></span></span><span style="top:-0.6820000000000014em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord mathit">c</span><span class="mrel">=</span><span class="mord mathrm">1</span><span class="mbin">+</span><span class="mopen">(</span><span class="mord mathit">a</span><span class="mbin">+</span><span class="mord mathit">b</span><span class="mclose">)</span><span class="mord mathrm">/</span><span class="mord mathrm">2</span></span></span><span style="top:0.757999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord mathit">d</span><span class="mrel">=</span><span class="mord mathrm">1</span><span class="mbin">+</span><span class="mord mathit">e</span><span class="mord mathrm">/</span><span class="mord mathrm">2</span></span></span><span style="top:2.1979999999999995em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord mathit">e</span><span class="mrel">=</span><span class="mord mathrm">1</span><span class="mbin">+</span><span class="mopen">(</span><span class="mord mathit">d</span><span class="mbin">+</span><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mclose">)</span><span class="mord mathrm">/</span><span class="mord mathrm">2</span></span></span><span style="top:3.6380000000000003em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mrel">=</span><span class="mord mathrm">1</span><span class="mbin">+</span><span class="mopen">(</span><span class="mord mathit">d</span><span class="mbin">+</span><span class="mord mathit">e</span><span class="mclose">)</span><span class="mord mathrm">/</span><span class="mord mathrm">2</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span></span></span></span></span></p>
<p>可以解得：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mrow><mo fence="true">{</mo><mtable><mtr><mtd><mrow><mi>a</mi><mo>=</mo><mn>3</mn><mn>6</mn><mi mathvariant="normal">/</mi><mn>5</mn></mrow></mtd></mtr><mtr><mtd><mrow><mi>b</mi><mo>=</mo><mn>3</mn><mn>8</mn><mi mathvariant="normal">/</mi><mn>5</mn></mrow></mtd></mtr><mtr><mtd><mrow><mi>c</mi><mo>=</mo><mn>4</mn><mn>2</mn><mi mathvariant="normal">/</mi><mn>5</mn></mrow></mtd></mtr><mtr><mtd><mrow><mi>d</mi><mo>=</mo><mn>4</mn></mrow></mtd></mtr><mtr><mtd><mrow><mi>e</mi><mo>=</mo><mn>6</mn></mrow></mtd></mtr><mtr><mtd><mrow><mi>f</mi><mo>=</mo><mn>6</mn></mrow></mtd></mtr></mtable></mrow></mrow><annotation encoding="application/x-tex">\begin{cases}
a = 36/5
\\
b = 38/5
\\
c = 42/5
\\
d = 4
\\
e = 6
\\
f = 6
\end{cases}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:4.570000000000001em;"></span><span class="strut bottom" style="height:8.64em;vertical-align:-4.07em;"></span><span class="base displaystyle textstyle uncramped"><span class="minner displaystyle textstyle uncramped"><span class="style-wrap reset-textstyle textstyle uncramped"><span class="delimsizing mult"><span class="vlist"><span style="top:3.0500100000000003em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎩</span></span></span><span style="top:3.0500100000000003em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:2.7500100000000005em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:2.4500100000000007em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:2.150010000000001em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:1.8500100000000008em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:1.5500100000000008em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:1.2500100000000007em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:0.9500100000000007em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-0.000009999999999399378em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎨</span></span></span><span style="top:-1.1500099999999993em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-1.4500099999999994em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-1.7500099999999994em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-2.0500099999999994em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-2.3500099999999993em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-2.650009999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-2.950009999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-3.2500099999999987em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎪</span></span></span><span style="top:-3.5500199999999986em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="delimsizinginner delim-size4"><span>⎧</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span><span class="mord"><span class="mtable"><span class="col-align-l"><span class="vlist"><span style="top:-3.562000000000001em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord mathit">a</span><span class="mrel">=</span><span class="mord mathrm">3</span><span class="mord mathrm">6</span><span class="mord mathrm">/</span><span class="mord mathrm">5</span></span></span><span style="top:-2.122000000000001em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord mathit">b</span><span class="mrel">=</span><span class="mord mathrm">3</span><span class="mord mathrm">8</span><span class="mord mathrm">/</span><span class="mord mathrm">5</span></span></span><span style="top:-0.6820000000000014em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord mathit">c</span><span class="mrel">=</span><span class="mord mathrm">4</span><span class="mord mathrm">2</span><span class="mord mathrm">/</span><span class="mord mathrm">5</span></span></span><span style="top:0.757999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord mathit">d</span><span class="mrel">=</span><span class="mord mathrm">4</span></span></span><span style="top:2.1979999999999995em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord mathit">e</span><span class="mrel">=</span><span class="mord mathrm">6</span></span></span><span style="top:3.6380000000000003em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord mathit" style="margin-right:0.10764em;">f</span><span class="mrel">=</span><span class="mord mathrm">6</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span></span></span></span></span></p>
<p>所以期望应当是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>3</mn><mn>6</mn><mi mathvariant="normal">/</mi><mn>5</mn></mrow><annotation encoding="application/x-tex">36/5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">3</span><span class="mord mathrm">6</span><span class="mord mathrm">/</span><span class="mord mathrm">5</span></span></span></span>轮次</p>
</li>
<li>
<p>我确实不会（菜狗哭泣），用它给的做编程题的窗口写了个代码跑模拟，得到的结果是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>6</mn><mn>2</mn><mi mathvariant="normal">/</mi><mn>5</mn></mrow><annotation encoding="application/x-tex">62/5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">6</span><span class="mord mathrm">2</span><span class="mord mathrm">/</span><span class="mord mathrm">5</span></span></span></span>的期望。</p>
</li>
</ol>
<h2 id="三-报数"><a class="markdownIt-Anchor" href="#三-报数"></a> 三、报数</h2>
<p>题目背景：一共有2019个人依次编号，首尾相连占成一个圈，教练让从1号开始报数，依次报121212，每次报到2的人出局，由于是一个圈，所以可以一直循环下去。</p>
<ol>
<li>问最后留下来的那个人的编号是多少？</li>
<li>小明拿到了1001号，但是他爸是教练，可以选择在任意时候给他爸一个眼神交流，让他爸讲报数顺序逆转，问小明有没有可能留到最后？</li>
</ol>
<p>我的解答：</p>
<ol>
<li>为了叙述方便首先定义轮次，从第1个人跑到最后算一个轮次，那么可以知道从第一轮留下来的都是奇数，相邻的人差的都是2，第二轮留下来的差的都是4，依次类推。所以容易发现每一轮留下来的人，在二进制表示上，有一位是相同的<br />
2019的二进制表示为：</li>
</ol>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><mn>1</mn><mn>1</mn><mtext> </mtext><mn>1</mn><mn>1</mn><mn>1</mn><mn>0</mn><mtext> </mtext><mn>0</mn><mn>0</mn><mn>1</mn><mn>1</mn></mrow><annotation encoding="application/x-tex">   111\ 1110\ 0011
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.64444em;vertical-align:0em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord mathrm">1</span><span class="mord mathrm">1</span><span class="mord mathrm">1</span><span class="mord mspace"> </span><span class="mord mathrm">1</span><span class="mord mathrm">1</span><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mspace"> </span><span class="mord mathrm">0</span><span class="mord mathrm">0</span><span class="mord mathrm">1</span><span class="mord mathrm">1</span></span></span></span></span></p>
<p>将其左移一位，末尾补1，找到在1~2019范围内的值就是所求的值，对应的二进制表示为</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><mn>1</mn><mn>1</mn><mtext> </mtext><mn>1</mn><mn>1</mn><mn>0</mn><mn>0</mn><mtext> </mtext><mn>0</mn><mn>1</mn><mn>1</mn><mn>1</mn></mrow><annotation encoding="application/x-tex">   111\ 1100\ 0111
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.64444em;vertical-align:0em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord mathrm">1</span><span class="mord mathrm">1</span><span class="mord mathrm">1</span><span class="mord mspace"> </span><span class="mord mathrm">1</span><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mathrm">0</span><span class="mord mspace"> </span><span class="mord mathrm">0</span><span class="mord mathrm">1</span><span class="mord mathrm">1</span><span class="mord mathrm">1</span></span></span></span></span></p>
<p>即留下来的是1991号。</p>
<ol start="2">
<li>有了前面的推断方法，我们可以判断在一共<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.43056em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit">n</span></span></span></span>个人的队列中，处于第<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>k</mi></mrow><annotation encoding="application/x-tex">k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.69444em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.03148em;">k</span></span></span></span>个的时候是不是最后留下来的，考虑1001的二进制表示为：</li>
</ol>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>0</mn><mn>1</mn><mn>1</mn><mtext> </mtext><mn>1</mn><mn>1</mn><mn>1</mn><mn>0</mn><mtext> </mtext><mn>1</mn><mn>0</mn><mn>0</mn><mn>1</mn></mrow><annotation encoding="application/x-tex">   011\ 1110\ 1001
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.64444em;vertical-align:0em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord mathrm">0</span><span class="mord mathrm">1</span><span class="mord mathrm">1</span><span class="mord mspace"> </span><span class="mord mathrm">1</span><span class="mord mathrm">1</span><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mspace"> </span><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mathrm">0</span><span class="mord mathrm">1</span></span></span></span></span></p>
<p>在倒数第二位的二进制表示出现不同，那么可以知道如果他爸不改顺序的话，他计划是在第二轮就被淘汰的。<br />
这里进行讨论，首先看在第一轮的情况下，如果他爸在报数还没报到他的情况下就反转了，能不能让他留到最后。假设在他前面已经有<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.43056em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit">n</span></span></span></span>个人出局了，那么就还剩下了<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>2</mn><mn>0</mn><mn>1</mn><mn>9</mn><mo>−</mo><mi>n</mi></mrow><annotation encoding="application/x-tex">2019-n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">2</span><span class="mord mathrm">0</span><span class="mord mathrm">1</span><span class="mord mathrm">9</span><span class="mbin">−</span><span class="mord mathit">n</span></span></span></span>个人，由于在他之前，所以可以知道<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi><mo>&lt;</mo><mo>=</mo><mn>5</mn><mn>0</mn><mn>0</mn></mrow><annotation encoding="application/x-tex">n&lt;=500</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.68354em;vertical-align:-0.0391em;"></span><span class="base textstyle uncramped"><span class="mord mathit">n</span><span class="mrel">&lt;</span><span class="mrel">=</span><span class="mord mathrm">5</span><span class="mord mathrm">0</span><span class="mord mathrm">0</span></span></span></span>，必定有<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>2</mn><mn>0</mn><mn>1</mn><mn>9</mn><mo>−</mo><mi>n</mi><mo>&gt;</mo><mo>=</mo><mn>1</mn><mn>5</mn><mn>1</mn><mn>9</mn><mo>&gt;</mo><mn>1</mn><mn>0</mn><mn>2</mn><mn>4</mn></mrow><annotation encoding="application/x-tex">2019-n&gt;=1519&gt;1024</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">2</span><span class="mord mathrm">0</span><span class="mord mathrm">1</span><span class="mord mathrm">9</span><span class="mbin">−</span><span class="mord mathit">n</span><span class="mrel">&gt;</span><span class="mrel">=</span><span class="mord mathrm">1</span><span class="mord mathrm">5</span><span class="mord mathrm">1</span><span class="mord mathrm">9</span><span class="mrel">&gt;</span><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mathrm">2</span><span class="mord mathrm">4</span></span></span></span>，所以二进制表示保持有11位。<br />
他爸有两种方法，一个是在第<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>2</mn><mi>n</mi></mrow><annotation encoding="application/x-tex">2n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.64444em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">2</span><span class="mord mathit">n</span></span></span></span>号出局的时候，立刻反转由<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>2</mn><mi>n</mi><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2n-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">2</span><span class="mord mathit">n</span><span class="mbin">−</span><span class="mord mathrm">1</span></span></span></span>号开始报1，他在队列中排<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><mn>0</mn><mn>1</mn><mn>9</mn><mo>+</mo><mi>n</mi></mrow><annotation encoding="application/x-tex">1019+n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mathrm">1</span><span class="mord mathrm">9</span><span class="mbin">+</span><span class="mord mathit">n</span></span></span></span>位，另一种是在<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>2</mn><mi>n</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2n+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">2</span><span class="mord mathit">n</span><span class="mbin">+</span><span class="mord mathrm">1</span></span></span></span>号报了1之后在进行反转，他在队列中排<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><mn>0</mn><mn>1</mn><mn>9</mn><mo>+</mo><mi>n</mi><mo>+</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">1019+n+1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.72777em;vertical-align:-0.08333em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mathrm">1</span><span class="mord mathrm">9</span><span class="mbin">+</span><span class="mord mathit">n</span><span class="mbin">+</span><span class="mord mathrm">1</span></span></span></span>位。<br />
为了使得他能够留到最后，那么要满足以上情况：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>(</mo><mn>2</mn><mn>0</mn><mn>1</mn><mn>9</mn><mo>−</mo><mi>n</mi><mo>−</mo><mn>1</mn><mn>0</mn><mn>2</mn><mn>4</mn><mo>)</mo><mo>∗</mo><mn>2</mn><mo>+</mo><mn>1</mn><mo>=</mo><mn>1</mn><mn>0</mn><mn>1</mn><mn>9</mn><mo>+</mo><mi>n</mi><mo>(</mo><mo>+</mo><mn>1</mn><mo>)</mo></mrow><annotation encoding="application/x-tex">   (2019-n-1024)*2+1 = 1019+n(+1)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base displaystyle textstyle uncramped"><span class="mopen">(</span><span class="mord mathrm">2</span><span class="mord mathrm">0</span><span class="mord mathrm">1</span><span class="mord mathrm">9</span><span class="mbin">−</span><span class="mord mathit">n</span><span class="mbin">−</span><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mathrm">2</span><span class="mord mathrm">4</span><span class="mclose">)</span><span class="mbin">∗</span><span class="mord mathrm">2</span><span class="mbin">+</span><span class="mord mathrm">1</span><span class="mrel">=</span><span class="mord mathrm">1</span><span class="mord mathrm">0</span><span class="mord mathrm">1</span><span class="mord mathrm">9</span><span class="mbin">+</span><span class="mord mathit">n</span><span class="mopen">(</span><span class="mord">+</span><span class="mord mathrm">1</span><span class="mclose">)</span></span></span></span></span></p>
<p>此处的<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>(</mo><mo>+</mo><mn>1</mn><mo>)</mo></mrow><annotation encoding="application/x-tex">(+1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mopen">(</span><span class="mord">+</span><span class="mord mathrm">1</span><span class="mclose">)</span></span></span></span>表示两种情况，整理可以得到：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>9</mn><mn>7</mn><mn>2</mn><mo>=</mo><mn>3</mn><mi>n</mi><mo>(</mo><mo>+</mo><mn>1</mn><mo>)</mo></mrow><annotation encoding="application/x-tex">   972= 3n(+1)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord mathrm">9</span><span class="mord mathrm">7</span><span class="mord mathrm">2</span><span class="mrel">=</span><span class="mord mathrm">3</span><span class="mord mathit">n</span><span class="mopen">(</span><span class="mord">+</span><span class="mord mathrm">1</span><span class="mclose">)</span></span></span></span></span></p>
<p>可以发现，当不带<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>(</mo><mo>+</mo><mn>1</mn><mo>)</mo></mrow><annotation encoding="application/x-tex">(+1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mopen">(</span><span class="mord">+</span><span class="mord mathrm">1</span><span class="mclose">)</span></span></span></span>的时候，<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi></mrow><annotation encoding="application/x-tex">n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.43056em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit">n</span></span></span></span>是存在解的，即<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>n</mi><mo>=</mo><mn>3</mn><mn>2</mn><mn>4</mn></mrow><annotation encoding="application/x-tex">n=324</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.64444em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit">n</span><span class="mrel">=</span><span class="mord mathrm">3</span><span class="mord mathrm">2</span><span class="mord mathrm">4</span></span></span></span>，所以在628号淘汰出局的时候，他爸立刻转向，让627号报1，小明就可以成为留到最后的人。</p>
<h2 id="四-桥牌"><a class="markdownIt-Anchor" href="#四-桥牌"></a> 四、桥牌</h2>
<p>问题背景：</p>
<ol>
<li>一共除去大小王有52张牌，每人13张牌，大小次序为AKQJT98765432。</li>
<li>桥牌分为东南西北四家，其中南北为一队，东西为一队。按西北东南顺序出牌。</li>
<li>每一轮要根据第一轮出牌的花色来出牌，没有的话只能出其他花色的垫牌，垫牌必定小。这一轮最大的下一轮首先出牌。</li>
<li>西家先出牌，南北获胜的方法是赢下所有十三轮，东西获胜只要赢下一轮就可以。</li>
</ol>
<p>问当四人都明牌的情况下，南北方的必胜策略是什么？</p>
<ol>
<li>西家先出红心T</li>
</ol>
<table>
<thead>
<tr>
<th></th>
<th>西</th>
<th>北</th>
<th>东</th>
<th>南</th>
</tr>
</thead>
<tbody>
<tr>
<td>黑桃</td>
<td>J876</td>
<td>A5432</td>
<td></td>
<td>KQT9</td>
</tr>
<tr>
<td>红心</td>
<td>[T]98</td>
<td>AKQ</td>
<td>7654</td>
<td>J32</td>
</tr>
<tr>
<td>方片</td>
<td>876</td>
<td>J2</td>
<td>T9543</td>
<td>AKQ</td>
</tr>
<tr>
<td>梅花</td>
<td>654</td>
<td>A32</td>
<td>T987</td>
<td>KQJ</td>
</tr>
</tbody>
</table>
<ol start="2">
<li>西家先出红心T</li>
</ol>
<table>
<thead>
<tr>
<th></th>
<th>西</th>
<th>北</th>
<th>东</th>
<th>南</th>
</tr>
</thead>
<tbody>
<tr>
<td>黑桃</td>
<td>76</td>
<td>AKQ5</td>
<td>JT98</td>
<td>432</td>
</tr>
<tr>
<td>红心</td>
<td>[T]987</td>
<td>KQJ</td>
<td>65</td>
<td>A432</td>
</tr>
<tr>
<td>方片</td>
<td>T98</td>
<td>5432</td>
<td>76</td>
<td>AKQJ</td>
</tr>
<tr>
<td>梅花</td>
<td>7654</td>
<td>A2</td>
<td>KJT98</td>
<td>Q3</td>
</tr>
</tbody>
</table>
<ol start="3">
<li>西家先出红心6</li>
</ol>
<table>
<thead>
<tr>
<th></th>
<th>西</th>
<th>北</th>
<th>东</th>
<th>南</th>
</tr>
</thead>
<tbody>
<tr>
<td>黑桃</td>
<td>J9876</td>
<td>A54</td>
<td>KT</td>
<td>Q32</td>
</tr>
<tr>
<td>红心</td>
<td>[6]5</td>
<td>432</td>
<td>KQJ987</td>
<td>AT</td>
</tr>
<tr>
<td>方片</td>
<td>7</td>
<td>AKQ6543</td>
<td>JT98</td>
<td>2</td>
</tr>
<tr>
<td>梅花</td>
<td>65432</td>
<td></td>
<td>T</td>
<td>AKQJ987</td>
</tr>
</tbody>
</table>
<p>我的解答：真是绝了，这道题杀我，太久没打牌而陷入思维陷阱，笔试就只做出了第一个。</p>
<ol>
<li>红心方片梅花北南都是绝对大，所以直接到下面这种情况，由于之前都是绝对大，此时北南可以控制由哪一边出牌</li>
</ol>
<table>
<thead>
<tr>
<th></th>
<th>西</th>
<th>北</th>
<th>东</th>
<th>南</th>
</tr>
</thead>
<tbody>
<tr>
<td>黑桃</td>
<td>J8</td>
<td>A5</td>
<td></td>
<td>T9</td>
</tr>
</tbody>
</table>
<p>此时南家出9，如果西家出J，北家出A大。如果西家出8，那么北家出5，让南家大。</p>
<ol start="2">
<li>南北两家出红心方片在可以绝对大八轮，在这中间北家垫牌梅花2，出梅花A大一轮，这个时候东家要垫四张牌，此时都是南家大。</li>
</ol>
<table>
<thead>
<tr>
<th></th>
<th>北</th>
<th>东（垫4张）</th>
<th>南</th>
</tr>
</thead>
<tbody>
<tr>
<td>黑桃</td>
<td>AKQ5</td>
<td>JT98</td>
<td>432</td>
</tr>
<tr>
<td>梅花</td>
<td></td>
<td>KJT9</td>
<td>Q</td>
</tr>
</tbody>
</table>
<p>如果东家垫的全部都是梅花，那么南家出梅花Q，北家垫掉黑桃5，之后北家三轮大。</p>
<p>如果东家垫过黑桃，那么北家黑桃AKQ5四轮都大。</p>
<ol start="3">
<li>第一轮打完东家出J逼南家出A大，之后北家有方片AKQ三张绝对大，之后难上手，一定会打掉梅花七张牌。由于西家黑桃J大不过北家的A和南家的Q，所以这里略去西家。</li>
</ol>
<table>
<thead>
<tr>
<th></th>
<th>北（垫7张）</th>
<th>东（垫6张）</th>
<th>南</th>
</tr>
</thead>
<tbody>
<tr>
<td>黑桃</td>
<td>A54</td>
<td>KT</td>
<td>Q32</td>
</tr>
<tr>
<td>红心</td>
<td>43</td>
<td>KQ987</td>
<td>T</td>
</tr>
<tr>
<td>方片</td>
<td>AKQ6543</td>
<td>JT98</td>
<td>2</td>
</tr>
</tbody>
</table>
<p>首先可以确定北家必定上手，那么东家不会留超过两张红心，红心789首先会被垫干净。</p>
<table>
<thead>
<tr>
<th></th>
<th>北（垫7张）</th>
<th>东（垫3张）</th>
<th>南</th>
</tr>
</thead>
<tbody>
<tr>
<td>黑桃</td>
<td>A54</td>
<td>KT</td>
<td>Q32</td>
</tr>
<tr>
<td>红心</td>
<td>43</td>
<td>KQ</td>
<td>T</td>
</tr>
<tr>
<td>方片</td>
<td>AKQ6543</td>
<td>JT98</td>
<td>2</td>
</tr>
</tbody>
</table>
<p>之后北家角度来看，东家必然垫完了987之后，北家和南家都无法打过东家的牌，必然不会再打红心，所以北家的两张红心也会被垫干净</p>
<table>
<thead>
<tr>
<th></th>
<th>北（垫5张）</th>
<th>东（垫3张）</th>
<th>南</th>
</tr>
</thead>
<tbody>
<tr>
<td>黑桃</td>
<td>A54</td>
<td>KT</td>
<td>Q32</td>
</tr>
<tr>
<td>红心</td>
<td></td>
<td>KQ</td>
<td>T</td>
</tr>
<tr>
<td>方片</td>
<td>AKQ6543</td>
<td>JT98</td>
<td>2</td>
</tr>
</tbody>
</table>
<p>那么北家不会再打红心，东家继续拿着两张红心是不合理的，但是南家还有一张红心，所以红心Q也会被垫掉</p>
<table>
<thead>
<tr>
<th></th>
<th>北（垫5张）</th>
<th>东（垫2张）</th>
<th>南</th>
</tr>
</thead>
<tbody>
<tr>
<td>黑桃</td>
<td>A54</td>
<td>KT</td>
<td>Q32</td>
</tr>
<tr>
<td>红心</td>
<td></td>
<td>K</td>
<td>T</td>
</tr>
<tr>
<td>方片</td>
<td>AKQ6543</td>
<td>JT98</td>
<td>2</td>
</tr>
</tbody>
</table>
<p>这个时候，由于轮次的问题，北家必须要垫掉四张牌，然后才轮到东家决策，北家垫掉方片3456</p>
<table>
<thead>
<tr>
<th></th>
<th>北（垫1张）</th>
<th>东（垫2张）</th>
<th>南</th>
</tr>
</thead>
<tbody>
<tr>
<td>黑桃</td>
<td>A54</td>
<td>KT</td>
<td>Q32</td>
</tr>
<tr>
<td>红心</td>
<td></td>
<td>K</td>
<td>T</td>
</tr>
<tr>
<td>方片</td>
<td>AKQ</td>
<td>JT98</td>
<td>2</td>
</tr>
</tbody>
</table>
<p>此时东家必定垫掉方片8，之后北家垫掉黑桃4</p>
<table>
<thead>
<tr>
<th></th>
<th>北</th>
<th>东（垫1张）</th>
<th>南</th>
</tr>
</thead>
<tbody>
<tr>
<td>黑桃</td>
<td>A5</td>
<td>KT</td>
<td>Q32</td>
</tr>
<tr>
<td>红心</td>
<td></td>
<td>K</td>
<td>T</td>
</tr>
<tr>
<td>方片</td>
<td>AKQ</td>
<td>JT9</td>
<td>2</td>
</tr>
</tbody>
</table>
<p>东家肯定不会再动方片，那么最后一张垫牌就在红心K和黑桃T之间决策。</p>
<p>如果东家垫了黑桃T，那么南家走一张黑桃2，牌权交给北家，北家打完之后打掉方片三张，之后用一张黑桃5让南家黑桃Q大，游戏结束。</p>
<p>如果东家垫了红心K，那么南家走一张红心T可以大一轮，北家垫掉黑桃5，之后北家四张牌都是绝对大，游戏结束。</p>
<h2 id="五-个人项目简答"><a class="markdownIt-Anchor" href="#五-个人项目简答"></a> 五、个人项目简答</h2>
<p>就一个有关自己曾经做过项目的简答题，要求简明扼要，所占的分并不多。</p>
<h2 id="六-算法编程信封嵌套"><a class="markdownIt-Anchor" href="#六-算法编程信封嵌套"></a> 六、算法编程——信封嵌套</h2>
<p>问题背景：给定<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.10903em;">N</span></span></span></span>个信封，每个信封由两个数<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>w</mi><mo separator="true">,</mo><mi>h</mi></mrow><annotation encoding="application/x-tex">w,h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02691em;">w</span><span class="mpunct">,</span><span class="mord mathit">h</span></span></span></span>描述，表示信封的宽和高，如果一个信封的宽和高分别小于另外一个信封，那么就可以放入另一个信封，每个信封都可以进行90°的旋转，所以<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>w</mi><mo separator="true">,</mo><mi>h</mi></mrow><annotation encoding="application/x-tex">w,h</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.69444em;"></span><span class="strut bottom" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02691em;">w</span><span class="mpunct">,</span><span class="mord mathit">h</span></span></span></span>是可以互换的。</p>
<ol>
<li>求出嵌套层数最多的方案。</li>
<li>如果不是信封而是三维盒子，求出嵌套最多的方案。</li>
</ol>
<p>我的解答：在我的算法中，信封和盒子都没有任何区别，所以这里统一考虑。</p>
<p>容易写出针对于两个信封比较的函数，即一个信封能否装下另一个信封。对每两个信封都做一个对比，如果<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi></mrow><annotation encoding="application/x-tex">A</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit">A</span></span></span></span>信封能够装下<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>B</mi></mrow><annotation encoding="application/x-tex">B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.05017em;">B</span></span></span></span>信封，那么建立一条<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>A</mi><mo>→</mo><mi>B</mi></mrow><annotation encoding="application/x-tex">A \rightarrow B</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit">A</span><span class="mrel">→</span><span class="mord mathit" style="margin-right:0.05017em;">B</span></span></span></span>的连边。这样就构成了一个有向无环图，问题转变成了求图上的最长路径。</p>
<p>采用图上动态规划的方法来进行求解，每个节点上的val表示这个节点的信封作为最外层，所能够嵌套的层数，如果这个节点没有出边，那么将其val设置为1。否则的话，将他的val设置为子节点最大的val再加上1。遍历完整张图之后得到的最大的val值就是最大的嵌套层数。然后从有最大val值的节点进行一个DFS，就可以找到嵌套层数最多的方案。</p>
<p>建图的时间复杂度为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>(</mo><msup><mi>N</mi><mn>2</mn></msup><mo>)</mo></mrow><annotation encoding="application/x-tex">O(N^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.8141079999999999em;"></span><span class="strut bottom" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathit" style="margin-right:0.10903em;">N</span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord mathrm">2</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mclose">)</span></span></span></span>，进行遍历的时间复杂度为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>(</mo><mi>N</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">O(N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span>，所以总的时间复杂度为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>(</mo><msup><mi>n</mi><mn>2</mn></msup><mo>)</mo></mrow><annotation encoding="application/x-tex">O(n^2)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.8141079999999999em;"></span><span class="strut bottom" style="height:1.064108em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord"><span class="mord mathit">n</span><span class="vlist"><span style="top:-0.363em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord mathrm">2</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mclose">)</span></span></span></span>。可能有<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>(</mo><mi>N</mi><mi>log</mi><mi>N</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">O(N\log N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.10903em;">N</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord mathit" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span>的解法？</p>
<p>Update：首先将两个数值进行排序，小的为高，大的为宽。之后对于一个排序，另一个利用树状数组进行维护，查看有多少高宽都小于它的信封就可以了，时间复杂度<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>(</mo><mi>N</mi><mi>log</mi><mi>N</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">O(N\log N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.10903em;">N</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord mathit" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span>。</p>
<h2 id="七-算法编程螺旋数组"><a class="markdownIt-Anchor" href="#七-算法编程螺旋数组"></a> 七、算法编程——螺旋数组</h2>
<p>问题背景：给定一个边长为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>N</mi></mrow><annotation encoding="application/x-tex">N</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.10903em;">N</span></span></span></span>，数值由行列递增的方阵，问顺时针螺旋来读的话，第<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.07153em;">K</span></span></span></span>位数字是什么？要求算法能够在合理时间内求解<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>N</mi><mo>=</mo><mn>3</mn><mn>0</mn><mn>0</mn><mn>0</mn><mn>0</mn><mn>0</mn><mn>0</mn><mn>0</mn></mrow><annotation encoding="application/x-tex">N=30000000</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.10903em;">N</span><span class="mrel">=</span><span class="mord mathrm">3</span><span class="mord mathrm">0</span><span class="mord mathrm">0</span><span class="mord mathrm">0</span><span class="mord mathrm">0</span><span class="mord mathrm">0</span><span class="mord mathrm">0</span><span class="mord mathrm">0</span></span></span></span>量级的输入。</p>
<p>例如一个<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>N</mi><mo>=</mo><mn>3</mn></mrow><annotation encoding="application/x-tex">N=3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.10903em;">N</span><span class="mrel">=</span><span class="mord mathrm">3</span></span></span></span>的方阵，数值就为：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mtable><mtr><mtd><mrow><mn>1</mn></mrow></mtd><mtd><mrow><mn>2</mn></mrow></mtd><mtd><mrow><mn>3</mn></mrow></mtd></mtr><mtr><mtd><mrow><mn>4</mn></mrow></mtd><mtd><mrow><mn>5</mn></mrow></mtd><mtd><mrow><mn>6</mn></mrow></mtd></mtr><mtr><mtd><mrow><mn>7</mn></mrow></mtd><mtd><mrow><mn>8</mn></mrow></mtd><mtd><mrow><mn>9</mn></mrow></mtd></mtr><mtr><mtd><mrow></mrow></mtd></mtr></mtable></mrow><annotation encoding="application/x-tex">\begin{matrix}1&amp;2&amp;3\\4&amp;5&amp;6\\7&amp;8&amp;9\\\end{matrix}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:2.6500000000000004em;"></span><span class="strut bottom" style="height:4.800000000000001em;vertical-align:-2.1500000000000004em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mtable"><span class="col-align-c"><span class="vlist"><span style="top:-1.8100000000000003em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord mathrm">1</span></span></span><span style="top:-0.6100000000000001em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord mathrm">4</span></span></span><span style="top:0.5900000000000001em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord mathrm">7</span></span></span><span style="top:1.7900000000000003em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist"><span style="top:-1.8100000000000003em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord mathrm">2</span></span></span><span style="top:-0.6100000000000001em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord mathrm">5</span></span></span><span style="top:0.5900000000000001em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord mathrm">8</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="arraycolsep" style="width:0.5em;"></span><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-c"><span class="vlist"><span style="top:-1.8100000000000003em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord mathrm">3</span></span></span><span style="top:-0.6100000000000001em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord mathrm">6</span></span></span><span style="top:0.5900000000000001em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord mathrm">9</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span></span></span></span></p>
<p>此时顺时针螺旋读的话，顺序就是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>1</mn><mo separator="true">,</mo><mn>2</mn><mo separator="true">,</mo><mn>3</mn><mo separator="true">,</mo><mn>6</mn><mo separator="true">,</mo><mn>9</mn><mo separator="true">,</mo><mn>8</mn><mo separator="true">,</mo><mn>7</mn><mo separator="true">,</mo><mn>4</mn><mo separator="true">,</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">1,2,3,6,9,8,7,4,5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.8388800000000001em;vertical-align:-0.19444em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">1</span><span class="mpunct">,</span><span class="mord mathrm">2</span><span class="mpunct">,</span><span class="mord mathrm">3</span><span class="mpunct">,</span><span class="mord mathrm">6</span><span class="mpunct">,</span><span class="mord mathrm">9</span><span class="mpunct">,</span><span class="mord mathrm">8</span><span class="mpunct">,</span><span class="mord mathrm">7</span><span class="mpunct">,</span><span class="mord mathrm">4</span><span class="mpunct">,</span><span class="mord mathrm">5</span></span></span></span>，所以对于<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>N</mi><mo>=</mo><mn>3</mn><mo separator="true">,</mo><mi>K</mi><mo>=</mo><mn>4</mn></mrow><annotation encoding="application/x-tex">N=3,K=4</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.10903em;">N</span><span class="mrel">=</span><span class="mord mathrm">3</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.07153em;">K</span><span class="mrel">=</span><span class="mord mathrm">4</span></span></span></span>的情况得到的结果就是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mn>6</mn></mrow><annotation encoding="application/x-tex">6</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.64444em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathrm">6</span></span></span></span>。</p>
<p>输入：两个整数<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>N</mi><mo separator="true">,</mo><mi>K</mi></mrow><annotation encoding="application/x-tex">N,K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.10903em;">N</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.07153em;">K</span></span></span></span></p>
<p>输出：一个整数</p>
<p>我的解答：首先确定对于<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.07153em;">K</span></span></span></span>个数，是属于第几个圈，之后确定第<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>K</mi></mrow><annotation encoding="application/x-tex">K</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.07153em;">K</span></span></span></span>个数的行和列，然后计算得到结果。</p>
<p>时间复杂度为<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>(</mo><mi>log</mi><mi>N</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">O(\log N)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord mathit" style="margin-right:0.10903em;">N</span><span class="mclose">)</span></span></span></span>，如果不考虑计算开方的复杂度可以认为是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>O</mi><mo>(</mo><mn>1</mn><mo>)</mo></mrow><annotation encoding="application/x-tex">O(1)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.02778em;">O</span><span class="mopen">(</span><span class="mord mathrm">1</span><span class="mclose">)</span></span></span></span>的。</p>
<h2 id="八-总结"><a class="markdownIt-Anchor" href="#八-总结"></a> 八、总结</h2>
<p>笔试时长一共4个小时，除去高中竞赛之后好像基本没考过这么长的考试了。内容基本上全是智力测试，专业知识（金融知识）的考察基本为零，我觉得毫无准备硬冲基本非常容易一脸懵逼（对就是我）。不知道能不能过笔试（菜狗哭泣）。</p>
<h2 id="update"><a class="markdownIt-Anchor" href="#update"></a> Update</h2>
<p>我这空了一道大题，编程算法题复杂度还写高了的居然过了笔试，不愧是我。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://phimos.github.io/2020/02/15/RN-ResNet/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Pims">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pims的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/15/RN-ResNet/" class="post-title-link" itemprop="url">[论文笔记] (ResNet) Deep Residual Learning for Image Recognition</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-02-15 07:05:04" itemprop="dateCreated datePublished" datetime="2020-02-15T07:05:04+08:00">2020-02-15</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="简介"><a class="markdownIt-Anchor" href="#简介"></a> 简介</h2>
<p>从以往的实验中可以知道，神经网络中的深度是非常重要的，但是深度越深，网络就越难进行训练。存在Degradetion Problem：随着网络深度增加，训练集上的准确度可能会下降：</p>
<p><img src="https://s2.loli.net/2023/01/10/b1LfXTaOkjdIxHl.jpg" alt="" /></p>
<p>这说明并不是所有的网络结构都是好进行优化的。于是这篇论文提出了一种可以构建深层神经网络的结构：将原本的输入与一个浅层网络的输出相加作为最终的输出，然后将这样的结构进行堆叠。</p>
<img src="https://s2.loli.net/2023/01/10/wnAfH6x95qhuFR3.jpg" alt="image-20200215204852591" style="zoom:50%;" />
<p>和直接尝试让神经网络去拟合最终期望的函数不同，这里尝试让他去拟合一个残差映射。就好比本来希望得到的函数是<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mrow><mi mathvariant="script">H</mi></mrow><mo>(</mo><mi>x</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">\mathcal{H}(x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord mathcal" style="margin-right:0.00965em;">H</span></span><span class="mopen">(</span><span class="mord mathit">x</span><span class="mclose">)</span></span></span></span>，这里我们让它去拟合一个<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mrow><mi mathvariant="script">F</mi></mrow><mo>(</mo><mi>x</mi><mo>)</mo><mo>=</mo><mrow><mi mathvariant="script">H</mi></mrow><mo>(</mo><mi>x</mi><mo>)</mo><mo>−</mo><mi>x</mi></mrow><annotation encoding="application/x-tex">\mathcal{F}(x) = \mathcal{H}(x)-x</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord mathcal" style="margin-right:0.09931em;">F</span></span><span class="mopen">(</span><span class="mord mathit">x</span><span class="mclose">)</span><span class="mrel">=</span><span class="mord textstyle uncramped"><span class="mord mathcal" style="margin-right:0.00965em;">H</span></span><span class="mopen">(</span><span class="mord mathit">x</span><span class="mclose">)</span><span class="mbin">−</span><span class="mord mathit">x</span></span></span></span>的映射，这样最终仍然可以得到原本的映射。我们假设这样可以得到相同的最终结果，并且这种结构更容易进行训练。</p>
<p>在极限情况下，可能identity是更优的，那么回是残差趋近于0，整个块就等同于一个非线性函数。在这里可以看做原本的堆叠之上添加了一些短路连接，但是短路连接并不会增加额外的参数和计算复杂度。所以可以认为ResNet最坏的结果只是增加了无用的层数，理论上不会使结果变得更差</p>
<p>论文作者在ImageNet的实验中得到了两个结论：</p>
<ol>
<li>利用残差连接的深度网络可以很好地进行优化，而直接进行堆叠的普通网络随着层数加深可能会难以收敛</li>
<li>残差网络可以从额外的深度中获得提升，更深的网络可以得到更好地结果。</li>
</ol>
<h2 id="具体结构"><a class="markdownIt-Anchor" href="#具体结构"></a> 具体结构</h2>
<p>对每一个基本块可以看成这样一个结构：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mrow><mi mathvariant="bold">y</mi></mrow><mo>=</mo><mrow><mi mathvariant="script">F</mi></mrow><mrow><mo fence="true">(</mo><mrow><mi mathvariant="bold">x</mi></mrow><mo separator="true">,</mo><mrow><mo fence="true">{</mo><msub><mi>W</mi><mrow><mi>i</mi></mrow></msub><mo fence="true">}</mo></mrow><mo fence="true">)</mo></mrow><mo>+</mo><mrow><mi mathvariant="bold">x</mi></mrow></mrow><annotation encoding="application/x-tex">\mathbf{y}=\mathcal{F}\left(\mathbf{x},\left\{W_{i}\right\}\right)+\mathbf{x}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord displaystyle textstyle uncramped"><span class="mord mathbf" style="margin-right:0.01597em;">y</span></span><span class="mrel">=</span><span class="mord displaystyle textstyle uncramped"><span class="mord mathcal" style="margin-right:0.09931em;">F</span></span><span class="minner displaystyle textstyle uncramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;">(</span><span class="mord displaystyle textstyle uncramped"><span class="mord mathbf">x</span></span><span class="mpunct">,</span><span class="minner displaystyle textstyle uncramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;">{</span><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">W</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.13889em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">i</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;">}</span></span><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;">)</span></span><span class="mbin">+</span><span class="mord displaystyle textstyle uncramped"><span class="mord mathbf">x</span></span></span></span></span></span></p>
<p>其中<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mrow><mi mathvariant="script">F</mi></mrow><mrow><mo fence="true">(</mo><mrow><mi mathvariant="bold">x</mi></mrow><mo separator="true">,</mo><mrow><mo fence="true">{</mo><msub><mi>W</mi><mrow><mi>i</mi></mrow></msub><mo fence="true">}</mo></mrow><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mathcal{F}\left(\mathbf{x},\left\{W_{i}\right\}\right)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord mathcal" style="margin-right:0.09931em;">F</span></span><span class="minner textstyle uncramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;">(</span><span class="mord textstyle uncramped"><span class="mord mathbf">x</span></span><span class="mpunct">,</span><span class="minner textstyle uncramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;">{</span><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">W</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.13889em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">i</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;">}</span></span><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;">)</span></span></span></span></span>代表的是要被学习的残差映射，后面是一个自映射，期中需要保证残差映射的结果和原本输入的维度是相同的，如果不相同的话，可以考虑通过一个线性的投影<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>W</mi><mrow><mi>s</mi></mrow></msub></mrow><annotation encoding="application/x-tex">W_{s}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">W</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.13889em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">s</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span>使得维度可以match：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mrow><mi mathvariant="bold">y</mi></mrow><mo>=</mo><mrow><mi mathvariant="script">F</mi></mrow><mrow><mo fence="true">(</mo><mrow><mi mathvariant="bold">x</mi></mrow><mo separator="true">,</mo><mrow><mo fence="true">{</mo><msub><mi>W</mi><mrow><mi>i</mi></mrow></msub><mo fence="true">}</mo></mrow><mo fence="true">)</mo></mrow><mo>+</mo><msub><mi>W</mi><mrow><mi>s</mi></mrow></msub><mrow><mi mathvariant="bold">x</mi></mrow></mrow><annotation encoding="application/x-tex">\mathbf{y}=\mathcal{F}\left(\mathbf{x},\left\{W_{i}\right\}\right)+W_{s} \mathbf{x}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord displaystyle textstyle uncramped"><span class="mord mathbf" style="margin-right:0.01597em;">y</span></span><span class="mrel">=</span><span class="mord displaystyle textstyle uncramped"><span class="mord mathcal" style="margin-right:0.09931em;">F</span></span><span class="minner displaystyle textstyle uncramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;">(</span><span class="mord displaystyle textstyle uncramped"><span class="mord mathbf">x</span></span><span class="mpunct">,</span><span class="minner displaystyle textstyle uncramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;">{</span><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">W</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.13889em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">i</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;">}</span></span><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;">)</span></span><span class="mbin">+</span><span class="mord"><span class="mord mathit" style="margin-right:0.13889em;">W</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.13889em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">s</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mord displaystyle textstyle uncramped"><span class="mord mathbf">x</span></span></span></span></span></span></p>
<p><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mrow><mi mathvariant="script">F</mi></mrow></mrow><annotation encoding="application/x-tex">\mathcal{F}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.68333em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord mathcal" style="margin-right:0.09931em;">F</span></span></span></span></span>的形式是很多样的，但是如果只采用一层Linear，那么实际上用不用这个结构是没区别的，一般的时候是使用一个多层的卷积层来作为残差连接。</p>
<h2 id="代码实现"><a class="markdownIt-Anchor" href="#代码实现"></a> 代码实现</h2>
<p>以下是基于pytorch做的复现，其中对应的网络结构如下所示：</p>
<p><img src="https://s2.loli.net/2023/01/10/YMQahTe6CwrWjvH.jpg" alt="" /></p>
<p>两层的为BasicBlock，三层的为Bottleneck：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BasicBlock</span>(nn.Module):</span><br><span class="line">    expansion = <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, input_channel, channel, stride</span>):</span><br><span class="line">        <span class="built_in">super</span>(BasicBlock, self).__init__()</span><br><span class="line">        </span><br><span class="line">        self.downsample = <span class="keyword">lambda</span> x: x</span><br><span class="line">        <span class="keyword">if</span>(input_channel != channel):</span><br><span class="line">            self.downsample = nn.Sequential(</span><br><span class="line">                nn.Conv2d(in_channels = input_channel, out_channels = channel, kernel_size = <span class="number">1</span>, stride = stride, bias = <span class="literal">False</span>),</span><br><span class="line">                nn.BatchNorm2d(channel)</span><br><span class="line">            )</span><br><span class="line">        </span><br><span class="line">        self.relu = nn.ReLU(inplace = <span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        self.convlayers = nn.Sequential(</span><br><span class="line">            nn.Conv2d(in_channels = input_channel, out_channels = channel, kernel_size = <span class="number">3</span>, stride = stride, padding = <span class="number">1</span>, bias = <span class="literal">False</span>),</span><br><span class="line">            nn.BatchNorm2d(channel),</span><br><span class="line">            nn.ReLU(inplace = <span class="literal">True</span>),</span><br><span class="line">            nn.Conv2d(in_channels = channel, out_channels = channel, kernel_size = <span class="number">3</span>, stride = <span class="number">1</span>, padding = <span class="number">1</span>, bias = <span class="literal">False</span>),</span><br><span class="line">            nn.BatchNorm2d(channel)</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        out = self.downsample(x) + self.convlayers(x)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Bottleneck</span>(nn.Module):</span><br><span class="line">    expansion = <span class="number">4</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, input_channel, channel, stride, expansion = <span class="number">4</span></span>):</span><br><span class="line">        <span class="built_in">super</span>(Bottleneck, self).__init__()</span><br><span class="line">        self.expansion = expansion</span><br><span class="line">        output_channel = channel * expansion</span><br><span class="line">        </span><br><span class="line">        self.downsample = <span class="keyword">lambda</span> x: x</span><br><span class="line">        <span class="keyword">if</span>(input_channel != output_channel):</span><br><span class="line">            self.downsample = nn.Sequential(</span><br><span class="line">                nn.Conv2d(in_channels = input_channel, out_channels = output_channel, kernel_size = <span class="number">1</span>, stride = stride, bias = <span class="literal">False</span>),</span><br><span class="line">                nn.BatchNorm2d(output_channel)</span><br><span class="line">            )</span><br><span class="line">        </span><br><span class="line">        self.relu = nn.ReLU(inplace = <span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        self.convlayers = nn.Sequential(</span><br><span class="line">            nn.Conv2d(in_channels = input_channel, out_channels = channel, kernel_size = <span class="number">1</span>, stride = <span class="number">1</span>, bias = <span class="literal">False</span>),</span><br><span class="line">            nn.BatchNorm2d(channel),</span><br><span class="line">            nn.ReLU(inplace = <span class="literal">True</span>),</span><br><span class="line">            nn.Conv2d(in_channels = channel, out_channels = channel, kernel_size = <span class="number">3</span>, stride = stride, padding = <span class="number">1</span>, bias = <span class="literal">False</span>),</span><br><span class="line">            nn.BatchNorm2d(channel),</span><br><span class="line">            nn.ReLU(inplace = <span class="literal">True</span>),</span><br><span class="line">            nn.Conv2d(in_channels = channel, out_channels = output_channel, kernel_size = <span class="number">1</span>, stride = <span class="number">1</span>, bias = <span class="literal">False</span>),</span><br><span class="line">            nn.BatchNorm2d(output_channel)</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        out = self.downsample(x) + self.convlayers(x)</span><br><span class="line">        out = self.relu(out)</span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ResNet</span>(nn.Module):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, block, block_nums, input_channel, class_num</span>):</span><br><span class="line">        <span class="built_in">super</span>(ResNet, self).__init__()</span><br><span class="line">        </span><br><span class="line">        self.stacklayers = nn.Sequential(</span><br><span class="line">            nn.Conv2d(in_channels = input_channel, out_channels = <span class="number">64</span>, kernel_size = <span class="number">7</span>, stride = <span class="number">2</span>, padding = <span class="number">3</span>, bias = <span class="literal">False</span>),</span><br><span class="line">            nn.BatchNorm2d(<span class="number">64</span>),</span><br><span class="line">            nn.ReLU(inplace = <span class="literal">True</span>),</span><br><span class="line">            nn.MaxPool2d(kernel_size = <span class="number">3</span>, stride = <span class="number">2</span>),</span><br><span class="line">            self.make_layers(block = block, input_channel = <span class="number">64</span>, channel = <span class="number">64</span>, stride = <span class="number">1</span>, block_num = block_nums[<span class="number">0</span>]),</span><br><span class="line">            self.make_layers(block = block, input_channel = <span class="number">64</span> * block.expansion, channel = <span class="number">128</span>, stride = <span class="number">2</span>, block_num = block_nums[<span class="number">1</span>]),</span><br><span class="line">            self.make_layers(block = block, input_channel = <span class="number">128</span> * block.expansion, channel = <span class="number">256</span>, stride = <span class="number">2</span>, block_num = block_nums[<span class="number">2</span>]),</span><br><span class="line">            self.make_layers(block = block, input_channel = <span class="number">256</span> * block.expansion, channel = <span class="number">512</span>, stride = <span class="number">2</span>, block_num = block_nums[<span class="number">3</span>]),</span><br><span class="line">            nn.AdaptiveAvgPool2d(<span class="number">1</span>),</span><br><span class="line">            nn.Flatten(),</span><br><span class="line">            nn.Linear(<span class="number">512</span>*block.expansion, class_num)</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">make_layers</span>(<span class="params">self, block, input_channel, channel, stride, block_num, expansion = <span class="number">4</span>, reduction = <span class="number">16</span></span>):</span><br><span class="line">        layers = []</span><br><span class="line">        layers.append(block(input_channel, channel, stride))</span><br><span class="line">        input_channel = channel * block.expansion</span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, block_num):</span><br><span class="line">            layers.append(block(input_channel, channel, <span class="number">1</span>))</span><br><span class="line">        <span class="keyword">return</span> nn.Sequential(*layers)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">forward</span>(<span class="params">self, x</span>):</span><br><span class="line">        out = self.stacklayers(x)</span><br><span class="line">        <span class="keyword">return</span> out</span><br><span class="line">    </span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ResNet_18</span>(<span class="params">input_channel, class_num = <span class="number">1000</span></span>):</span><br><span class="line">    <span class="keyword">return</span> ResNet(BasicBlock, [<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>], input_channel, class_num)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ResNet_34</span>(<span class="params">input_channel, class_num = <span class="number">1000</span></span>):</span><br><span class="line">    <span class="keyword">return</span> ResNet(BasicBlock, [<span class="number">3</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">3</span>], input_channel, class_num)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ResNet_50</span>(<span class="params">input_channel, class_num = <span class="number">1000</span></span>):</span><br><span class="line">    <span class="keyword">return</span> ResNet(Bottleneck, [<span class="number">3</span>,<span class="number">4</span>,<span class="number">6</span>,<span class="number">3</span>], input_channel, class_num)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ResNet_101</span>(<span class="params">input_channel, class_num = <span class="number">1000</span></span>):</span><br><span class="line">    <span class="keyword">return</span> ResNet(Bottleneck, [<span class="number">3</span>,<span class="number">4</span>,<span class="number">23</span>,<span class="number">3</span>], input_channel, class_num)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ResNet_152</span>(<span class="params">input_channel, class_num = <span class="number">1000</span></span>):</span><br><span class="line">    <span class="keyword">return</span> ResNet(Bottleneck, [<span class="number">3</span>,<span class="number">8</span>,<span class="number">36</span>,<span class="number">3</span>], input_channel, class_num)</span><br><span class="line">   </span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://phimos.github.io/2020/02/13/RN-Categorical-Reparameterization-with-Gumbel-Softmax/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Pims">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pims的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/13/RN-Categorical-Reparameterization-with-Gumbel-Softmax/" class="post-title-link" itemprop="url">[论文笔记] Categorical Reparameterization with Gumbel-Softmax</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-02-13 05:16:54" itemprop="dateCreated datePublished" datetime="2020-02-13T05:16:54+08:00">2020-02-13</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="gumbel-softmax-distribution"><a class="markdownIt-Anchor" href="#gumbel-softmax-distribution"></a> Gumbel-Softmax Distribution</h2>
<p>考虑<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>z</mi></mrow><annotation encoding="application/x-tex">z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.43056em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.04398em;">z</span></span></span></span>是一个定类型的变量，对于每个类型有着概率<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>π</mi><mn>1</mn></msub><mo separator="true">,</mo><msub><mi>π</mi><mn>2</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>π</mi><mi>k</mi></msub></mrow><annotation encoding="application/x-tex">\pi_1,\pi_2,\ldots,\pi_k</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">π</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">1</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mpunct">,</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">π</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">2</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mpunct">,</span><span class="minner">…</span><span class="mpunct">,</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">π</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit" style="margin-right:0.03148em;">k</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span>。考虑到从这个概率分布中的采样可以用一个onehot向量来表示，当数据量很大的时候满足：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mrow><mi mathvariant="double-struck">E</mi></mrow><mi>p</mi></msub><mo>[</mo><mi>z</mi><mo>]</mo><mo>=</mo><mo>[</mo><msub><mi>π</mi><mn>1</mn></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>π</mi><mi>k</mi></msub><mo>]</mo></mrow><annotation encoding="application/x-tex">\mathbb{E}_p[z]=[\pi_1,\ldots,\pi_k]
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="base displaystyle textstyle uncramped"><span class=""><span class="mord displaystyle textstyle uncramped"><span class="mord mathbb">E</span></span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">p</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">[</span><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mclose">]</span><span class="mrel">=</span><span class="mopen">[</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">π</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathrm">1</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mpunct">,</span><span class="minner">…</span><span class="mpunct">,</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">π</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit" style="margin-right:0.03148em;">k</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mclose">]</span></span></span></span></span></p>
<p>Gumbel-Max trick 提供了一个简单且高效的来对符合<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>π</mi></mrow><annotation encoding="application/x-tex">\pi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.43056em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.03588em;">π</span></span></span></span>这样概率分布的<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>z</mi></mrow><annotation encoding="application/x-tex">z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.43056em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.04398em;">z</span></span></span></span>进行采样的方法：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>z</mi><mo>=</mo><mtext><mi mathvariant="normal">o</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">h</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">t</mi></mtext><mrow><mo fence="true">(</mo><mi>arg</mi><msub><mi>max</mi><mi>i</mi></msub><mo>[</mo><msub><mi>g</mi><mi>i</mi></msub><mo>+</mo><mi>log</mi><msub><mi>π</mi><mi>i</mi></msub><mo>]</mo><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">z = \text{onehot} \left(\arg \max_i [g_i+\log \pi_i]\right)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.15em;"></span><span class="strut bottom" style="height:1.877664em;vertical-align:-0.7276640000000001em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mrel">=</span><span class="text mord displaystyle textstyle uncramped"><span class="mord mathrm">o</span><span class="mord mathrm">n</span><span class="mord mathrm">e</span><span class="mord mathrm">h</span><span class="mord mathrm">o</span><span class="mord mathrm">t</span></span><span class="minner displaystyle textstyle uncramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;"><span class="delimsizing size2">(</span></span><span class="mop">ar<span style="margin-right:0.01389em;">g</span></span><span class="mop op-limits"><span class="vlist"><span style="top:0.6276640000000001em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span style="top:1.3877787807814457e-16em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span><span class="mop">max</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">[</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">g</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mbin">+</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">π</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mclose">]</span><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;"><span class="delimsizing size2">)</span></span></span></span></span></span></span></p>
<p>其中<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>g</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">g_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">g</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">i</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span>是从Gumbel(0,1)中独立采出的，它可以利用Uniform(0,1)中的采样来计算得到：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mtable><mtr><mtd><mrow><mi>u</mi></mrow></mtd><mtd><mrow><mrow></mrow><mo>∼</mo><mtext><mi mathvariant="normal">U</mi><mi mathvariant="normal">n</mi><mi mathvariant="normal">i</mi><mi mathvariant="normal">f</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">m</mi></mtext><mo>(</mo><mn>0</mn><mo separator="true">,</mo><mn>1</mn><mo>)</mo></mrow></mtd></mtr><mtr><mtd><mrow><mi>g</mi></mrow></mtd><mtd><mrow><mrow></mrow><mo>=</mo><mo>−</mo><mi>log</mi><mo>(</mo><mo>−</mo><mi>log</mi><mo>(</mo><mi>u</mi><mo>)</mo><mo>)</mo><mi mathvariant="normal">.</mi></mrow></mtd></mtr></mtable></mrow><annotation encoding="application/x-tex">\begin{aligned}
u &amp;\sim \text{Uniform}(0,1)
\\
g &amp;= -\log(-\log(u)).
\end{aligned}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.45em;"></span><span class="strut bottom" style="height:2.4000000000000004em;vertical-align:-0.9500000000000004em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist"><span style="top:-0.6099999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord mathit">u</span></span></span><span style="top:0.5900000000000003em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord mathit" style="margin-right:0.03588em;">g</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="col-align-l"><span class="vlist"><span style="top:-0.6099999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord displaystyle textstyle uncramped"></span><span class="mrel">∼</span><span class="text mord displaystyle textstyle uncramped"><span class="mord mathrm">U</span><span class="mord mathrm">n</span><span class="mord mathrm">i</span><span class="mord mathrm" style="margin-right:0.07778em;">f</span><span class="mord mathrm">o</span><span class="mord mathrm">r</span><span class="mord mathrm">m</span></span><span class="mopen">(</span><span class="mord mathrm">0</span><span class="mpunct">,</span><span class="mord mathrm">1</span><span class="mclose">)</span></span></span><span style="top:0.5900000000000003em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord displaystyle textstyle uncramped"></span><span class="mrel">=</span><span class="mord">−</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mopen">(</span><span class="mord">−</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mopen">(</span><span class="mord mathit">u</span><span class="mclose">)</span><span class="mclose">)</span><span class="mord mathrm">.</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span></span></span></span></p>
<p>之后利用softmax来获得一个连续可导对argmax的估计</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mtable><mtr><mtd><mrow><msub><mi>y</mi><mrow><mi>i</mi></mrow></msub><mo>=</mo><mfrac><mrow><mi>exp</mi><mrow><mo fence="true">(</mo><mrow><mo fence="true">(</mo><mi>log</mi><mrow><mo fence="true">(</mo><msub><mi>π</mi><mrow><mi>i</mi></mrow></msub><mo fence="true">)</mo></mrow><mo>+</mo><msub><mi>g</mi><mrow><mi>i</mi></mrow></msub><mo fence="true">)</mo></mrow><mi mathvariant="normal">/</mi><mi>τ</mi><mo fence="true">)</mo></mrow></mrow><mrow><msubsup><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mrow><mi>k</mi></mrow></msubsup><mi>exp</mi><mrow><mo fence="true">(</mo><mrow><mo fence="true">(</mo><mi>log</mi><mrow><mo fence="true">(</mo><msub><mi>π</mi><mrow><mi>j</mi></mrow></msub><mo fence="true">)</mo></mrow><mo>+</mo><msub><mi>g</mi><mrow><mi>j</mi></mrow></msub><mo fence="true">)</mo></mrow><mi mathvariant="normal">/</mi><mi>τ</mi><mo fence="true">)</mo></mrow></mrow></mfrac><mspace width="1em"></mspace><mtext><mi mathvariant="normal">f</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">r</mi></mtext><mtext> </mtext><mi>i</mi><mo>=</mo><mn>1</mn><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><mi>k</mi></mrow></mtd></mtr></mtable></mrow><annotation encoding="application/x-tex">\begin{aligned}
y_{i}=\frac
{\exp \left(\left(\log \left(\pi_{i}\right)+g_{i}\right) / \tau\right)}
{\sum_{j=1}^{k} \exp \left(\left(\log \left(\pi_{j}\right)+g_{j}\right) / \tau\right)}\quad
\text{for} \ i=1, \ldots, k

\end{aligned}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.551613em;"></span><span class="strut bottom" style="height:2.603226em;vertical-align:-1.051613em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist"><span style="top:-0.12461299999999986em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:1em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">i</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mrel">=</span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.7401079999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:1em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mop"><span class="op-symbol small-op mop" style="top:-0.0000050000000000050004em;">∑</span><span class="vlist"><span style="top:0.30001em;margin-left:0em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.05724em;">j</span><span class="mrel">=</span><span class="mord mathrm">1</span></span></span></span><span style="top:-0.364em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.03148em;">k</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mop">exp</span><span class="minner textstyle cramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;">(</span><span class="minner textstyle cramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="minner textstyle cramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;">(</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">π</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.05724em;">j</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;">)</span></span><span class="mbin">+</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">g</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.05724em;">j</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;">)</span></span><span class="mord mathrm">/</span><span class="mord mathit" style="margin-right:0.1132em;">τ</span><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;">)</span></span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:1em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:1em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mop">exp</span><span class="minner textstyle uncramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;">(</span><span class="minner textstyle uncramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;">(</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="minner textstyle uncramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;">(</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">π</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">i</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;">)</span></span><span class="mbin">+</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">g</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">i</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;">)</span></span><span class="mord mathrm">/</span><span class="mord mathit" style="margin-right:0.1132em;">τ</span><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;">)</span></span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:1em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mord mspace quad"></span><span class="text mord displaystyle textstyle uncramped"><span class="mord mathrm" style="margin-right:0.07778em;">f</span><span class="mord mathrm">o</span><span class="mord mathrm">r</span></span><span class="mord mspace"> </span><span class="mord mathit">i</span><span class="mrel">=</span><span class="mord mathrm">1</span><span class="mpunct">,</span><span class="minner">…</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.03148em;">k</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:1em;">​</span></span>​</span></span></span></span></span></span></span></span></span></p>
<p>Gumbel-Softmax分布的概率密度如下表是：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>p</mi><mrow><mi>π</mi><mo separator="true">,</mo><mi>τ</mi></mrow></msub><mrow><mo fence="true">(</mo><msub><mi>y</mi><mrow><mn>1</mn></mrow></msub><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><msub><mi>y</mi><mrow><mi>k</mi></mrow></msub><mo fence="true">)</mo></mrow><mo>=</mo><mi mathvariant="normal">Γ</mi><mo>(</mo><mi>k</mi><mo>)</mo><msup><mi>τ</mi><mrow><mi>k</mi><mo>−</mo><mn>1</mn></mrow></msup><msup><mrow><mo fence="true">(</mo><msubsup><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow><mi>k</mi></mrow></msubsup><msub><mi>π</mi><mrow><mi>i</mi></mrow></msub><mi mathvariant="normal">/</mi><msubsup><mi>y</mi><mrow><mi>i</mi></mrow><mrow><mi>τ</mi></mrow></msubsup><mo fence="true">)</mo></mrow><mrow><mo>−</mo><mi>k</mi></mrow></msup><msubsup><mo>∏</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mrow><mi>k</mi></mrow></msubsup><mrow><mo fence="true">(</mo><msub><mi>π</mi><mrow><mi>i</mi></mrow></msub><mi mathvariant="normal">/</mi><msubsup><mi>y</mi><mrow><mi>i</mi></mrow><mrow><mi>τ</mi><mo>+</mo><mn>1</mn></mrow></msubsup><mo fence="true">)</mo></mrow></mrow><annotation encoding="application/x-tex">p_{\pi, \tau}\left(y_{1}, \ldots, y_{k}\right)=\Gamma(k) \tau^{k-1}\left(\sum_{i=1}^{k} \pi_{i} / y_{i}^{\tau}\right)^{-k} \prod_{i=1}^{k}\left(\pi_{i} / y_{i}^{\tau+1}\right)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.9362210000000004em;"></span><span class="strut bottom" style="height:3.21389em;vertical-align:-1.277669em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mord mathit">p</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.03588em;">π</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.1132em;">τ</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="minner displaystyle textstyle uncramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;">(</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathrm">1</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mpunct">,</span><span class="minner">…</span><span class="mpunct">,</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.03148em;">k</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;">)</span></span><span class="mrel">=</span><span class="mord mathrm">Γ</span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.03148em;">k</span><span class="mclose">)</span><span class="mord"><span class="mord mathit" style="margin-right:0.1132em;">τ</span><span class="vlist"><span style="top:-0.41300000000000003em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathit" style="margin-right:0.03148em;">k</span><span class="mbin">−</span><span class="mord mathrm">1</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="minner"><span class="minner displaystyle textstyle uncramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;"><span class="delimsizing size4">(</span></span><span class="mop op-limits"><span class="vlist"><span style="top:1.1776689999999999em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">i</span><span class="mrel">=</span><span class="mord mathrm">1</span></span></span></span><span style="top:-0.000005000000000143778em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span><span class="op-symbol large-op mop">∑</span></span></span><span style="top:-1.2500050000000003em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathit" style="margin-right:0.03148em;">k</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">π</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">i</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mord mathrm">/</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="vlist"><span style="top:0.247em;margin-left:-0.03588em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">i</span></span></span></span><span style="top:-0.4129999999999999em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathit" style="margin-right:0.1132em;">τ</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;"><span class="delimsizing size4">)</span></span></span><span class="vlist"><span style="top:-1.4501130000000004em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord">−</span><span class="mord mathit" style="margin-right:0.03148em;">k</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mop op-limits"><span class="vlist"><span style="top:1.1776689999999999em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">i</span><span class="mrel">=</span><span class="mord mathrm">1</span></span></span></span><span style="top:-0.000005000000000143778em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span><span class="op-symbol large-op mop">∏</span></span></span><span style="top:-1.2500050000000003em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathit" style="margin-right:0.03148em;">k</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="minner displaystyle textstyle uncramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;"><span class="delimsizing size1">(</span></span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">π</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">i</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mord mathrm">/</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="vlist"><span style="top:0.266995em;margin-left:-0.03588em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">i</span></span></span></span><span style="top:-0.4129999999999999em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle uncramped"><span class="mord scriptstyle uncramped"><span class="mord mathit" style="margin-right:0.1132em;">τ</span><span class="mbin">+</span><span class="mord mathrm">1</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;"><span class="delimsizing size1">)</span></span></span></span></span></span></span></p>
<p>可以知道对于温度<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>τ</mi></mrow><annotation encoding="application/x-tex">\tau</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.43056em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.1132em;">τ</span></span></span></span>而言，越接近于零，那么从Gumbel-Softmax分布中的采样就越接近onehot并且Gumbel-Softmax分布同原始的分布<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>p</mi><mo>(</mo><mi>z</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">p(z)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit">p</span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mclose">)</span></span></span></span>也更加的相似。</p>
<p><img src="https://s2.loli.net/2023/01/10/EOYUHnVygKShqsQ.jpg" alt="" /></p>
<h2 id="gumbel-softmax-estimator"><a class="markdownIt-Anchor" href="#gumbel-softmax-estimator"></a> Gumbel-Softmax Estimator</h2>
<p>可以发现对于任意的<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>τ</mi><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\tau&gt;0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.64444em;"></span><span class="strut bottom" style="height:0.68354em;vertical-align:-0.0391em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.1132em;">τ</span><span class="mrel">&gt;</span><span class="mord mathrm">0</span></span></span></span>，Gumbel-Softmax分布都是光滑的，可以求出偏导数<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi mathvariant="normal">∂</mi><mi>y</mi><mi mathvariant="normal">/</mi><mi mathvariant="normal">∂</mi><mi>π</mi></mrow><annotation encoding="application/x-tex">\partial y / \partial \pi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathrm" style="margin-right:0.05556em;">∂</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mord mathrm">/</span><span class="mord mathrm" style="margin-right:0.05556em;">∂</span><span class="mord mathit" style="margin-right:0.03588em;">π</span></span></span></span>对参数<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>π</mi></mrow><annotation encoding="application/x-tex">\pi</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.43056em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.03588em;">π</span></span></span></span>。于是用Gumbel-Softmax采样来代替原有的分类采样，就可以利用反向传播来计算梯度了。</p>
<p>对于学习过程中来说，实际上存在一个tradeoff。当<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>τ</mi></mrow><annotation encoding="application/x-tex">\tau</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.43056em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.1132em;">τ</span></span></span></span>较小的时候，得到的sample比较接近onehot但是梯度的方差很大，当<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>τ</mi></mrow><annotation encoding="application/x-tex">\tau</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.43056em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.1132em;">τ</span></span></span></span>较大的时候，梯度的方差比较小但是得到的sample更平滑。在实际的操作中，我们通常从一个较高的<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>τ</mi></mrow><annotation encoding="application/x-tex">\tau</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.43056em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.1132em;">τ</span></span></span></span>开始，然后逐渐退火到一个很小的<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>τ</mi></mrow><annotation encoding="application/x-tex">\tau</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.43056em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.1132em;">τ</span></span></span></span>。事实上，对于很多种的退火方法，结果都表现的不错。</p>
<h2 id="straight-through-gumbel-softmax-estimator"><a class="markdownIt-Anchor" href="#straight-through-gumbel-softmax-estimator"></a> Straight-Through Gumbel-Softmax Estimator</h2>
<p>对于有些任务需要严格的将其限制为得到的就是离散的值，那么这个时候可以考虑对于<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.03588em;">y</span></span></span></span>来做一个arg max得到<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>z</mi></mrow><annotation encoding="application/x-tex">z</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.43056em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.04398em;">z</span></span></span></span>，在反向传播的时候利用<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi mathvariant="normal">∇</mi><mi>θ</mi></msub><mi>z</mi><mo>≈</mo><msub><mi mathvariant="normal">∇</mi><mi>θ</mi></msub><mi>y</mi></mrow><annotation encoding="application/x-tex">\nabla_\theta z \approx \nabla_\theta y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.8777699999999999em;vertical-align:-0.19444em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathrm">∇</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit" style="margin-right:0.02778em;">θ</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mrel">≈</span><span class="mord"><span class="mord mathrm">∇</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit" style="margin-right:0.02778em;">θ</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mord mathit" style="margin-right:0.03588em;">y</span></span></span></span>来进行梯度的估计。</p>
<p>即通过离散的方式进行采样，但是从连续的路径进行求导。这个叫做ST Gumbel-Softmax estimator，可以知道，当温度<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>τ</mi></mrow><annotation encoding="application/x-tex">\tau</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.43056em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.1132em;">τ</span></span></span></span>较高的时候，这依然可以采样得到离散的采样值。</p>
<h2 id="related-work"><a class="markdownIt-Anchor" href="#related-work"></a> Related Work</h2>
<p>主要总结了一些随机神经网络训练的方法，进行了一个对比。</p>
<p><img src="https://s2.loli.net/2023/01/10/5Ub6iupJZsYhjfT.jpg" alt="" /></p>
<p>上图中</p>
<ol>
<li>正常的无随机节点的梯度下降</li>
<li>存在随机节点的时候，梯度在这个地方不能很好地进行反传</li>
<li>采用log trick绕开随机节点传递梯度</li>
<li>估计梯度进行传播，例如前文提到的ST Estimator</li>
<li>采用重参数化方法，就是这里的Gumbel-Softmax Estimator</li>
</ol>
<h3 id="semi-supervised-generative-models"><a class="markdownIt-Anchor" href="#semi-supervised-generative-models"></a> Semi-Supervised Generative Models</h3>
<p>对于重参数化和log trick就不再多说，这里看一个半监督生成模型的推断。</p>
<p>考虑到一个半监督网络，从带标签数据<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mo>(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo>)</mo><mo>∼</mo><msub><mrow><mi mathvariant="script">D</mi></mrow><mi>L</mi></msub></mrow><annotation encoding="application/x-tex">(x,y)\sim\mathcal{D}_L</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mopen">(</span><span class="mord mathit">x</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mrel">∼</span><span class=""><span class="mord textstyle uncramped"><span class="mord mathcal" style="margin-right:0.02778em;">D</span></span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">L</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span>和不带标签数据<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>x</mi><mo>∼</mo><msub><mrow><mi mathvariant="script">D</mi></mrow><mi>U</mi></msub></mrow><annotation encoding="application/x-tex">x\sim \mathcal{D}_U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.68333em;"></span><span class="strut bottom" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="base textstyle uncramped"><span class="mord mathit">x</span><span class="mrel">∼</span><span class=""><span class="mord textstyle uncramped"><span class="mord mathcal" style="margin-right:0.02778em;">D</span></span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit" style="margin-right:0.10903em;">U</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span>中进行学习。</p>
<p>有一个分辨网络（D）<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>q</mi><mi>ϕ</mi></msub><mo>(</mo><mi>y</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">q_\phi(y|x)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">q</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">ϕ</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mord mathrm">∣</span><span class="mord mathit">x</span><span class="mclose">)</span></span></span></span>，一个推断网络（I）<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>q</mi><mi>ϕ</mi></msub><mo>(</mo><mi>z</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">q_\phi(z|x,y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">q</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">ϕ</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mord mathrm">∣</span><span class="mord mathit">x</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span>，和一个生成网络（G）<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>p</mi><mi>θ</mi></msub><mo>(</mo><mi>x</mi><mi mathvariant="normal">∣</mi><mi>y</mi><mo separator="true">,</mo><mi>z</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">p_\theta(x|y,z)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit">p</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit" style="margin-right:0.02778em;">θ</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit">x</span><span class="mord mathrm">∣</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mclose">)</span></span></span></span>，通过最大化生成网络输出的log似然的变分下界来进训练。</p>
<p>对于带标签的数据，y是观测到的结果，所以变分下界如下：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mtable><mtr><mtd><mrow><mi>log</mi><msub><mi>p</mi><mi>θ</mi></msub><mo>(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo>)</mo></mrow></mtd><mtd><mrow><mrow></mrow><mo>≥</mo><mrow><mi mathvariant="script">L</mi></mrow><mo>(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo>)</mo></mrow></mtd></mtr><mtr><mtd><mrow></mrow></mtd><mtd><mrow><mrow></mrow><mo>=</mo><msub><mrow><mi mathvariant="double-struck">E</mi></mrow><mrow><mi>z</mi><mo>∼</mo><msub><mi>q</mi><mi>ϕ</mi></msub><mo>(</mo><mi>z</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo>)</mo></mrow></msub><mo>[</mo><mi>log</mi><msub><mi>p</mi><mi>θ</mi></msub><mo>(</mo><mi>x</mi><mi mathvariant="normal">∣</mi><mi>y</mi><mo separator="true">,</mo><mi>z</mi><mo>)</mo><mo>]</mo><mo>−</mo><mi>K</mi><mi>L</mi><mo>[</mo><msub><mi>q</mi><mi>ϕ</mi></msub><mo>(</mo><mi>z</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo>)</mo><mi mathvariant="normal">∣</mi><mi mathvariant="normal">∣</mi><msub><mi>p</mi><mi>θ</mi></msub><mo>(</mo><mi>y</mi><mo>)</mo><mi>p</mi><mo>(</mo><mi>z</mi><mo>)</mo><mo>]</mo></mrow></mtd></mtr></mtable></mrow><annotation encoding="application/x-tex">\begin{aligned}
\log p_\theta(x,y) &amp;\ge \mathcal{L}(x,y)\\

&amp;= \mathbb{E}_{z \sim q_\phi(z|x,y)}[\log p_\theta(x|y,z)] - KL[q_\phi(z|x,y)||p_\theta(y)p(z)]
\end{aligned}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:1.46164em;"></span><span class="strut bottom" style="height:2.42328em;vertical-align:-0.96164em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist"><span style="top:-0.62164em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord"><span class="mord mathit">p</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit" style="margin-right:0.02778em;">θ</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit">x</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span><span style="top:0.5783600000000002em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="col-align-l"><span class="vlist"><span style="top:-0.62164em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord displaystyle textstyle uncramped"></span><span class="mrel">≥</span><span class="mord displaystyle textstyle uncramped"><span class="mord mathcal">L</span></span><span class="mopen">(</span><span class="mord mathit">x</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span><span style="top:0.5783600000000002em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord displaystyle textstyle uncramped"></span><span class="mrel">=</span><span class=""><span class="mord displaystyle textstyle uncramped"><span class="mord mathbb">E</span></span><span class="vlist"><span style="top:0.1801999999999999em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mrel">∼</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">q</span><span class="vlist"><span style="top:0.15122857142857138em;margin-right:0.07142857142857144em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-scriptstyle scriptscriptstyle cramped"><span class="mord mathit">ϕ</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mord mathrm">∣</span><span class="mord mathit">x</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">[</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord"><span class="mord mathit">p</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit" style="margin-right:0.02778em;">θ</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit">x</span><span class="mord mathrm">∣</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mclose">)</span><span class="mclose">]</span><span class="mbin">−</span><span class="mord mathit" style="margin-right:0.07153em;">K</span><span class="mord mathit">L</span><span class="mopen">[</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">q</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">ϕ</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mord mathrm">∣</span><span class="mord mathit">x</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mord mathrm">∣</span><span class="mord mathrm">∣</span><span class="mord"><span class="mord mathit">p</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit" style="margin-right:0.02778em;">θ</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mord mathit">p</span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mclose">)</span><span class="mclose">]</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span></span></span></span></p>
<p>对于无标签数据，重点在于对于离散的分布没有办法进行重参数化，所以这里采用的方法是对于margin out所有类别的y，同样是在<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msub><mi>q</mi><mi>ϕ</mi></msub><mo>(</mo><mi>z</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">q_\phi(z|x,y)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="base textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">q</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">ϕ</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mord mathrm">∣</span><span class="mord mathit">x</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span>上面进行推断，得到的变分下界如下所示（有一说一我推的和论文不一样，但我觉得论文里面的公式写错了）：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mtable><mtr><mtd><mrow><mi>log</mi><msub><mi>p</mi><mrow><mi>θ</mi></mrow></msub><mo>(</mo><mi>x</mi><mo>)</mo></mrow></mtd><mtd><mrow><mrow></mrow><mo>≥</mo><mrow><mi mathvariant="script">U</mi></mrow><mo>(</mo><mi>x</mi><mo>)</mo></mrow></mtd></mtr><mtr><mtd><mrow></mrow></mtd><mtd><mrow><mrow></mrow><mo>=</mo><msub><mrow><mi mathvariant="double-struck">E</mi></mrow><mrow><mi>z</mi><mo>∼</mo><msub><mi>q</mi><mrow><mi>ϕ</mi></mrow></msub><mo>(</mo><mi>y</mi><mo separator="true">,</mo><mi>z</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mo>)</mo></mrow></msub><mrow><mo fence="true">[</mo><mi>log</mi><msub><mi>p</mi><mrow><mi>θ</mi></mrow></msub><mo>(</mo><mi>x</mi><mi mathvariant="normal">∣</mi><mi>y</mi><mo separator="true">,</mo><mi>z</mi><mo>)</mo><mo>+</mo><mi>log</mi><msub><mi>p</mi><mrow><mi>θ</mi></mrow></msub><mo>(</mo><mi>y</mi><mo>)</mo><mo>+</mo><mi>log</mi><mi>p</mi><mo>(</mo><mi>z</mi><mo>)</mo><mo>−</mo><mi>log</mi><msub><mi>q</mi><mrow><mi>ϕ</mi></mrow></msub><mo>(</mo><mi>y</mi><mo separator="true">,</mo><mi>z</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mo>)</mo><mo fence="true">]</mo></mrow></mrow></mtd></mtr><mtr><mtd><mrow></mrow></mtd><mtd><mrow><mrow></mrow><mo>=</mo><msub><mrow><mi mathvariant="double-struck">E</mi></mrow><mrow><mi>z</mi><mo>∼</mo><msub><mi>q</mi><mrow><mi>ϕ</mi></mrow></msub><mo>(</mo><mi>y</mi><mo separator="true">,</mo><mi>z</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mo>)</mo></mrow></msub><mrow><mo fence="true">[</mo><mi>log</mi><msub><mi>p</mi><mrow><mi>θ</mi></mrow></msub><mo>(</mo><mi>x</mi><mi mathvariant="normal">∣</mi><mi>y</mi><mo separator="true">,</mo><mi>z</mi><mo>)</mo><mo>−</mo><mi>log</mi><mfrac><mrow><msub><mi>q</mi><mi>ϕ</mi></msub><mo>(</mo><mi>z</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo>)</mo></mrow><mrow><msub><mi>p</mi><mrow><mi>θ</mi></mrow></msub><mo>(</mo><mi>y</mi><mo>)</mo><mi>p</mi><mo>(</mo><mi>z</mi><mo>)</mo></mrow></mfrac><mo>+</mo><mi>log</mi><mfrac><mrow><msub><mi>q</mi><mi>ϕ</mi></msub><mo>(</mo><mi>z</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo>)</mo></mrow><mrow><msub><mi>q</mi><mi>ϕ</mi></msub><mo>(</mo><mi>y</mi><mo separator="true">,</mo><mi>z</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mo>)</mo></mrow></mfrac><mo fence="true">]</mo></mrow></mrow></mtd></mtr><mtr><mtd><mrow></mrow></mtd><mtd><mrow><mrow></mrow><mo>=</mo><msub><mrow><mi mathvariant="double-struck">E</mi></mrow><mrow><mi>z</mi><mo>∼</mo><msub><mi>q</mi><mrow><mi>ϕ</mi></mrow></msub><mo>(</mo><mi>y</mi><mo separator="true">,</mo><mi>z</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mo>)</mo></mrow></msub><mrow><mo fence="true">[</mo><mi>log</mi><msub><mi>p</mi><mrow><mi>θ</mi></mrow></msub><mo>(</mo><mi>x</mi><mi mathvariant="normal">∣</mi><mi>y</mi><mo separator="true">,</mo><mi>z</mi><mo>)</mo><mo>−</mo><mi>log</mi><mfrac><mrow><msub><mi>q</mi><mi>ϕ</mi></msub><mo>(</mo><mi>z</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo>)</mo></mrow><mrow><msub><mi>p</mi><mrow><mi>θ</mi></mrow></msub><mo>(</mo><mi>y</mi><mo>)</mo><mi>p</mi><mo>(</mo><mi>z</mi><mo>)</mo></mrow></mfrac><mo>+</mo><mi>log</mi><mfrac><mrow><mn>1</mn></mrow><mrow><msub><mi>q</mi><mi>ϕ</mi></msub><mo>(</mo><mi>y</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mo>)</mo></mrow></mfrac><mo fence="true">]</mo></mrow></mrow></mtd></mtr><mtr><mtd><mrow></mrow></mtd><mtd><mrow><mrow></mrow><mo>=</mo><msub><mo>∑</mo><mrow><mi>y</mi></mrow></msub><msub><mi>q</mi><mi>ϕ</mi></msub><mo>(</mo><mi>y</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mo>)</mo><msub><mrow><mi mathvariant="double-struck">E</mi></mrow><mrow><mi>z</mi><mo>∼</mo><msub><mi>q</mi><mrow><mi>ϕ</mi></mrow></msub><mo>(</mo><mi>z</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo>)</mo></mrow></msub><mrow><mo fence="true">[</mo><mi>log</mi><msub><mi>p</mi><mrow><mi>θ</mi></mrow></msub><mo>(</mo><mi>x</mi><mi mathvariant="normal">∣</mi><mi>y</mi><mo separator="true">,</mo><mi>z</mi><mo>)</mo><mo>−</mo><mi>log</mi><mfrac><mrow><msub><mi>q</mi><mi>ϕ</mi></msub><mo>(</mo><mi>z</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo>)</mo></mrow><mrow><msub><mi>p</mi><mrow><mi>θ</mi></mrow></msub><mo>(</mo><mi>y</mi><mo>)</mo><mi>p</mi><mo>(</mo><mi>z</mi><mo>)</mo></mrow></mfrac><mo>+</mo><mi>log</mi><mfrac><mrow><mn>1</mn></mrow><mrow><msub><mi>q</mi><mi>ϕ</mi></msub><mo>(</mo><mi>y</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mo>)</mo></mrow></mfrac><mo fence="true">]</mo></mrow></mrow></mtd></mtr><mtr><mtd><mrow></mrow></mtd><mtd><mrow><mrow></mrow><mo>=</mo><msub><mo>∑</mo><mrow><mi>y</mi></mrow></msub><msub><mi>q</mi><mi>ϕ</mi></msub><mo>(</mo><mi>y</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mo>)</mo><msub><mrow><mi mathvariant="double-struck">E</mi></mrow><mrow><mi>z</mi><mo>∼</mo><msub><mi>q</mi><mrow><mi>ϕ</mi></mrow></msub><mo>(</mo><mi>z</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo>)</mo></mrow></msub><mrow><mo fence="true">[</mo><mi>log</mi><msub><mi>p</mi><mrow><mi>θ</mi></mrow></msub><mo>(</mo><mi>x</mi><mi mathvariant="normal">∣</mi><mi>y</mi><mo separator="true">,</mo><mi>z</mi><mo>)</mo><mo>−</mo><mi>log</mi><mfrac><mrow><msub><mi>q</mi><mi>ϕ</mi></msub><mo>(</mo><mi>z</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo>)</mo></mrow><mrow><msub><mi>p</mi><mrow><mi>θ</mi></mrow></msub><mo>(</mo><mi>y</mi><mo>)</mo><mi>p</mi><mo>(</mo><mi>z</mi><mo>)</mo></mrow></mfrac><mo fence="true">]</mo></mrow><mo>+</mo><msub><mo>∑</mo><mrow><mi>y</mi></mrow></msub><msub><mi>q</mi><mi>ϕ</mi></msub><mo>(</mo><mi>y</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mo>)</mo><mi>log</mi><mfrac><mrow><mn>1</mn></mrow><mrow><msub><mi>q</mi><mi>ϕ</mi></msub><mo>(</mo><mi>y</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mo>)</mo></mrow></mfrac></mrow></mtd></mtr><mtr><mtd><mrow></mrow></mtd><mtd><mrow><mrow></mrow><mo>=</mo><msub><mo>∑</mo><mrow><mi>y</mi></mrow></msub><msub><mi>q</mi><mrow><mi>ϕ</mi></mrow></msub><mo>(</mo><mi>y</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mo>)</mo><mrow><mi mathvariant="script">L</mi></mrow><mo>(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo>)</mo><mo>+</mo><mrow><mi mathvariant="script">H</mi></mrow><mrow><mo fence="true">(</mo><msub><mi>q</mi><mrow><mi>ϕ</mi></mrow></msub><mo>(</mo><mi>y</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mo>)</mo><mo fence="true">)</mo></mrow></mrow></mtd></mtr></mtable></mrow><annotation encoding="application/x-tex">\begin{aligned}\log p_{\theta}(x) &amp;\geq\mathcal{U}(x) \\&amp;=\mathbb{E}_{z \sim q_{\phi}(y, z | x)}\left[\log p_{\theta}(x | y, z)+\log p_{\theta}(y)+\log p(z)-\log q_{\phi}(y, z | x)\right] \\&amp;=\mathbb{E}_{z \sim q_{\phi}(y, z | x)}\left[\log p_{\theta}(x | y, z)-\log \frac{q_\phi(z|x,y)}{p_{\theta}(y) p(z)} + \log \frac{q_\phi(z|x,y)}{q_\phi(y,z|x)}\right]\\&amp;=\mathbb{E}_{z \sim q_{\phi}(y, z | x)}\left[\log p_{\theta}(x | y, z)-\log \frac{q_\phi(z|x,y)}{p_{\theta}(y) p(z)} + \log \frac{1}{q_\phi(y|x)}\right]\\&amp;=\sum_{y} q_\phi(y|x)\mathbb{E}_{z \sim q_{\phi}(z | x,y)}\left[\log p_{\theta}(x | y, z)-\log \frac{q_\phi(z|x,y)}{p_{\theta}(y) p(z)} + \log \frac{1}{q_\phi(y|x)}\right]\\&amp;=\sum_{y} q_\phi(y|x)\mathbb{E}_{z \sim q_{\phi}(z | x,y)}\left[\log p_{\theta}(x | y, z)-\log \frac{q_\phi(z|x,y)}{p_{\theta}(y) p(z)}\right] + \sum_{y} q_\phi(y|x)\log \frac{1}{q_\phi(y|x)}\\&amp;=\sum_{y} q_{\phi}(y | x)\mathcal{L}(x, y)+\mathcal{H}\left(q_{\phi}(y | x)\right)\end{aligned}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:7.937919999999999em;"></span><span class="strut bottom" style="height:15.37584em;vertical-align:-7.43792em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist"><span style="top:-7.097919999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord"><span class="mord mathit">p</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.02778em;">θ</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit">x</span><span class="mclose">)</span></span></span><span style="top:-5.897919999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"></span></span><span style="top:-4.064639999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"></span></span><span style="top:-1.6425319999999988em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"></span></span><span style="top:0.7795760000000005em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"></span></span><span style="top:3.6156889999999997em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"></span></span><span style="top:6.051807em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="mord displaystyle textstyle uncramped"></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="col-align-l"><span class="vlist"><span style="top:-7.097919999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:1em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord displaystyle textstyle uncramped"></span><span class="mrel">≥</span><span class="mord displaystyle textstyle uncramped"><span class="mord mathcal" style="margin-right:0.09931em;">U</span></span><span class="mopen">(</span><span class="mord mathit">x</span><span class="mclose">)</span></span></span><span style="top:-5.897919999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:1em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord displaystyle textstyle uncramped"></span><span class="mrel">=</span><span class=""><span class="mord displaystyle textstyle uncramped"><span class="mord mathbb">E</span></span><span class="vlist"><span style="top:0.1801999999999999em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mrel">∼</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">q</span><span class="vlist"><span style="top:0.15122857142857138em;margin-right:0.07142857142857144em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-scriptstyle scriptscriptstyle cramped"><span class="mord scriptscriptstyle cramped"><span class="mord mathit">ϕ</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mord mathrm">∣</span><span class="mord mathit">x</span><span class="mclose">)</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="minner displaystyle textstyle uncramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;">[</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord"><span class="mord mathit">p</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.02778em;">θ</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit">x</span><span class="mord mathrm">∣</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mclose">)</span><span class="mbin">+</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord"><span class="mord mathit">p</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.02778em;">θ</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mbin">+</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord mathit">p</span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mclose">)</span><span class="mbin">−</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">q</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">ϕ</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mord mathrm">∣</span><span class="mord mathit">x</span><span class="mclose">)</span><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;">]</span></span></span></span><span style="top:-4.064639999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:1em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord displaystyle textstyle uncramped"></span><span class="mrel">=</span><span class=""><span class="mord displaystyle textstyle uncramped"><span class="mord mathbb">E</span></span><span class="vlist"><span style="top:0.1801999999999999em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mrel">∼</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">q</span><span class="vlist"><span style="top:0.15122857142857138em;margin-right:0.07142857142857144em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-scriptstyle scriptscriptstyle cramped"><span class="mord scriptscriptstyle cramped"><span class="mord mathit">ϕ</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mord mathrm">∣</span><span class="mord mathit">x</span><span class="mclose">)</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="minner displaystyle textstyle uncramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord"><span class="mord mathit">p</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.02778em;">θ</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit">x</span><span class="mord mathrm">∣</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mclose">)</span><span class="mbin">−</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.686em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord"><span class="mord mathit">p</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.02778em;">θ</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mord mathit">p</span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mclose">)</span></span></span></span><span style="top:-0.2300000000000001em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">q</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">ϕ</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mord mathrm">∣</span><span class="mord mathit">x</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mbin">+</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.6859999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">q</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">ϕ</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mord mathrm">∣</span><span class="mord mathit">x</span><span class="mclose">)</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">q</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">ϕ</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mord mathrm">∣</span><span class="mord mathit">x</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span><span style="top:-1.6425319999999988em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:1em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord displaystyle textstyle uncramped"></span><span class="mrel">=</span><span class=""><span class="mord displaystyle textstyle uncramped"><span class="mord mathbb">E</span></span><span class="vlist"><span style="top:0.1801999999999999em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mrel">∼</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">q</span><span class="vlist"><span style="top:0.15122857142857138em;margin-right:0.07142857142857144em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-scriptstyle scriptscriptstyle cramped"><span class="mord scriptscriptstyle cramped"><span class="mord mathit">ϕ</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mord mathrm">∣</span><span class="mord mathit">x</span><span class="mclose">)</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="minner displaystyle textstyle uncramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord"><span class="mord mathit">p</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.02778em;">θ</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit">x</span><span class="mord mathrm">∣</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mclose">)</span><span class="mbin">−</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.686em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord"><span class="mord mathit">p</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.02778em;">θ</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mord mathit">p</span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mclose">)</span></span></span></span><span style="top:-0.2300000000000001em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">q</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">ϕ</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mord mathrm">∣</span><span class="mord mathit">x</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mbin">+</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.6859999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">q</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">ϕ</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mord mathrm">∣</span><span class="mord mathit">x</span><span class="mclose">)</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord mathrm">1</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span><span style="top:0.7795760000000005em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:1em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord displaystyle textstyle uncramped"></span><span class="mrel">=</span><span class="mop op-limits"><span class="vlist"><span style="top:1.150005em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.03588em;">y</span></span></span></span><span style="top:-0.000005000000000143778em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span><span class="op-symbol large-op mop">∑</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">q</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">ϕ</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mord mathrm">∣</span><span class="mord mathit">x</span><span class="mclose">)</span><span class=""><span class="mord displaystyle textstyle uncramped"><span class="mord mathbb">E</span></span><span class="vlist"><span style="top:0.1801999999999999em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mrel">∼</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">q</span><span class="vlist"><span style="top:0.15122857142857138em;margin-right:0.07142857142857144em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-scriptstyle scriptscriptstyle cramped"><span class="mord scriptscriptstyle cramped"><span class="mord mathit">ϕ</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mord mathrm">∣</span><span class="mord mathit">x</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="minner displaystyle textstyle uncramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord"><span class="mord mathit">p</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.02778em;">θ</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit">x</span><span class="mord mathrm">∣</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mclose">)</span><span class="mbin">−</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.686em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord"><span class="mord mathit">p</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.02778em;">θ</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mord mathit">p</span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mclose">)</span></span></span></span><span style="top:-0.2300000000000001em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">q</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">ϕ</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mord mathrm">∣</span><span class="mord mathit">x</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="mbin">+</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.6859999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">q</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">ϕ</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mord mathrm">∣</span><span class="mord mathit">x</span><span class="mclose">)</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord mathrm">1</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;"><span class="delimsizing size3">]</span></span></span></span></span><span style="top:3.6156889999999997em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:1em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord displaystyle textstyle uncramped"></span><span class="mrel">=</span><span class="mop op-limits"><span class="vlist"><span style="top:1.150005em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.03588em;">y</span></span></span></span><span style="top:-0.000005000000000143778em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span><span class="op-symbol large-op mop">∑</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">q</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">ϕ</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mord mathrm">∣</span><span class="mord mathit">x</span><span class="mclose">)</span><span class=""><span class="mord displaystyle textstyle uncramped"><span class="mord mathbb">E</span></span><span class="vlist"><span style="top:0.1801999999999999em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mrel">∼</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">q</span><span class="vlist"><span style="top:0.15122857142857138em;margin-right:0.07142857142857144em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-scriptstyle scriptscriptstyle cramped"><span class="mord scriptscriptstyle cramped"><span class="mord mathit">ϕ</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mord mathrm">∣</span><span class="mord mathit">x</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="minner displaystyle textstyle uncramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;"><span class="delimsizing size3">[</span></span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord"><span class="mord mathit">p</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.02778em;">θ</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit">x</span><span class="mord mathrm">∣</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mclose">)</span><span class="mbin">−</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.686em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord"><span class="mord mathit">p</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.02778em;">θ</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mord mathit">p</span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mclose">)</span></span></span></span><span style="top:-0.2300000000000001em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">q</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">ϕ</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.04398em;">z</span><span class="mord mathrm">∣</span><span class="mord mathit">x</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mclose">)</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;"><span class="delimsizing size3">]</span></span></span><span class="mbin">+</span><span class="mop op-limits"><span class="vlist"><span style="top:1.150005em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.03588em;">y</span></span></span></span><span style="top:-0.000005000000000143778em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span><span class="op-symbol large-op mop">∑</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">q</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">ϕ</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mord mathrm">∣</span><span class="mord mathit">x</span><span class="mclose">)</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord reset-textstyle displaystyle textstyle uncramped"><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span><span class="mfrac"><span class="vlist"><span style="top:0.6859999999999999em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle cramped"><span class="mord textstyle cramped"><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">q</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord mathit">ϕ</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mord mathrm">∣</span><span class="mord mathit">x</span><span class="mclose">)</span></span></span></span><span style="top:-0.22999999999999998em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped frac-line"></span></span><span style="top:-0.677em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord mathrm">1</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="sizing reset-size5 size5 reset-textstyle textstyle uncramped nulldelimiter"></span></span></span></span><span style="top:6.051807em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:1em;">​</span></span><span class="mord displaystyle textstyle uncramped"><span class="mord displaystyle textstyle uncramped"></span><span class="mrel">=</span><span class="mop op-limits"><span class="vlist"><span style="top:1.150005em;margin-left:0em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit" style="margin-right:0.03588em;">y</span></span></span></span><span style="top:-0.000005000000000143778em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span><span class="op-symbol large-op mop">∑</span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">q</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">ϕ</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mord mathrm">∣</span><span class="mord mathit">x</span><span class="mclose">)</span><span class="mord displaystyle textstyle uncramped"><span class="mord mathcal">L</span></span><span class="mopen">(</span><span class="mord mathit">x</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mbin">+</span><span class="mord displaystyle textstyle uncramped"><span class="mord mathcal" style="margin-right:0.00965em;">H</span></span><span class="minner displaystyle textstyle uncramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;">(</span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">q</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">ϕ</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mord mathrm">∣</span><span class="mord mathit">x</span><span class="mclose">)</span><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;">)</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:1em;">​</span></span>​</span></span></span></span></span></span></span></span></span></p>
<p>最终得到的最大化目标为下面这个式子：</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math><semantics><mrow><mrow><mi mathvariant="script">J</mi></mrow><mo>=</mo><msub><mrow><mi mathvariant="double-struck">E</mi></mrow><mrow><mo>(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo>)</mo><mo>∼</mo><msub><mrow><mi mathvariant="script">D</mi></mrow><mrow><mi>L</mi></mrow></msub></mrow></msub><mo>[</mo><mrow><mi mathvariant="script">L</mi></mrow><mo>(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo>)</mo><mo>]</mo><mo>+</mo><msub><mrow><mi mathvariant="double-struck">E</mi></mrow><mrow><mi>x</mi><mo>∼</mo><msub><mrow><mi mathvariant="script">D</mi></mrow><mrow><mi>U</mi></mrow></msub></mrow></msub><mo>[</mo><mrow><mi mathvariant="script">U</mi></mrow><mo>(</mo><mi>x</mi><mo>)</mo><mo>]</mo><mo>+</mo><mi>α</mi><mo>⋅</mo><msub><mrow><mi mathvariant="double-struck">E</mi></mrow><mrow><mo>(</mo><mi>x</mi><mo separator="true">,</mo><mi>y</mi><mo>)</mo><mo>∼</mo><msub><mrow><mi mathvariant="script">D</mi></mrow><mrow><mi>L</mi></mrow></msub></mrow></msub><mrow><mo fence="true">[</mo><mi>log</mi><msub><mi>q</mi><mrow><mi>ϕ</mi></mrow></msub><mo>(</mo><mi>y</mi><mi mathvariant="normal">∣</mi><mi>x</mi><mo>)</mo><mo fence="true">]</mo></mrow></mrow><annotation encoding="application/x-tex">\mathcal{J}=\mathbb{E}_{(x, y) \sim \mathcal{D}_{L}}[\mathcal{L}(x, y)]+\mathbb{E}_{x \sim \mathcal{D}_{U}}[\mathcal{U}(x)]+\alpha \cdot \mathbb{E}_{(x, y) \sim \mathcal{D}_{L}}\left[\log q_{\phi}(y | x)\right]
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1.1052em;vertical-align:-0.3551999999999999em;"></span><span class="base displaystyle textstyle uncramped"><span class="mord displaystyle textstyle uncramped"><span class="mord mathcal" style="margin-right:0.18472em;">J</span></span><span class="mrel">=</span><span class=""><span class="mord displaystyle textstyle uncramped"><span class="mord mathbb">E</span></span><span class="vlist"><span style="top:0.18019999999999992em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mopen">(</span><span class="mord mathit">x</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mrel">∼</span><span class=""><span class="mord scriptstyle cramped"><span class="mord mathcal" style="margin-right:0.02778em;">D</span></span><span class="vlist"><span style="top:0.15em;margin-right:0.07142857142857144em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-scriptstyle scriptscriptstyle cramped"><span class="mord scriptscriptstyle cramped"><span class="mord mathit">L</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">[</span><span class="mord displaystyle textstyle uncramped"><span class="mord mathcal">L</span></span><span class="mopen">(</span><span class="mord mathit">x</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mclose">]</span><span class="mbin">+</span><span class=""><span class="mord displaystyle textstyle uncramped"><span class="mord mathbb">E</span></span><span class="vlist"><span style="top:0.15000000000000002em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">x</span><span class="mrel">∼</span><span class=""><span class="mord scriptstyle cramped"><span class="mord mathcal" style="margin-right:0.02778em;">D</span></span><span class="vlist"><span style="top:0.15em;margin-right:0.07142857142857144em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-scriptstyle scriptscriptstyle cramped"><span class="mord scriptscriptstyle cramped"><span class="mord mathit" style="margin-right:0.10903em;">U</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">[</span><span class="mord displaystyle textstyle uncramped"><span class="mord mathcal" style="margin-right:0.09931em;">U</span></span><span class="mopen">(</span><span class="mord mathit">x</span><span class="mclose">)</span><span class="mclose">]</span><span class="mbin">+</span><span class="mord mathit" style="margin-right:0.0037em;">α</span><span class="mbin">⋅</span><span class=""><span class="mord displaystyle textstyle uncramped"><span class="mord mathbb">E</span></span><span class="vlist"><span style="top:0.18019999999999992em;margin-right:0.05em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mopen">(</span><span class="mord mathit">x</span><span class="mpunct">,</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mclose">)</span><span class="mrel">∼</span><span class=""><span class="mord scriptstyle cramped"><span class="mord mathcal" style="margin-right:0.02778em;">D</span></span><span class="vlist"><span style="top:0.15em;margin-right:0.07142857142857144em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-scriptstyle scriptscriptstyle cramped"><span class="mord scriptscriptstyle cramped"><span class="mord mathit">L</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="minner displaystyle textstyle uncramped"><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;">[</span><span class="mop">lo<span style="margin-right:0.01389em;">g</span></span><span class="mord"><span class="mord mathit" style="margin-right:0.03588em;">q</span><span class="vlist"><span style="top:0.15em;margin-right:0.05em;margin-left:-0.03588em;"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span><span class="reset-textstyle scriptstyle cramped"><span class="mord scriptstyle cramped"><span class="mord mathit">ϕ</span></span></span></span><span class="baseline-fix"><span class="fontsize-ensurer reset-size5 size5"><span style="font-size:0em;">​</span></span>​</span></span></span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.03588em;">y</span><span class="mord mathrm">∣</span><span class="mord mathit">x</span><span class="mclose">)</span><span class="style-wrap reset-textstyle textstyle uncramped" style="top:0em;">]</span></span></span></span></span></span></p>
<p>容易发现，前两项一个是针对带标签数据的变分下界最大化，一个是针对无标签数据的最大化，最后一项代表分辨网络的对数似然，其中<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>α</mi></mrow><annotation encoding="application/x-tex">\alpha</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.43056em;"></span><span class="strut bottom" style="height:0.43056em;vertical-align:0em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.0037em;">α</span></span></span></span>参数越大，说明越看重分辨网络的能力。是一个在分辨网络和生成网络之间进行tradeoff的参数。</p>
<p>对于这种方法，假设要margin out一共k个类别，那么对每个前向/反向步需要<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mrow><mi mathvariant="script">O</mi></mrow><mo>(</mo><mi>D</mi><mo>+</mo><mi>k</mi><mo>(</mo><mi>I</mi><mo>+</mo><mi>G</mi><mo>)</mo><mo>)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(D+k(I+G))</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord mathcal" style="margin-right:0.02778em;">O</span></span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.02778em;">D</span><span class="mbin">+</span><span class="mord mathit" style="margin-right:0.03148em;">k</span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.07847em;">I</span><span class="mbin">+</span><span class="mord mathit">G</span><span class="mclose">)</span><span class="mclose">)</span></span></span></span>，但是采用Gumbel-Softmax方法进行重参数化，就可以直接进行反向传播而不需要margin out，时间复杂度降低到了<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mrow><mi mathvariant="script">O</mi></mrow><mo>(</mo><mi>D</mi><mo>+</mo><mi>I</mi><mo>+</mo><mi>G</mi><mo>)</mo></mrow><annotation encoding="application/x-tex">\mathcal{O}(D+I+G)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord textstyle uncramped"><span class="mord mathcal" style="margin-right:0.02778em;">O</span></span><span class="mopen">(</span><span class="mord mathit" style="margin-right:0.02778em;">D</span><span class="mbin">+</span><span class="mord mathit" style="margin-right:0.07847em;">I</span><span class="mbin">+</span><span class="mord mathit">G</span><span class="mclose">)</span></span></span></span>，在类别很多的情况下可以有效降低训练的时间复杂度！</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://phimos.github.io/2020/02/06/cpp-interview-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Pims">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pims的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/06/cpp-interview-2/" class="post-title-link" itemprop="url">C++ 面试题 2</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-02-06 06:14:51" itemprop="dateCreated datePublished" datetime="2020-02-06T06:14:51+08:00">2020-02-06</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>准备面试的时候找到了两套C++面试题，做了一下，解答直接写在上面了，放在这里分享出来。感觉难度并不是很高，这是第二套~</p>
<hr />
<h2 id="a-show-me-the-code"><a class="markdownIt-Anchor" href="#a-show-me-the-code"></a> A. Show me the code</h2>
<h4 id="1-please-create-a-string-class-to-process-char-strings-this-string-class-should-satisfy-the-following-requirements"><a class="markdownIt-Anchor" href="#1-please-create-a-string-class-to-process-char-strings-this-string-class-should-satisfy-the-following-requirements"></a> 1. Please create a “String” class to process char strings. This string class should satisfy the following requirements:</h4>
<ul>
<li>It could be used as an original type like “int” to define variables and support assignment and copy.</li>
<li>It could be used as the parameter type of a function and the return value type of a function.</li>
<li>It could be used as the element type of the STL container, e.g., vector/list/deque.</li>
</ul>
<p>In other words, your “String” class could be used in the following code and be complied successfully by a standard C++ compiler.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">(String x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">bar</span><span class="params">(<span class="type">const</span> String&amp; x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">String <span class="title">baz</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="function">String <span class="title">ret</span><span class="params">(<span class="string">&quot;world&quot;</span>)</span></span>;</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  String s0;</span><br><span class="line">  <span class="function">String <span class="title">s1</span><span class="params">(<span class="string">&quot;hello&quot;</span>)</span></span>;</span><br><span class="line">  <span class="function">String <span class="title">s2</span><span class="params">(s0)</span></span>;</span><br><span class="line">  String s3 = s1;</span><br><span class="line">  s2 = s1;</span><br><span class="line">  <span class="built_in">foo</span>(s1);</span><br><span class="line">  <span class="built_in">bar</span>(s1);</span><br><span class="line">  <span class="built_in">foo</span>(<span class="string">&quot;temporary&quot;</span>);</span><br><span class="line">  <span class="built_in">bar</span>(<span class="string">&quot;temporary&quot;</span>);</span><br><span class="line">  String s4 = <span class="built_in">baz</span>();</span><br><span class="line">  std::vector&lt;String&gt; svec;</span><br><span class="line">  svec.<span class="built_in">push_back</span>(s0);</span><br><span class="line">  svec.<span class="built_in">push_back</span>(s1);</span><br><span class="line">  svec.<span class="built_in">push_back</span>(<span class="built_in">baz</span>());</span><br><span class="line">  svec.<span class="built_in">push_back</span>(<span class="string">&quot;good job&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>略，感觉以前写过。</p>
<h4 id="2-imagine-we-have-a-single-linked-list-please-write-a-function-which-could-remove-a-specified-node-in-the-list"><a class="markdownIt-Anchor" href="#2-imagine-we-have-a-single-linked-list-please-write-a-function-which-could-remove-a-specified-node-in-the-list"></a> 2. Imagine we have a single linked list, please write a function which could remove a specified node in the list.</h4>
<ul>
<li>Please define the data structure for the list as you need.</li>
<li>Pass the head pointer to the function.</li>
<li>Pass the pointer to the node to be removed to the function. Remove the node in the list if it has the same pointer value.</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ListNode</span>&#123;</span><br><span class="line">  <span class="type">int</span> val;</span><br><span class="line">  ListNode* next;</span><br><span class="line">  <span class="built_in">ListNode</span>(<span class="type">int</span> _val): <span class="built_in">val</span>(_val)&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">ListNode* <span class="title">deleteNode</span><span class="params">(ListNode* head, <span class="type">int</span> val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(!head)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">while</span>(head-&gt;val == val)</span><br><span class="line">  &#123;</span><br><span class="line">    head = head-&gt;next;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(!head)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">  ListNode* pnode = head-&gt;next;</span><br><span class="line">  ListNode* prev = head;</span><br><span class="line">  <span class="keyword">while</span>(pnode)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span>(pnode-&gt;val == val)</span><br><span class="line">    &#123;</span><br><span class="line">      prev-&gt;next = pnode-&gt;next;</span><br><span class="line">      pnode = pnode-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      prev = pnode;</span><br><span class="line">      pnode = pnode-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> head;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr />
<h2 id="b-basic-part"><a class="markdownIt-Anchor" href="#b-basic-part"></a> B. Basic Part</h2>
<h4 id="1-what-are-wrong-in-the-following-code-please-point-out"><a class="markdownIt-Anchor" href="#1-what-are-wrong-in-the-following-code-please-point-out"></a> 1. What are wrong in the following code? Please point out.</h4>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">char</span> a = <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">  <span class="type">int</span> b = <span class="number">0</span>;</span><br><span class="line">  <span class="type">int</span> *pInt1 = &amp;b;</span><br><span class="line">  <span class="type">int</span> c = *pInt1;</span><br><span class="line">  pInt1 = (<span class="type">int</span>*)(&amp;a);</span><br><span class="line">  <span class="type">int</span> *pInt2 = pInt1 + <span class="number">1</span>;</span><br><span class="line">  <span class="type">int</span> d = *pInt2;</span><br><span class="line">  <span class="type">void</span> *pV = &amp;a;</span><br><span class="line">  <span class="comment">// char * pV = &amp;a;</span></span><br><span class="line">  pV++;	<span class="comment">// 对空指针不能最算术运算</span></span><br><span class="line">  <span class="type">char</span> e = *pV;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="2-what-are-wrong-in-the-following-code-please-provide-your-fix"><a class="markdownIt-Anchor" href="#2-what-are-wrong-in-the-following-code-please-provide-your-fix"></a> 2. What are wrong in the following code? Please provide your <strong>FIX</strong>.</h4>
<p><em>Common.h</em></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> var1;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">(<span class="type">int</span> input)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// some code</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><em>TestA.h</em></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Common.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TestB.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CTestA</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    CTestB m_b;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><em>TestB.h</em></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;Common.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TestA.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CTestB</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">private</span>:</span><br><span class="line">    CTestA m_a;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><em>TestA.cpp</em></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TestA.h&quot;</span></span></span><br><span class="line"><span class="comment">// some code</span></span><br></pre></td></tr></table></figure>
<p><em>TestB.cpp</em></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TestB.h&quot;</span></span></span><br><span class="line"><span class="comment">// some code</span></span><br></pre></td></tr></table></figure>
<p>提前声明，结构体内部都采用指针而不是实体。</p>
<hr />
<h2 id="c-stl"><a class="markdownIt-Anchor" href="#c-stl"></a> C. STL</h2>
<h4 id="1-errors-inefficiency-and-potential-bugs-exsit-in-the-following-code-please-point-them-out"><a class="markdownIt-Anchor" href="#1-errors-inefficiency-and-potential-bugs-exsit-in-the-following-code-please-point-them-out"></a> 1. Errors, inefficiency and potential bugs exsit in the following code, please point them out.</h4>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">foo</span><span class="params">(std::map&lt;<span class="type">int</span>, <span class="type">int</span>&gt;&amp; mapIn, std::set&lt;<span class="type">int</span>&gt;&amp; setIn)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="function">std::vector&lt;<span class="type">int</span>&gt; <span class="title">va</span><span class="params">(<span class="number">10</span>)</span></span>;</span><br><span class="line">  std::vector&lt;<span class="type">int</span>&gt; vb;</span><br><span class="line">  std::<span class="built_in">copy</span>(va.<span class="built_in">begin</span>(), va.<span class="built_in">end</span>(), vb.<span class="built_in">begin</span>());</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//std::vector&lt;int&gt; vb(va);</span></span><br><span class="line">  </span><br><span class="line">  <span class="function">std::vector&lt;<span class="type">int</span>&gt; <span class="title">vc</span><span class="params">(<span class="number">100</span>)</span></span>;</span><br><span class="line">  <span class="keyword">auto</span> iter = va.<span class="built_in">begin</span>() + <span class="number">5</span>;</span><br><span class="line">  <span class="type">int</span> varInt = *iter;</span><br><span class="line">  va.<span class="built_in">push_back</span>(vc.<span class="built_in">begin</span>(), vc.<span class="built_in">end</span>());</span><br><span class="line">  varInt = *(++iter);</span><br><span class="line">  <span class="keyword">if</span> (mapIn[<span class="number">4</span>] == <span class="number">0</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// do something </span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">auto</span> itVec = std::<span class="built_in">find</span>(vc.<span class="built_in">begin</span>(), vc.<span class="built_in">end</span>(), <span class="number">100</span>);</span><br><span class="line">  <span class="keyword">if</span> (itVec != vc.<span class="built_in">end</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//auto itSet = setIn.find(10);</span></span><br><span class="line">  <span class="comment">//Set本来就是有序的结构，利用可以进行二分查找，效率更高</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">auto</span> itSet = std::<span class="built_in">find</span>(setIn.<span class="built_in">begin</span>(), setIn.<span class="built_in">end</span>(), <span class="number">10</span>);</span><br><span class="line">  <span class="keyword">if</span> (itSet == setIn.<span class="built_in">end</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// do something</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-please-see-the-following-code-typea-could-be-either-a-function-pointer-or-a-functor-please-try-to-provide-the-definition-for-typea-in-both-function-pointer-way-and-functor-way"><a class="markdownIt-Anchor" href="#2-please-see-the-following-code-typea-could-be-either-a-function-pointer-or-a-functor-please-try-to-provide-the-definition-for-typea-in-both-function-pointer-way-and-functor-way"></a> 2. Please see the following code, <code>TypeA</code> could be either a function pointer or a functor, please try to provide the definition for <code>TypeA</code> in both function pointer way and functor way.</h4>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">(TypeA processor)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> paraInt = <span class="number">0</span>;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span>* pParaStr = <span class="string">&quot;Test&quot;</span>;</span><br><span class="line">  <span class="type">int</span> rtn = <span class="built_in">processor</span>(paraInt, pParaStr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>函数指针:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">function_pointer</span><span class="params">(<span class="type">int</span> pInt, <span class="type">const</span> <span class="type">char</span>* pStr)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">		<span class="comment">//do something</span></span><br><span class="line">  	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>函数对象：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">functor</span>&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">operator</span> <span class="params">()</span><span class="params">(<span class="type">int</span> pInt, <span class="type">const</span> <span class="type">char</span> * pStr)</span></span>&#123;</span><br><span class="line">				<span class="comment">// do something</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://phimos.github.io/2020/02/06/cpp-interview-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Pims">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Pims的博客">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/02/06/cpp-interview-1/" class="post-title-link" itemprop="url">C++ 面试题 1</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2020-02-06 06:12:27" itemprop="dateCreated datePublished" datetime="2020-02-06T06:12:27+08:00">2020-02-06</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>准备面试的时候找到了两套C++面试题，做了一下，解答直接写在上面了，放在这里分享出来。感觉难度并不是很高，这是第一套~</p>
<hr />
<h2 id="for-your-answers-either-chinese-or-english-are-ok"><a class="markdownIt-Anchor" href="#for-your-answers-either-chinese-or-english-are-ok"></a> For your answers, either Chinese or English are OK.</h2>
<h2 id="a-coding"><a class="markdownIt-Anchor" href="#a-coding"></a> A. Coding</h2>
<h4 id="1-please-create-a-class-to-represent-int-only-declaration-is-required-please-give-the-declaration-of-all-member-functions-friend-functions-and-member-variables"><a class="markdownIt-Anchor" href="#1-please-create-a-class-to-represent-int-only-declaration-is-required-please-give-the-declaration-of-all-member-functions-friend-functions-and-member-variables"></a> 1. Please create a class to represent Int. Only declaration is required. Please give the declaration of all member functions, friend functions, and member variables.</h4>
<p>略</p>
<h4 id="2-imagine-we-have-a-single-linked-list-please-write-a-function-which-could-move-a-specified-node-to-the-tail-of-the-list"><a class="markdownIt-Anchor" href="#2-imagine-we-have-a-single-linked-list-please-write-a-function-which-could-move-a-specified-node-to-the-tail-of-the-list"></a> 2. Imagine we have a single linked list, please write a function which could move a specified node to the tail of the list.</h4>
<ul>
<li>Please define the data structure for the list as you need.</li>
<li>Pass the head pointer to the function.</li>
<li>Pass the pointer of the node to be moved to the function. Move the node to the tail of the list if it has the same pointer value.</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ListNode</span>&#123;</span><br><span class="line">  <span class="type">int</span> val;</span><br><span class="line">  ListNode* next;</span><br><span class="line">  <span class="built_in">ListNode</span>(<span class="type">int</span> _val): <span class="built_in">val</span>(_val)&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">ListNode* <span class="title">deleteNode</span><span class="params">(ListNode* head, <span class="type">int</span> val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(!head)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">while</span>(head-&gt;val == val)</span><br><span class="line">  &#123;</span><br><span class="line">    head = head-&gt;next;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(!head)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">  ListNode* pnode = head-&gt;next;</span><br><span class="line">  ListNode* prev = head;</span><br><span class="line">  <span class="keyword">while</span>(pnode)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span>(pnode-&gt;val == val)</span><br><span class="line">    &#123;</span><br><span class="line">      prev-&gt;next = pnode-&gt;next;</span><br><span class="line">      pnode = pnode-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      prev = pnode;</span><br><span class="line">      pnode = pnode-&gt;next;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> head;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<hr />
<h2 id="b-read-and-answer"><a class="markdownIt-Anchor" href="#b-read-and-answer"></a> B. Read and Answer</h2>
<h4 id="1-what-are-wrong-in-the-following-code"><a class="markdownIt-Anchor" href="#1-what-are-wrong-in-the-following-code"></a> 1. What are wrong in the following code?</h4>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">(<span class="type">short</span> startIndex)</span></span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">  <span class="type">short</span> buffer[<span class="number">50000</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">auto</span> i = startIndex; i &lt; <span class="number">40000</span>; ++i) </span><br><span class="line">  &#123;  </span><br><span class="line">    buffer[i] = (<span class="type">char</span>)i;  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Because i is short, i &lt; 40000  is always True, the loop NEVER ends.</p>
<h4 id="2-mark-all-lines-which-are-wrong-and-provide-the-fix"><a class="markdownIt-Anchor" href="#2-mark-all-lines-which-are-wrong-and-provide-the-fix"></a> 2. Mark all lines which are wrong and provide the FIX.</h4>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CBase</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">CBase</span>() </span><br><span class="line">      : <span class="built_in">m_pVar1</span>(<span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        m_pVar2 = <span class="keyword">new</span> <span class="built_in">int</span>(<span class="number">4</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    ~<span class="built_in">CBase</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">delete</span> m_pVar2;</span><br><span class="line">        <span class="keyword">delete</span> m_pVar1;	<span class="comment">// Can&#x27;t delete NULL pointer</span></span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">      *if(! m_pVar1)</span></span><br><span class="line"><span class="comment">      *  delete m_pVal1;</span></span><br><span class="line"><span class="comment">      */</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Init</span><span class="params">(<span class="type">int</span>* pVar)</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        m_pVar1 = pVar;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span>* m_pVar1;</span><br><span class="line">    <span class="type">int</span>* m_pVar2;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CDerive</span> : <span class="keyword">public</span> CBase</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">CDerive</span>(<span class="type">int</span> var) : <span class="built_in">m_var</span>(var) &#123;&#125;;</span><br><span class="line">  <span class="comment">//CDerive()&#123;&#125;</span></span><br><span class="line">    ~<span class="built_in">CDerive</span>() &#123;&#125;;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> m_var;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    CDerive* pDerives = <span class="keyword">new</span> CDerive[<span class="number">10</span>]; <span class="comment">// can&#x27;t init</span></span><br><span class="line">    <span class="type">int</span> *pVar = <span class="keyword">new</span> <span class="built_in">int</span>(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        pDerive[i].<span class="built_in">Init</span>(pVar);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">delete</span> pDerives;	<span class="comment">// pDerives is an array</span></span><br><span class="line">  <span class="comment">//delete[] pDerives;</span></span><br><span class="line">    <span class="keyword">delete</span> pVar;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-the-following-code-could-not-be-compiled-give-two-ways-to-fix-it"><a class="markdownIt-Anchor" href="#3-the-following-code-could-not-be-compiled-give-two-ways-to-fix-it"></a> 3. The following code could not be compiled, give TWO ways to fix it.</h4>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CFoo</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">CFoo</span>() : <span class="built_in">m_var</span>(<span class="number">0</span>) &#123;&#125;;</span><br><span class="line">    ~<span class="built_in">CFoo</span>() &#123;&#125;;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">AddAndCheck</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        m_var += <span class="number">5</span>;</span><br><span class="line">        <span class="keyword">return</span> m_var &lt; <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> m_var;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>第一种：丢掉const</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CFoo</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">CFoo</span>() : <span class="built_in">m_var</span>(<span class="number">0</span>) &#123;&#125;;</span><br><span class="line">    ~<span class="built_in">CFoo</span>() &#123;&#125;;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">AddAndCheck</span><span class="params">()</span><span class="comment">// drop the const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        m_var += <span class="number">5</span>;</span><br><span class="line">        <span class="keyword">return</span> m_var &lt; <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> m_var;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>第二种：加上mutable</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CFoo</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">CFoo</span>() : <span class="built_in">m_var</span>(<span class="number">0</span>) &#123;&#125;;</span><br><span class="line">    ~<span class="built_in">CFoo</span>() &#123;&#125;;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">AddAndCheck</span><span class="params">()</span> <span class="type">const</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        m_var += <span class="number">5</span>;</span><br><span class="line">        <span class="keyword">return</span> m_var &lt; <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">mutable</span> <span class="type">int</span> m_var;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="4-what-are-wrong-in-the-following-code-provide-your-fix"><a class="markdownIt-Anchor" href="#4-what-are-wrong-in-the-following-code-provide-your-fix"></a> 4. What are wrong in the following code? Provide your fix.</h4>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> INCREASE(a) ++a </span></span><br><span class="line"><span class="comment">// #define INCREASE(a) a+1</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">3</span>;</span><br><span class="line">    <span class="type">int</span> b = <span class="number">7</span>;</span><br><span class="line">    cout&lt;&lt;<span class="built_in">INCREASE</span>(a * b)&lt;&lt;endl; <span class="comment">// 等价于(++a) * b</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-what-are-wrong-in-the-following-code-why"><a class="markdownIt-Anchor" href="#5-what-are-wrong-in-the-following-code-why"></a> 5. What are wrong in the following code? Why?</h4>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">char</span>* <span class="title">GetStaticBuffer</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="keyword">return</span> buffer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>buffer在栈上分配的，返回之后释放了。</p>
<h4 id="6-with-default-configuration-in-the-following-code-function-fooa-is-ok-but-foob-has-issues-why"><a class="markdownIt-Anchor" href="#6-with-default-configuration-in-the-following-code-function-fooa-is-ok-but-foob-has-issues-why"></a> 6. With default configuration, in the following code, function fooA is OK but fooB has issues, why?</h4>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">int</span> TEN_MEGA_BYTES = <span class="number">10</span> * <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fooA</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> *pBuffer = <span class="keyword">new</span> <span class="type">char</span>[TEN_MEGA_BYTES];</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fooB</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> buffer[TEN_MEGA_BYTES] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>fooA()</code>在堆上进行分配，<code>fooB()</code>在栈上进行分配，栈小，会爆。</p>
<h4 id="7-in-the-following-code-line-32-i-want-to-give-student_teacher-as-the-input-parameter-but-by-mistake-i-typed-student-the-compiling-succeeded-anyway-why-if-i-want-the-compiling-be-failed-in-this-condition-how-to-do"><a class="markdownIt-Anchor" href="#7-in-the-following-code-line-32-i-want-to-give-student_teacher-as-the-input-parameter-but-by-mistake-i-typed-student-the-compiling-succeeded-anyway-why-if-i-want-the-compiling-be-failed-in-this-condition-how-to-do"></a> 7. In the following code, line 32, I want to give “student_teacher” as the input parameter, but by mistake, I typed “student”. The compiling succeeded anyway. Why? If I want the compiling be failed in this condition, how to do?</h4>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CStudent</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">CStudent</span>() &#123;&#125;;</span><br><span class="line">    ~<span class="built_in">CStudent</span>() &#123;&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CTeacher</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">CTeacher</span>() &#123;&#125;;</span><br><span class="line">  <span class="comment">// delete this part------------</span></span><br><span class="line">    <span class="built_in">CTeacher</span>(CStudent student)</span><br><span class="line">        : <span class="built_in">m_student</span>(student)</span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    ~<span class="built_in">CTeacher</span>() &#123;&#125;;</span><br><span class="line">  <span class="comment">// end here -------------------</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Teach</span><span class="params">()</span> </span>&#123;&#125;;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    CStudent m_student;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">(CTeacher teacher)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    teacher.<span class="built_in">Teach</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    CStudent student;</span><br><span class="line">    CTeacher student_teacher;</span><br><span class="line">    <span class="built_in">foo</span>(student);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="8-what-is-the-output-of-the-following-code"><a class="markdownIt-Anchor" href="#8-what-is-the-output-of-the-following-code"></a> 8. What is the output of the following code?</h4>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> fooVar = <span class="number">10</span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">foo</span><span class="params">(<span class="type">int</span> *pVar, <span class="type">int</span>&amp; var)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    pVar = &amp;fooVar;</span><br><span class="line">    var = fooVar;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> var1 = <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> var2 = <span class="number">2</span>;</span><br><span class="line">    <span class="built_in">foo</span>(&amp;var1, var2);</span><br><span class="line">    cout&lt;&lt;var1&lt;&lt;<span class="string">&quot;:&quot;</span>&lt;&lt;var2&lt;&lt;endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>1:10</p>
<h4 id="9-how-to-run-some-code-before-main-function-is-called"><a class="markdownIt-Anchor" href="#9-how-to-run-some-code-before-main-function-is-called"></a> 9. How to run some code before main function is called?</h4>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">code_before_main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cout&lt;&lt;<span class="string">&quot;code before main()&quot;</span>&lt;&lt;endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> useless = <span class="built_in">code_before_main</span>();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cout&lt;&lt;<span class="string">&quot;main() start&quot;</span>&lt;&lt;endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="10-what-the-difference-are-between"><a class="markdownIt-Anchor" href="#10-what-the-difference-are-between"></a> 10. What the difference are between</h4>
<p>std::vector::resize() and std::vector::reserve()</p>
<p>std::vector::size() and std::vector::capacity()</p>
<p><code>size()</code>对应的是有效空间，而<code>capacity()</code>对应的是实际空间。</p>
<p><code>resize()</code>调整的是有效空间的大小，<code>reserve()</code>调整的是实际空间大小。</p>
<h4 id="11-template-greater-is-often-used-when-operating-the-stl-containers-please-give-an-implementation-of-greater"><a class="markdownIt-Anchor" href="#11-template-greater-is-often-used-when-operating-the-stl-containers-please-give-an-implementation-of-greater"></a> 11. Template greater&lt;&gt; is often used when operating the STL containers. Please give an implementation of greater&lt;&gt;.</h4>
<p>Hints: Two template parameters. One is a number to be compared as base, another is the element to be compared.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt; </span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">greater</span>&#123;</span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">operator</span><span class="params">()</span> <span class="params">(<span class="type">const</span> T&amp; x, <span class="type">const</span> T&amp; y)</span> <span class="type">const</span> </span></span><br><span class="line"><span class="function">  	</span>&#123;<span class="keyword">return</span> x&gt;y;&#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="12-say-we-have-a-class-named-printer-which-has-a-member-function-as-print-now-theres-a-container-as-vector-please-give-a-lambda-expression-which-could-be-used-in-for_each-to-call-print-function-for-every-instance-in-vector"><a class="markdownIt-Anchor" href="#12-say-we-have-a-class-named-printer-which-has-a-member-function-as-print-now-theres-a-container-as-vector-please-give-a-lambda-expression-which-could-be-used-in-for_each-to-call-print-function-for-every-instance-in-vector"></a> 12. Say we have a class named Printer which has a member function as Print(). Now there’s a container as vector. Please give a lambda expression which could be used in for_each() to call Print() function for every instance in vector.</h4>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">for_each(v.<span class="built_in">begin</span>(), v.<span class="built_in">end</span>(), [](<span class="type">const</span> T&amp; n) &#123; <span class="built_in">Printer</span>().<span class="built_in">Print</span>(n); &#125;);</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Pims</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">60</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">36</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Pims</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v7.3.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.6.0
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
